<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NŪR</title>
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg width='42' height='42' viewBox='0 0 42 42' fill='none' xmlns='http://www.w3.org/2000/svg'%3E%3Cpath d='M21.042 5C21.3764 9.449 20.7269 15.4274 24.5872 19.2877C28.4475 23.148 34.551 22.6236 39 22.958V23.042C34.5508 23.3758 28.5101 22.7894 24.6498 26.6497C20.7894 30.5101 21.3758 36.5508 21.042 42H20.958C20.6242 36.5508 21.0229 30.5727 17.1625 26.7123C13.3022 22.8519 7.44919 23.3758 3 23.042V22.958C7.449 22.6236 13.3649 23.0854 17.2252 19.2251C21.0854 15.3648 20.6236 9.449 20.958 5H21.042Z' fill='white'/%3E%3C/svg%3E">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --admin-color: #4EB4F9;
            --admin-glow: rgba(78, 180, 249, 0.4);
            --admin-bg: rgba(78, 180, 249, 0.08);
            --admin-border: rgba(78, 180, 249, 0.25);
            --bg: #171725;
            --bg-secondary: rgba(24, 26, 35, 0.95);
            --card: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
            --text: rgba(255, 255, 255, 0.9);
            --text-dim: rgba(255, 255, 255, 0.4);
            --green: #50DC78;
            --yellow: #EAB308;
            --red: #EE5566;
            --purple: #7A5AEE;
            --orange: #F97316;
            --pink: #EC4899;
            --teal: #14B8A6;
            --grid-color: rgba(255,255,255,0.03);
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }

        html, body {
            width: 100%;
            height: 100%;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background-color: var(--bg);
            color: var(--text);
            overflow: hidden;
        }

        * { scrollbar-width: thin; scrollbar-color: transparent transparent; }
        *:hover { scrollbar-color: rgba(255, 255, 255, 0.12) transparent; }
        *::-webkit-scrollbar { width: 5px; height: 5px; }
        *::-webkit-scrollbar-track { background: transparent; }
        *::-webkit-scrollbar-thumb { background: transparent; border-radius: 3px; }
        *:hover::-webkit-scrollbar-thumb { background: rgba(255, 255, 255, 0.12); }

        .workspace {
            position: fixed;
            inset: 0;
            overflow: auto;
            background-color: var(--bg);
            background-image: 
                linear-gradient(var(--grid-color) 1px, transparent 1px),
                linear-gradient(90deg, var(--grid-color) 1px, transparent 1px);
            background-size: 40px 40px;
            cursor: grab;
        }
        
        .workspace.panning { cursor: grabbing; }
        .workspace.panning * { pointer-events: none; }

        .workspace-content {
            position: relative;
            width: 6000px;
            height: 4000px;
            transform-origin: 0 0;
        }

        .mini-map {
            position: fixed;
            bottom: 80px;
            right: 20px;
            width: 180px;
            background: rgba(20, 22, 30, 0.9);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            z-index: 9999;
            opacity: 0;
            transition: opacity 0.3s ease;
            pointer-events: none;
            overflow: hidden;
            padding-bottom: 8px;
        }

        .mini-map.visible { opacity: 1; pointer-events: auto; }
        .mini-map-content { position: relative; width: 100%; height: 100px; background: rgba(255, 255, 255, 0.02); }
        .mini-map-viewport { position: absolute; border: 2px solid var(--admin-color); background: rgba(78, 180, 249, 0.15); border-radius: 2px; }
        
        /* Widget indicators in minimap */
        .mini-map-widget {
            position: absolute;
            border-radius: 2px;
            opacity: 0.8;
        }
        
        /* Zoom slider in minimap */
        .mini-map-zoom-slider {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px 2px;
        }
        .zoom-label {
            font-size: 9px;
            color: rgba(255,255,255,0.4);
            min-width: 24px;
        }
        .zoom-track {
            flex: 1;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            position: relative;
            cursor: pointer;
        }
        .zoom-track-fill {
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            background: linear-gradient(90deg, #8B5CF6, #6366F1);
            border-radius: 2px;
            width: 44%;
        }
        .zoom-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 12px;
            height: 12px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            left: 44%;
            cursor: grab;
        }
        .zoom-handle:active { cursor: grabbing; }

        .workspace-controls {
            position: fixed;
            bottom: 24px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            align-items: center;
            gap: 0;
            z-index: 99999;
            background: rgba(32, 34, 49, 0.4);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            border-radius: 14px;
            padding: 4px;
            opacity: 0.3;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .workspace-controls:hover {
            opacity: 1;
            background: rgba(32, 34, 49, 0.9);
            border-color: rgba(255, 255, 255, 0.1);
            gap: 4px;
        }
        
        .workspace-controls .expandable {
            display: flex;
            align-items: center;
            gap: 0;
            max-width: 0;
            overflow: hidden;
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .workspace-controls:hover .expandable {
            max-width: 200px;
            opacity: 1;
            gap: 4px;
        }

        .workspace-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 32px;
            height: 32px;
            background: transparent;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            color: rgba(255, 255, 255, 0.5);
            flex-shrink: 0;
        }

        .workspace-btn:hover {
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
        }

        .workspace-btn svg { width: 16px; height: 16px; }

        .zoom-display {
            padding: 6px 10px;
            font-size: 10px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.5);
            min-width: 40px;
            text-align: center;
            flex-shrink: 0;
        }

        .workspace-divider { width: 1px; height: 20px; background: rgba(255, 255, 255, 0.1); margin: 0 2px; flex-shrink: 0; }

        /* Admin Bar */
        .admin-bar {
            position: absolute;
            display: flex;
            align-items: center;
            gap: 14px;
            padding: 0 20px;
            background: var(--bg-secondary);
            backdrop-filter: blur(40px);
            border-radius: 14px;
            border: 1px solid var(--border);
            height: 48px;
            width: 1390px;
            cursor: grab;
            z-index: 900;
            transition: opacity 0.3s ease;
            user-select: none;
        }

        .admin-bar:active { cursor: grabbing; }
        .admin-bar.inactive { opacity: 0.6; }
        .admin-bar.inactive .admin-sphere-core { filter: grayscale(0.6) brightness(0.7); }

        .admin-sphere {
            position: relative;
            width: 28px;
            height: 28px;
            cursor: pointer;
            flex-shrink: 0;
        }
        
        /* Realtime connection indicator */
        .realtime-indicator {
            position: absolute;
            top: -2px;
            right: -2px;
            width: 8px;
            height: 8px;
            border-radius: 50%;
            background: #666;
            border: 2px solid var(--glass-bg);
            z-index: 10;
            transition: all 0.3s ease;
        }
        .realtime-indicator.connected {
            background: #22c55e;
            box-shadow: 0 0 6px #22c55e;
        }
        .realtime-indicator.connecting {
            background: #f59e0b;
            animation: pulse-indicator 1s ease-in-out infinite;
        }
        @keyframes pulse-indicator {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .admin-sphere-atmosphere {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 140%;
            height: 140%;
            border-radius: 50%;
            background: radial-gradient(circle, var(--admin-glow) 0%, transparent 70%);
            filter: blur(6px);
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .admin-bar.active .admin-sphere-atmosphere {
            opacity: 1;
            animation: sphereGlow 3s ease-in-out infinite;
        }

        @keyframes sphereGlow {
            0%, 100% { opacity: 0.6; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.1); }
        }

        .admin-sphere-ring {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 100%;
            height: 100%;
            border: 1.5px solid var(--admin-border);
            border-radius: 50%;
            opacity: 0;
        }

        .admin-bar.active .admin-sphere-ring { animation: ringPulse 3s ease-out infinite; }
        .admin-sphere-ring:nth-child(2) { animation-delay: 1s; }
        .admin-sphere-ring:nth-child(3) { animation-delay: 2s; }

        @keyframes ringPulse {
            0% { width: 100%; height: 100%; opacity: 0.5; }
            100% { width: 220%; height: 220%; opacity: 0; }
        }
        
        /* Syncing animation */
        .admin-sphere.syncing .admin-sphere-core {
            animation: sphereSpin 1s linear infinite;
        }
        @keyframes sphereSpin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .admin-sphere.syncing::after {
            content: '';
            position: absolute;
            inset: -4px;
            border: 2px solid transparent;
            border-top-color: var(--admin-color);
            border-radius: 50%;
            animation: syncRing 0.8s linear infinite;
        }
        @keyframes syncRing {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .admin-sphere-core {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: linear-gradient(180deg, #7dd3fc 0%, #4eb4f9 30%, #2892d7 60%, #2a8fd3 100%);
            box-shadow: 0 0 16px 4px rgba(78, 180, 249, 0.35), inset 0 -12px 20px rgba(20, 60, 100, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .sphere-voice-bars { display: flex; gap: 2px; align-items: center; opacity: 0; transition: opacity 0.3s ease; }
        .admin-bar.listening .sphere-voice-bars { opacity: 1; }
        .sphere-voice-bar { width: 2.5px; background: rgba(255,255,255,0.9); border-radius: 1px; }
        .sphere-voice-bar:nth-child(1) { height: 5px; animation: sphereBar 0.5s ease-in-out infinite 0s; }
        .sphere-voice-bar:nth-child(2) { height: 8px; animation: sphereBar 0.5s ease-in-out infinite 0.1s; }
        .sphere-voice-bar:nth-child(3) { height: 11px; animation: sphereBar 0.5s ease-in-out infinite 0.15s; }
        .sphere-voice-bar:nth-child(4) { height: 8px; animation: sphereBar 0.5s ease-in-out infinite 0.2s; }
        .sphere-voice-bar:nth-child(5) { height: 5px; animation: sphereBar 0.5s ease-in-out infinite 0.25s; }

        @keyframes sphereBar {
            0%, 100% { transform: scaleY(0.5); opacity: 0.5; }
            50% { transform: scaleY(1.3); opacity: 1; }
        }

        .admin-bar-content { display: flex; align-items: center; gap: 14px; flex: 1; }
        .admin-bar-title { font-size: 14px; font-weight: 600; color: var(--text); }
        .admin-bar-divider { width: 1px; height: 20px; background: rgba(255,255,255,0.1); }
        .admin-bar-subtitle { font-size: 11px; color: var(--text-dim); }

        .admin-value-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 5px 12px;
            background: var(--admin-bg);
            border: 1px solid var(--admin-border);
            border-radius: 20px;
            margin-left: auto;
        }

        .admin-value-badge svg { width: 12px; height: 12px; color: var(--admin-color); }
        .admin-value-badge span { font-size: 11px; font-weight: 600; color: var(--admin-color); }

        /* Admin Bar Fullscreen Button */
        .admin-bar-fullscreen-btn {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 28px;
            height: 28px;
            background: transparent;
            border: none;
            cursor: pointer;
            opacity: 0;
            width: 0;
            overflow: hidden;
            transition: all 0.25s ease;
            padding: 0;
        }
        .admin-bar-fullscreen-btn svg { 
            width: 16px; 
            height: 16px; 
            color: var(--text-dim); 
            transition: color 0.2s ease;
            flex-shrink: 0;
        }
        .admin-bar:hover .admin-bar-fullscreen-btn { 
            opacity: 1; 
            width: 28px;
            margin-left: 12px;
        }
        .admin-bar-fullscreen-btn:hover svg { color: var(--text); }

        /* Widgets */
        .widget {
            position: absolute;
            background: rgba(23, 23, 37, 0.55);
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 22px;
            overflow: hidden;
            display: none;
            flex-direction: column;
            box-shadow: 0 8px 40px rgba(0,0,0,0.4);
            z-index: 100;
            cursor: pointer;
        }

        .widget.visible { display: flex; }
        .widget.dragging { box-shadow: 0 20px 60px rgba(0,0,0,0.6); cursor: grabbing; }

        /* Browser Widget */
        .browser-widget {
            position: absolute;
            background: rgba(23, 23, 37, 0.95);
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            border-radius: 22px;
            overflow: hidden;
            display: none;
            flex-direction: column;
            box-shadow: 0 8px 40px rgba(0,0,0,0.4);
            z-index: 100;
        }
        .browser-widget.visible { display: flex; }
        .browser-widget.dragging { box-shadow: 0 20px 60px rgba(0,0,0,0.6); cursor: grabbing; }
        
        /* Browser header buttons (for widgets using .widget class) */
        .browser-header-btn {
            background: rgba(255,255,255,0.08);
            border: none;
            border-radius: 4px;
            padding: 5px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            color: var(--text-dim);
            transition: all 0.15s ease;
            opacity: 0;
        }
        .browser-header-btn svg { width: 14px; height: 14px; pointer-events: none; }
        .browser-header-btn:hover { background: rgba(255,255,255,0.15); color: var(--text); }
        .browser-close-btn:hover { background: rgba(239, 68, 68, 0.3); color: #EF4444; }
        .browser-nav-btn:disabled { opacity: 0; cursor: not-allowed; }
        .browser-nav-btn:disabled:hover { background: rgba(255,255,255,0.08); color: var(--text-dim); }
        
        /* Show buttons on hover */
        .browser-drag-header:hover .browser-header-btn { opacity: 1; }
        .browser-drag-header:hover .browser-nav-btn:disabled { opacity: 0.3; }
        
        /* Browser card mode (HTML version) */
        .browser-card-mode {
            width: 350px !important;
            height: auto !important;
        }
        .browser-card-mode .browser-header-btn { opacity: 1; }
        .browser-card-mode button:hover { filter: brightness(1.2); }
        
        /* Browser widget instance - using widget class with extra specifics */
        .browser-widget-instance .widget-body { height: 100%; }
        .browser-drag-header { position: relative; z-index: 10; }
        
        .browser-widget-header {
            display: flex;
            align-items: center;
            padding: 10px 14px;
            background: rgba(0,0,0,0.3);
            border-bottom: 1px solid rgba(255,255,255,0.06);
            cursor: grab;
            gap: 10px;
            min-height: 44px;
        }
        .browser-widget-header:active { cursor: grabbing; }
        
        .browser-widget-favicon {
            width: 16px;
            height: 16px;
            border-radius: 4px;
            flex-shrink: 0;
        }
        
        .browser-widget-url {
            flex: 1;
            font-size: 12px;
            color: var(--text-dim);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            font-family: 'SF Mono', monospace;
        }
        
        .browser-widget-actions {
            display: flex;
            gap: 6px;
        }
        
        .browser-widget-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.05);
            border: none;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .browser-widget-btn svg { width: 12px; height: 12px; color: var(--text-dim); }
        .browser-widget-btn:hover { background: rgba(255,255,255,0.1); }
        .browser-widget-btn:hover svg { color: var(--text); }
        .browser-widget-btn.close:hover { background: rgba(239, 68, 68, 0.3); }
        .browser-widget-btn.close:hover svg { color: #EF4444; }
        
        /* Fullscreen button - hidden by default, shown only when expanded */
        .browser-widget-btn.fullscreen-btn {
            display: none;
        }
        .browser-widget.expanded .browser-widget-btn.fullscreen-btn {
            display: flex;
        }
        
        .browser-widget-content {
            flex: 1;
            position: relative;
            overflow: hidden;
            background: #fff;
            border-radius: 0 0 22px 22px;
        }
        
        .browser-widget-iframe {
            width: 100%;
            height: 100%;
            border: none;
        }
        
        /* Expanded state - same as email widget */
        .browser-widget.expanded {
            width: 95vw !important;
            height: 95vh !important;
            max-width: 95vw !important;
            max-height: 95vh !important;
            border-radius: 24px !important;
        }
        .browser-widget.expanded .browser-widget-content {
            border-radius: 0 0 24px 24px;
        }
        
        /* Fullscreen state */
        .browser-widget.fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            border-radius: 0 !important;
            z-index: 10000 !important;
        }
        .browser-widget.fullscreen .browser-widget-content {
            border-radius: 0;
        }
        
        /* Loading state for iframe */
        .browser-widget-loading {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(23, 23, 37, 0.9);
            color: var(--text-dim);
            font-size: 13px;
        }
        .browser-widget-loading.hidden { display: none; }

        .widget.expanded {
            position: absolute;
            width: 1200px;
            max-width: calc(100vw - 60px);
            height: 850px;
            max-height: calc(100vh - 120px);
            border-radius: 24px;
        }
        
        /* Email widget expanded - 95% size with 2.5% margins on each side */
        /* Uses absolute positioning to allow drag, not fixed */
        #widgetEmail.expanded {
            width: 95vw !important;
            height: 95vh !important;
            max-width: 95vw !important;
            max-height: 95vh !important;
            border-radius: 24px !important;
            /* z-index managed dynamically by bringToFront() */
        }

        /* Fullscreen button - LEFT side with expand icon */
        .widget-fullscreen-btn {
            position: absolute;
            top: 10px;
            right: 14px;
            width: 24px;
            height: 24px;
            display: none;
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.3);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
        }

        .widget.expanded .widget-fullscreen-btn {
            display: flex;
        }

        .widget-fullscreen-btn:hover { 
            background: rgba(255,255,255,0.1);
            color: rgba(255,255,255,0.9); 
        }
        .widget-fullscreen-btn svg { width: 14px; height: 14px; }
        /* Hide old fullscreen button for email widget when expanded/fullscreen - email has its own */
        #widgetEmail.expanded .widget-fullscreen-btn,
        #widgetEmail.fullscreen .widget-fullscreen-btn { display: none; }

        /* Close button - RIGHT side */
        .widget-close-btn {
            position: absolute;
            top: 14px;
            right: 14px;
            width: 28px;
            height: 28px;
            display: none !important; /* HIDDEN - double-click on top bar to collapse */
            align-items: center;
            justify-content: center;
            background: rgba(0,0,0,0.4);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 50%;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            z-index: 10;
            transition: all 0.2s ease;
        }

        /* All close buttons hidden - use double-click on drag zone to collapse */
        .widget.expanded .widget-close-btn { display: none !important; }
        #widgetEmail.expanded .widget-close-btn { display: none !important; }
        #widgetEmail.fullscreen .widget-close-btn { display: none !important; }
        .widget-close-btn:hover { background: rgba(238, 85, 102, 0.5); color: white; }
        .widget-close-btn svg { width: 12px; height: 12px; }

        .widget-body { flex: 1; overflow-y: auto; padding: 10px 16px 16px 16px; position: relative; }
        .widget.expanded .widget-body { padding-top: 40px; }
        #widgetEmail .widget-body { padding-top: 0; }
        #widgetEmail.expanded .widget-body,
        #widgetEmail.fullscreen .widget-body { padding-top: 0; }

        .widget-drag-zone {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 25px;
            cursor: grab;
            z-index: 5;
        }

        .widget.expanded .widget-drag-zone { height: 45px; }
        /* Email widget: drag zone covers the full header height */
        #widgetEmail .widget-drag-zone { height: 45px; z-index: 4; }
        #widgetEmail.expanded .widget-drag-zone,
        #widgetEmail.fullscreen .widget-drag-zone { height: 45px; z-index: 4; }
        .widget-drag-zone:active { cursor: grabbing; }

        /* Fullscreen state */
        .widget.fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            border-radius: 0 !important;
            z-index: 1000000 !important;
        }
        
        /* Email widget fullscreen must override expanded state */
        #widgetEmail.fullscreen {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            max-width: 100vw !important;
            max-height: 100vh !important;
            border-radius: 0 !important;
            z-index: 1000000 !important;
        }

        /* Task Widget */
        .task-section-label {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.8px;
            color: rgba(80, 220, 120, 0.8);
            margin-bottom: 12px;
        }

        .task-section-label svg { width: 12px; height: 12px; }

        .task-card {
            position: relative;
            background: rgba(0,0,0,0.25);
            border-radius: 12px;
            padding: 12px 12px 12px 16px;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .task-card:hover { background: rgba(0,0,0,0.35); }
        .task-card::before { content: ''; position: absolute; left: 0; top: 15%; bottom: 15%; width: 3px; }
        .task-card.high::before { background: var(--green); }
        .task-card.medium::before { background: var(--yellow); }
        .task-card.low::before { background: var(--purple); }

        .task-card-header { display: flex; align-items: flex-start; justify-content: space-between; gap: 10px; margin-bottom: 8px; }
        .task-card-title { font-size: 13px; font-weight: 500; color: var(--text); line-height: 1.4; }
        .task-ris { padding: 2px 6px; border-radius: 4px; font-size: 10px; font-weight: 700; flex-shrink: 0; }
        .task-ris.high { background: rgba(80,220,120,0.15); color: var(--green); }
        .task-ris.medium { background: rgba(234,179,8,0.15); color: var(--yellow); }
        .task-ris.low { background: rgba(122,90,238,0.15); color: var(--purple); }

        .task-card-meta { display: flex; gap: 12px; font-size: 10px; color: var(--text-dim); }
        .task-meta-item { display: flex; align-items: center; gap: 4px; }
        .task-meta-item svg { width: 10px; height: 10px; }

        .task-list-section { margin-top: 16px; padding-top: 12px; border-top: 1px solid rgba(255,255,255,0.06); }
        .task-list-header { display: flex; justify-content: space-between; margin-bottom: 10px; }
        .task-list-title { font-size: 10px; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-dim); }
        .task-list-count { font-size: 10px; color: rgba(255,255,255,0.25); }

        .task-mini {
            position: relative;
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 10px 10px 14px;
            background: rgba(0,0,0,0.2);
            border-radius: 10px;
            margin-bottom: 6px;
            cursor: pointer;
        }

        .task-mini::before { content: ''; position: absolute; left: 0; top: 20%; bottom: 20%; width: 3px; background: rgba(255,255,255,0.15); }
        .task-mini:hover { background: rgba(0,0,0,0.3); }

        .task-checkbox {
            width: 16px;
            height: 16px;
            border: 1.5px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            flex-shrink: 0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .task-checkbox:hover { border-color: var(--admin-color); }
        .task-checkbox.checked { background: var(--green); border-color: var(--green); }
        .task-checkbox.checked::after { content: '✓'; font-size: 10px; color: white; }
        .task-mini-text { flex: 1; font-size: 12px; color: rgba(255,255,255,0.7); }
        .task-mini.completed .task-mini-text { text-decoration: line-through; color: rgba(255,255,255,0.3); }
        .task-mini-value { font-size: 10px; color: var(--admin-color); opacity: 0.7; }
        
        /* Task card with checkbox */
        .task-card .task-checkbox { 
            width: 18px; 
            height: 18px; 
            border: 2px solid rgba(255,255,255,0.2);
            border-radius: 4px;
            flex-shrink: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            font-size: 10px;
            color: var(--green);
        }
        .task-card.completed { opacity: 0.5; }
        .task-card.completed .task-title { text-decoration: line-through; }
        .task-card.overdue .task-due { color: var(--red); }
        .task-content { flex: 1; min-width: 0; }
        .task-title { font-size: 12px; color: var(--text); margin-bottom: 2px; }
        .task-due { font-size: 10px; color: var(--text-dim); }
        .task-due.overdue { color: var(--red); }
        .task-priority { width: 4px; height: 16px; border-radius: 2px; flex-shrink: 0; }
        .task-priority.high { background: var(--red); }
        .task-priority.medium { background: var(--yellow); }
        .task-priority.low { background: var(--text-dim); }
        
        /* Empty state */
        .empty-state {
            text-align: center;
            color: var(--text-dim);
            font-size: 12px;
            padding: 20px;
            opacity: 0.6;
        }

        /* Calendar Widget */
        .calendar-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding-bottom: 12px;
            margin-bottom: 12px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }

        .calendar-nav-btn {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.06);
            border: none;
            border-radius: 8px;
            color: var(--text-dim);
            cursor: pointer;
        }

        .calendar-nav-btn:hover { background: rgba(255,255,255,0.12); color: var(--text); }
        .calendar-nav-btn svg { width: 14px; height: 14px; }
        .calendar-date-label { font-size: 14px; font-weight: 600; color: var(--text); }
        .calendar-tabs { display: flex; gap: 4px; margin-left: auto; margin-right: 50px; }

        .calendar-tab {
            padding: 5px 12px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            color: var(--text-dim);
            cursor: pointer;
        }

        .calendar-tab:hover { color: var(--text); }
        .calendar-tab.active { background: var(--admin-bg); color: var(--admin-color); }

        .calendar-grid { display: grid; grid-template-columns: 45px 1fr; flex: 1; overflow-y: auto; }
        .calendar-times { border-right: 1px solid rgba(255,255,255,0.06); }
        .calendar-time-slot { height: 50px; display: flex; align-items: flex-start; justify-content: flex-end; padding: 4px 8px 0 0; font-size: 9px; color: var(--text-dim); }
        .calendar-events { position: relative; }
        .calendar-hour-line { height: 50px; border-bottom: 1px solid rgba(255,255,255,0.03); }

        .calendar-event {
            position: absolute;
            left: 6px;
            right: 6px;
            padding: 8px 10px 8px 14px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
        }
        
        /* List view calendar events */
        .calendar-events .calendar-event {
            position: relative;
            left: auto;
            right: auto;
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 6px;
            background: rgba(0,0,0,0.2);
        }
        .event-time { 
            font-size: 10px; 
            color: var(--admin-color); 
            min-width: 55px;
            flex-shrink: 0;
        }
        .event-title { 
            font-size: 11px; 
            color: var(--text); 
            flex: 1;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .calendar-event::before { content: ''; position: absolute; left: 0; top: 15%; bottom: 15%; width: 3px; }
        .calendar-event:hover { transform: translateX(2px); }
        .calendar-event.work { background: rgba(78, 180, 249, 0.15); color: var(--admin-color); }
        .calendar-event.work::before { background: var(--admin-color); }
        .calendar-event.revenue { background: rgba(80, 220, 120, 0.15); color: var(--green); }
        .calendar-event.revenue::before { background: var(--green); }
        .calendar-event.personal { background: rgba(122, 90, 238, 0.15); color: #a0a0cc; }
        .calendar-event.personal::before { background: var(--purple); }
        .calendar-event-value { font-size: 9px; opacity: 0.7; margin-top: 2px; }

        .calendar-summary {
            display: flex;
            gap: 16px;
            padding: 12px;
            background: rgba(0,0,0,0.2);
            border-radius: 12px;
            margin-top: 12px;
        }

        .summary-stat { display: flex; flex-direction: column; gap: 2px; }
        .summary-value { font-size: 14px; font-weight: 600; color: var(--text); }
        .summary-value.green { color: var(--green); }
        .summary-value.cyan { color: var(--admin-color); }
        .summary-label { font-size: 9px; color: var(--text-dim); text-transform: uppercase; letter-spacing: 0.5px; }

        /* Email Widget */
        .email-widget-container {
            display: flex;
            flex-direction: column;
            height: 100%;
            position: relative;
            overflow: hidden;
        }

        .email-header {
            display: flex;
            flex-direction: column;
            gap: 0;
            padding-bottom: 0;
            margin-bottom: 0;
            position: relative;
        }

        .email-tabs-row { 
            display: flex; 
            gap: 4px;
            padding: 8px 0 8px 0;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            align-items: center;
            position: relative;
            z-index: 10;
            pointer-events: none;
        }
        .email-tabs-row > * { pointer-events: auto; }

        /* Compose button - discreet like selected tab */
        .email-compose-btn {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--admin-bg);
            border: none;
            border-radius: 6px;
            color: var(--admin-color);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-right: 4px;
        }
        .email-compose-btn:hover { background: rgba(78, 180, 249, 0.2); }
        .email-compose-btn svg { width: 14px; height: 14px; }

        /* Email options dropdown (3-dot menu) */
        .email-options-dropdown {
            position: relative;
            margin-left: auto;
        }
        .email-options-btn {
            width: 26px;
            height: 26px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .email-options-btn:hover { background: rgba(255,255,255,0.08); color: var(--text); }
        .email-options-btn svg { width: 14px; height: 14px; }
        
        /* Expanded/Fullscreen email widget - horizontal menu next to Archive */
        #widgetEmail.expanded .email-options-dropdown,
        #widgetEmail.fullscreen .email-options-dropdown {
            margin-left: 4px;
        }
        #widgetEmail.expanded .email-options-btn svg,
        #widgetEmail.fullscreen .email-options-btn svg {
            transform: rotate(90deg);
        }
        #widgetEmail.expanded .email-tabs-row,
        #widgetEmail.fullscreen .email-tabs-row {
            padding-bottom: 6px;
        }
        
        /* Fullscreen button in expanded email widget - inline in tabs row */
        .email-fullscreen-btn {
            display: none;
            width: 26px;
            height: 26px;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 6px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s ease;
            margin-left: auto;
        }
        #widgetEmail.expanded .email-fullscreen-btn,
        #widgetEmail.fullscreen .email-fullscreen-btn { display: flex; }
        .email-fullscreen-btn:hover { background: rgba(255,255,255,0.08); color: var(--text); }
        .email-fullscreen-btn svg { width: 14px; height: 14px; }
        
        /* Reduce email header height when expanded */
        #widgetEmail.expanded .email-header,
        #widgetEmail.fullscreen .email-header { padding-bottom: 8px; }
        #widgetEmail.expanded .email-tabs-row,
        #widgetEmail.fullscreen .email-tabs-row { padding: 8px 0 8px 0; }
        
        .email-options-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: rgba(23, 23, 37, 0.98);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 4px;
            min-width: 140px;
            z-index: 1000;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .email-options-menu.active { display: block; }
        .email-options-menu button {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 8px 10px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.8);
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
        }
        .email-options-menu button:hover { background: rgba(78, 180, 249, 0.15); color: var(--admin-color); }
        .email-options-menu button svg { width: 14px; height: 14px; opacity: 0.7; }

        .email-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-dim);
            font-size: 12px;
            gap: 12px;
        }

        .email-loading-spinner {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255,255,255,0.1);
            border-top-color: var(--admin-color);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        .email-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px;
            color: var(--text-dim);
            font-size: 12px;
            text-align: center;
        }

        .email-empty svg {
            width: 32px;
            height: 32px;
            margin-bottom: 12px;
            opacity: 0.4;
        }

        .email-tab {
            padding: 6px 14px;
            background: transparent;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 500;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .email-tab:hover { color: var(--text); }
        .email-tab.active { background: var(--admin-bg); color: var(--admin-color); }
        .email-tab-count { font-size: 10px; padding: 2px 6px; background: rgba(255,255,255,0.1); border-radius: 8px; }
        .email-tab.active .email-tab-count { background: rgba(78, 180, 249, 0.2); }

        /* Email search bar */
        .email-search-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            background: transparent;
            border-radius: 0;
            margin: 0;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .email-search-row svg { width: 14px; height: 14px; color: var(--text-dim); flex-shrink: 0; }
        .email-search-row input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 12px;
            outline: none;
        }
        .email-search-row input::placeholder { color: rgba(255,255,255,0.3); }
        .search-clear {
            width: 18px;
            height: 18px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 50%;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
        }
        .search-clear:hover { background: rgba(255,255,255,0.2); }

        /* Filter toggle - below line, discreet like tabs */
        .email-filter-row {
            display: flex;
            gap: 4px;
            padding: 8px 0;
        }

        .filter-option {
            padding: 4px 10px;
            background: transparent;
            border: none;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 500;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.2s ease;
            user-select: none;
        }

        .filter-option:hover { color: var(--text); }
        .filter-option.active { background: rgba(80, 220, 120, 0.12); color: var(--green); }

        .email-list { flex: 1; overflow-y: auto; }

        /* Email Item - Matching screenshot exactly */
        .email-item {
            position: relative;
            display: flex;
            gap: 8px;
            padding: 12px 12px 12px 14px;
            background: transparent;
            border-radius: 0;
            margin-bottom: 0;
            cursor: pointer;
            transition: all 0.15s ease;
            align-items: center;
            border-bottom: 1px solid rgba(255,255,255,0.03);
        }

        /* Priority vertical bar on left - shorter, centered */
        .email-item::before { 
            content: ''; 
            position: absolute; 
            left: 0; 
            top: 25%; 
            bottom: 25%; 
            width: 2px;
            border-radius: 1px;
        }
        .email-item:hover { background: rgba(255,255,255,0.03); }
        .email-item.p1::before { background: #EE5566; }
        .email-item.p2::before { background: #F0A050; }
        .email-item.p3::before { background: transparent; }

        /* Checkbox - always takes space, hidden by default */
        .email-checkbox {
            width: 16px;
            height: 16px;
            border: 1.5px solid rgba(255,255,255,0.2);
            border-radius: 3px;
            flex-shrink: 0;
            visibility: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.15s ease;
        }
        .email-checkbox:hover { border-color: var(--admin-color); }
        .email-checkbox.checked { 
            background: var(--admin-color); 
            border-color: var(--admin-color); 
        }
        .email-checkbox svg { width: 10px; height: 10px; color: white; display: none; }
        .email-checkbox.checked svg { display: block; }
        .email-item:hover .email-checkbox { visibility: visible; }
        .email-item.selected .email-checkbox { visibility: visible; }

        /* Hover actions - right side, replaces time */
        .email-hover-actions {
            position: absolute;
            right: 12px;
            top: 50%;
            transform: translateY(-50%);
            display: flex;
            align-items: center;
            gap: 4px;
            flex-shrink: 0;
            visibility: hidden;
            background: transparent;
            padding: 2px 4px;
            border-radius: 4px;
        }
        .email-item:hover .email-hover-actions { visibility: visible; }
        .email-item.selected .email-hover-actions { visibility: visible; }
        /* Hide time when showing hover actions */
        .email-item:hover .email-time { visibility: hidden; }
        .email-item.selected .email-time { visibility: hidden; }
        
        .email-action-btn {
            width: 26px;
            height: 26px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s ease;
        }
        .email-action-btn:hover { background: rgba(255,255,255,0.08); color: var(--text); }
        .email-action-btn.archive:hover { color: var(--green); }
        .email-action-btn.delete:hover { color: var(--red); }
        .email-action-btn svg { width: 14px; height: 14px; }

        /* Unread email styling - no background, bold text */
        .email-item.unread .email-sender { font-weight: 600; color: var(--text); }
        .email-item.unread .email-subject { font-weight: 500; color: rgba(255,255,255,0.95); }
        
        /* Read email styling */
        .email-item.read .email-sender { font-weight: 400; color: var(--text-dim); }
        .email-item.read .email-subject { font-weight: 400; color: var(--text-dim); }
        
        /* Date group headers - more spacing */
        .email-date-group {
            padding: 14px 12px 8px;
            font-size: 10px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* Hide avatar completely */
        .email-avatar { display: none !important; }

        /* Selection bar at bottom */
        .email-selection-bar {
            position: absolute;
            bottom: 12px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(23, 23, 37, 0.95);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 10px;
            padding: 8px 14px;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 30;
            backdrop-filter: blur(20px);
        }
        .email-selection-bar.visible { display: flex; }
        .selection-btn {
            padding: 6px 14px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.08);
            font-size: 11px;
            font-weight: 500;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.15s ease;
            background: transparent;
            color: var(--text-dim);
        }
        .selection-btn:hover {
            background: rgba(255,255,255,0.05);
            color: var(--text);
            border-color: rgba(255,255,255,0.12);
        }
        .selection-btn.primary {
            background: rgba(80, 220, 120, 0.12);
            border-color: rgba(80, 220, 120, 0.25);
            color: var(--green);
        }
        .selection-btn.primary:hover {
            background: rgba(80, 220, 120, 0.2);
        }
        .selection-btn.secondary {
            background: transparent;
            color: var(--text-dim);
        }
        .selection-btn svg { width: 12px; height: 12px; }
        .selection-close {
            width: 24px;
            height: 24px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .selection-close:hover { background: rgba(255,255,255,0.08); color: var(--text); }

        /* Hide avatar in small widget - show only in expanded/fullscreen */
        .email-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--admin-color), var(--purple));
            display: none;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: 600;
            color: white;
            flex-shrink: 0;
        }
        #widgetEmail.expanded .email-avatar,
        #widgetEmail.fullscreen .email-avatar { display: flex; }

        /* Account indicator dot (for multi-inbox) */
        /* Account indicator dot - hidden by default, enable for multi-inbox */
        .email-account-dot {
            display: none;
        }

        .email-content { flex: 1; min-width: 0; display: flex; align-items: center; gap: 8px; }
        .email-sender { font-size: 14px; font-weight: 500; color: var(--text); white-space: nowrap; width: 140px; min-width: 140px; max-width: 140px; overflow: hidden; text-overflow: ellipsis; }
        .email-tags-group { display: flex; gap: 4px; flex-shrink: 0; }
        .email-subject { font-size: 14px; color: rgba(255,255,255,0.85); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex-shrink: 1; min-width: 80px; max-width: 240px; }
        .email-preview { font-size: 13px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; flex: 1; min-width: 0; }
        .email-time { font-size: 12px; color: var(--text-dim); white-space: nowrap; flex-shrink: 0; margin-left: auto; padding-left: 8px; }
        
        /* Category tags - rectangle with rounded corners, soft colors */
        .email-tag { 
            padding: 3px 8px; 
            border-radius: 4px; 
            font-size: 10px; 
            font-weight: 500; 
            text-transform: lowercase; 
            letter-spacing: 0.2px; 
            flex-shrink: 0;
            background: rgba(255,255,255,0.06);
            color: var(--text-dim);
        }
        /* Soft category colors - 12% opacity backgrounds */
        .email-tag.work { background: rgba(100, 180, 220, 0.12); color: #7CB8DC; }
        .email-tag.job { background: rgba(160, 130, 220, 0.12); color: #A082DC; }
        .email-tag.meeting { background: rgba(80, 200, 120, 0.12); color: #50C878; }
        .email-tag.newsletter { background: rgba(100, 160, 180, 0.12); color: #78B4C8; }
        .email-tag.social { background: rgba(220, 120, 180, 0.12); color: #DC78B4; }
        .email-tag.fyi { background: rgba(140, 140, 140, 0.12); color: #9CA3AF; }
        .email-tag.urgent { background: rgba(238, 100, 100, 0.15); color: #EE6464; }
        .email-tag.promo, .email-tag.promotion { background: rgba(80, 180, 120, 0.12); color: #50B478; }
        .email-tag.todo { background: rgba(240, 160, 80, 0.12); color: #F0A050; }
        .email-tag.personal { background: rgba(180, 120, 200, 0.12); color: #B478C8; }
        .email-tag.update { background: rgba(100, 180, 220, 0.12); color: #64B4DC; }
        .email-tag.internal { background: rgba(255,255,255,0.06); color: var(--text-dim); }
        .email-tag.marketing { background: rgba(78, 180, 249, 0.12); color: #4EB4F9; }
        .email-tag.pitch { background: rgba(200, 130, 200, 0.12); color: #C882C8; }
        .email-tag.followup { background: rgba(249, 115, 22, 0.12); color: #F97316; }
        .email-tag.request { background: rgba(168, 85, 247, 0.12); color: #A855F7; }
        .email-tag.investor { background: rgba(234,179,8,0.12); color: #D4A020; }
        .email-tag.deals { background: rgba(80,220,120,0.12); color: #50DC78; }
        .email-tag.leads { background: rgba(78,180,249,0.12); color: var(--admin-color); }
        .email-tag.legal { background: rgba(122,90,238,0.12); color: #8A6AE0; }
        .email-tag.clients { background: rgba(80,220,120,0.12); color: #50DC78; }
        .email-tag.draft-tag { background: rgba(250, 200, 60, 0.2); color: #FAC83C; font-weight: 600; }

        /* Time cost - gray text like screenshot */
        .email-time-cost { 
            font-size: 10px; 
            color: var(--text-dim);
        }
        .email-time-cost strong { 
            color: var(--text-dim);
            font-weight: 600;
        }

        .email-summary {
            display: flex;
            gap: 12px;
            padding: 12px 16px;
            background: transparent;
            border-radius: 0;
            margin-top: 8px;
            flex-shrink: 0;
            justify-content: space-between;
            align-items: center;
            border-top: 1px solid rgba(255,255,255,0.03);
        }
        .email-summary .summary-left {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .email-summary .summary-separator {
            width: 1px;
            height: 12px;
            background: rgba(255,255,255,0.15);
        }
        .email-summary .summary-stat {
            display: flex;
            flex-direction: row;
            gap: 4px;
            align-items: baseline;
        }
        .email-summary .summary-label {
            font-size: 10px;
            color: var(--text-dim);
        }
        .email-summary .summary-value {
            font-size: 11px;
        }

        /* Email Drawer - Hidden when closed */
        .email-drawer {
            position: absolute;
            top: 5px;
            right: 5px;
            bottom: 5px;
            width: calc(50% - 8px);
            background: rgba(23, 23, 37, 0.85);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 18px;
            z-index: 20;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            visibility: hidden;
            opacity: 0;
            transform: translateX(20px);
            transition: all 0.3s ease;
        }

        .email-drawer.open { 
            visibility: visible;
            opacity: 1;
            transform: translateX(0);
        }
        
        .email-drawer.full-width { 
            width: calc(100% - 10px); 
            left: 5px; 
        }

        .email-drawer-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 12px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            flex-shrink: 0;
        }

        .drawer-close-btn {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.06);
            border: none;
            border-radius: 6px;
            color: var(--text-dim);
            cursor: pointer;
        }

        .drawer-close-btn:hover { background: rgba(238,85,102,0.3); color: var(--red); }
        .drawer-close-btn svg { width: 12px; height: 12px; }

        .drawer-actions { display: flex; gap: 4px; }

        .drawer-action-btn {
            padding: 5px 10px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 6px;
            font-size: 10px;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .drawer-action-btn:hover { background: rgba(255,255,255,0.08); color: var(--text); border-color: rgba(255,255,255,0.15); }
        .drawer-action-btn svg { width: 11px; height: 11px; }
        .drawer-action-btn.primary {
            background: rgba(78, 180, 249, 0.15);
            border-color: rgba(78, 180, 249, 0.3);
            color: var(--admin-color);
        }
        .drawer-action-btn.primary:hover {
            background: rgba(78, 180, 249, 0.25);
            border-color: rgba(78, 180, 249, 0.5);
        }

        /* More dropdown menu */
        .more-dropdown { position: relative; display: inline-block; }
        .more-menu {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 4px;
            background: rgba(23, 23, 37, 0.98);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 4px;
            min-width: 140px;
            z-index: 1000;
            backdrop-filter: blur(20px);
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
        }
        .more-menu.active { display: block; }
        .more-menu button {
            display: flex;
            align-items: center;
            gap: 8px;
            width: 100%;
            padding: 8px 10px;
            border: none;
            background: transparent;
            color: rgba(255,255,255,0.8);
            font-size: 11px;
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.15s ease;
        }
        .more-menu button:hover { background: rgba(78, 180, 249, 0.15); color: var(--admin-color); }
        .more-menu button svg { width: 14px; height: 14px; opacity: 0.7; }

        .email-drawer-content { flex: 1; overflow-y: auto; padding: 12px; }

        .drawer-email-header { margin-bottom: 12px; }
        .drawer-subject { font-size: 14px; font-weight: 600; color: var(--text); margin-bottom: 10px; line-height: 1.4; }
        .drawer-sender-row { display: flex; align-items: center; gap: 10px; }

        .drawer-avatar {
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--admin-color), var(--purple));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 11px;
            font-weight: 600;
            color: white;
        }

        .drawer-sender-info { flex: 1; }
        .drawer-sender-name { font-size: 12px; font-weight: 500; color: var(--text); }
        .drawer-sender-email { font-size: 10px; color: var(--text-dim); }
        .drawer-date { font-size: 10px; color: var(--text-dim); }
        .drawer-tags { display: flex; gap: 6px; margin-top: 8px; flex-wrap: wrap; }
        .email-tag.clickable { cursor: pointer; transition: all 0.15s ease; }
        .email-tag.clickable:hover { filter: brightness(1.2); transform: scale(1.05); }
        
        /* Tag Picker Dropdown */
        .tag-picker {
            position: fixed;
            background: rgba(30, 32, 44, 0.98);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 8px 0;
            min-width: 140px;
            z-index: 9999;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            backdrop-filter: blur(10px);
            display: none;
        }
        .tag-picker.active { display: block; }
        .tag-picker-title {
            font-size: 10px;
            color: var(--text-dim);
            padding: 4px 12px 8px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .tag-picker-option {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            cursor: pointer;
            font-size: 12px;
            color: var(--text);
            transition: background 0.15s ease;
        }
        .tag-picker-option:hover { background: rgba(255,255,255,0.08); }
        .tag-picker-option.selected { background: rgba(78, 180, 249, 0.15); }
        .tag-picker-option .tag-dot {
            width: 8px;
            height: 8px;
            border-radius: 50%;
        }

        /* Email body - Direct on background, NO gray box */
        .drawer-email-body {
            width: 100%;
            min-height: 300px;
            border: none;
            border-radius: 8px;
            background: #1e202c;
            margin-bottom: 12px;
        }

        /* Fallback for plain text display */
        .drawer-email-body-text {
            font-size: 12px;
            line-height: 1.7;
            color: rgba(255,255,255,0.8);
            padding: 12px;
            margin-bottom: 12px;
            white-space: pre-wrap;
            background: rgba(255,255,255,0.02);
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Email Attachments Section */
        .email-attachments-section {
            padding: 12px 16px;
            border-top: 1px solid rgba(255,255,255,0.06);
        }
        .attachments-header {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-dim);
            margin-bottom: 12px;
        }
        .attachments-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }
        .attachment-card {
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 12px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 100px;
            max-width: 140px;
        }
        .attachment-card:hover {
            background: rgba(255,255,255,0.08);
            border-color: rgba(78, 180, 249, 0.3);
            transform: translateY(-2px);
        }
        .attachment-card.no-preview {
            opacity: 0.85;
        }
        .attachment-icon {
            width: 48px;
            height: 48px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .attachment-icon.pdf { background: rgba(239, 68, 68, 0.15); color: #EF4444; }
        .attachment-icon.image { background: rgba(139, 92, 246, 0.15); color: #8B5CF6; }
        .attachment-icon.doc { background: rgba(59, 130, 246, 0.15); color: #3B82F6; }
        .attachment-icon.xls { background: rgba(34, 197, 94, 0.15); color: #22C55E; }
        .attachment-icon.zip { background: rgba(234, 179, 8, 0.15); color: #EAB308; }
        .attachment-icon.other { background: rgba(156, 163, 175, 0.15); color: #9CA3AF; }
        .attachment-icon img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 6px;
        }
        .attachment-name {
            font-size: 11px;
            color: var(--text);
            text-align: center;
            word-break: break-word;
            max-width: 120px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        .attachment-size {
            font-size: 10px;
            color: var(--text-dim);
            margin-top: 4px;
        }
        
        /* Attachment Preview Modal */
        .attachment-preview-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.9);
            z-index: 99999;
            display: none;
            align-items: center;
            justify-content: center;
            flex-direction: column;
        }
        .attachment-preview-modal.active { display: flex; }
        .attachment-preview-header {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            padding: 16px 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: linear-gradient(to bottom, rgba(0,0,0,0.8), transparent);
        }
        .attachment-preview-title {
            color: white;
            font-size: 14px;
            font-weight: 500;
        }
        .attachment-preview-actions {
            display: flex;
            gap: 12px;
        }
        .attachment-preview-btn {
            background: rgba(255,255,255,0.1);
            border: none;
            color: white;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }
        .attachment-preview-btn:hover { background: rgba(255,255,255,0.2); }
        .attachment-preview-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 8px;
        }
        .attachment-preview-content {
            max-width: 90vw;
            max-height: 80vh;
            overflow: auto;
        }
        .attachment-preview-content img {
            max-width: 100%;
            max-height: 80vh;
            object-fit: contain;
        }
        .attachment-preview-content iframe {
            width: 80vw;
            height: 80vh;
            border: none;
            background: white;
            border-radius: 8px;
        }

        /* AI Reply Section - subtle card */
        .ai-reply-section {
            background: transparent;
            border: none;
            border-top: 1px solid rgba(255,255,255,0.05);
            border-radius: 0;
            padding: 12px 0;
        }

        .ai-reply-header {
            display: flex;
            align-items: center;
            gap: 6px;
            margin-bottom: 10px;
        }

        .ai-badge {
            font-size: 9px;
            font-weight: 600;
            color: var(--admin-color);
            display: flex;
            align-items: center;
            gap: 3px;
        }

        .ai-badge svg { width: 10px; height: 10px; }
        .ai-label { font-size: 10px; color: var(--text-dim); }

        /* AI Tools Bar - Jace-style with separators */
        .ai-tools-bar {
            display: flex;
            align-items: center;
            gap: 0;
            padding: 10px 0;
            margin-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.05);
        }
        .ai-tools-separator {
            width: 1px;
            height: 18px;
            background: rgba(255,255,255,0.12);
            margin: 0 10px;
        }
        .ai-tools-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-dim);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            padding: 0;
            background: transparent;
            margin-right: 4px;
        }
        .ai-tool-btn {
            width: 28px;
            height: 28px;
            border-radius: 4px;
            border: none;
            background: transparent;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.15s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            font-family: inherit;
        }
        .ai-tool-btn:hover {
            background: rgba(255,255,255,0.06);
            color: var(--text);
        }
        .ai-tool-btn:active {
            background: rgba(78, 180, 249, 0.1);
        }
        .ai-tool-btn svg {
            width: 16px;
            height: 16px;
        }
        .ai-tools-spacer {
            flex: 1;
        }
        .ai-keyboard-hint {
            font-size: 10px;
            color: var(--text-dim);
            display: flex;
            align-items: center;
            gap: 4px;
        }
        .ai-keyboard-hint kbd {
            background: rgba(255,255,255,0.08);
            padding: 2px 6px;
            border-radius: 3px;
            font-family: inherit;
            font-size: 10px;
        }
        
        /* Gradient Send button - Jace style */
        .btn-send-gradient {
            background: linear-gradient(135deg, #C4A0F0 0%, #F0A0C0 50%, #F0C080 100%);
            border: none;
            border-radius: 6px 0 0 6px;
            padding: 8px 14px;
            font-size: 12px;
            font-weight: 600;
            color: #1a1a1a;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: all 0.2s ease;
        }
        .btn-send-gradient:hover {
            opacity: 0.9;
        }
        .btn-send-gradient svg {
            width: 14px;
            height: 14px;
        }
        .send-btn-wrapper {
            display: flex;
            margin-left: 10px;
            position: relative;
        }
        .btn-send-dropdown {
            background: linear-gradient(135deg, #B090E0 0%, #E090B0 50%, #E0B070 100%);
            border: none;
            border-left: 1px solid rgba(0,0,0,0.1);
            border-radius: 0 6px 6px 0;
            padding: 8px 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
        }
        .btn-send-dropdown:hover {
            opacity: 0.9;
        }
        .btn-send-dropdown svg {
            width: 12px;
            height: 12px;
            color: #1a1a1a;
        }
        
        /* Send Later Dropdown */
        .send-later-dropdown {
            display: none;
            position: absolute;
            top: 100%;
            right: 0;
            margin-top: 8px;
            background: rgba(23, 23, 37, 0.98);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            padding: 12px;
            min-width: 300px;
            max-height: 420px;
            overflow-y: auto;
            z-index: 1000;
            backdrop-filter: blur(20px);
        }
        .send-later-dropdown.active { display: block; }
        .send-later-header {
            display: flex;
            align-items: center;
            gap: 8px;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            margin-bottom: 10px;
        }
        .send-later-header svg { width: 16px; height: 16px; color: var(--text-dim); }
        .send-later-input {
            flex: 1;
            background: transparent;
            border: none;
            font-size: 12px;
            color: var(--text);
            outline: none;
        }
        .send-later-input::placeholder { color: var(--text-dim); }
        .send-later-picker {
            padding: 8px 0;
            font-size: 12px;
            color: var(--text-dim);
            cursor: pointer;
        }
        .send-later-picker:hover { color: var(--text); }
        .send-later-calendar {
            margin-top: 10px;
        }
        .calendar-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 12px;
        }
        .calendar-nav {
            width: 28px;
            height: 28px;
            border-radius: 6px;
            border: 1px solid rgba(255,255,255,0.1);
            background: transparent;
            color: var(--text);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .calendar-nav:hover { background: rgba(255,255,255,0.05); }
        .calendar-month-year {
            display: flex;
            gap: 8px;
            font-size: 13px;
            font-weight: 500;
        }
        .calendar-month-year select {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 13px;
            cursor: pointer;
        }
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
            text-align: center;
        }
        .calendar-day-header {
            font-size: 10px;
            color: var(--text-dim);
            padding: 6px 0;
        }
        .calendar-day {
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: var(--text-dim);
            border-radius: 6px;
            cursor: pointer;
        }
        .calendar-day:hover { background: rgba(255,255,255,0.05); color: var(--text); }
        .calendar-day.today { border: 1px solid rgba(255,255,255,0.2); color: var(--text); }
        .calendar-day.selected { background: white; color: #1a1a1a; }
        .calendar-day.other-month { opacity: 0.4; }
        .calendar-time {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            margin-top: 16px;
            padding-top: 12px;
            border-top: 1px solid rgba(255,255,255,0.06);
        }
        .calendar-time svg { width: 18px; height: 18px; color: var(--text-dim); }
        .time-input {
            width: 50px;
            padding: 6px 10px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 6px;
            color: var(--text);
            font-size: 13px;
            text-align: center;
        }
        .calendar-actions {
            display: flex;
            justify-content: flex-end;
            margin-top: 12px;
        }
        .btn-calendar-select {
            padding: 8px 20px;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: var(--text);
            font-size: 12px;
            cursor: pointer;
        }
        .btn-calendar-select:hover { background: rgba(255,255,255,0.15); }

        /* Reply thread collapsible */
        .reply-thread-toggle {
            display: none !important; /* Hidden - user doesn't want to see original email */
        }
        .reply-thread-toggle:hover {
            background: rgba(255,255,255,0.12);
        }
        .reply-thread-card {
            background: rgba(255,255,255,0.03);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 8px;
            padding: 12px;
            margin-bottom: 12px;
            display: none;
        }
        .reply-thread-card.visible {
            display: block;
        }
        .reply-thread-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 8px;
        }
        .reply-thread-title {
            font-size: 12px;
            font-weight: 500;
            color: var(--text);
        }
        .reply-thread-actions {
            display: flex;
            gap: 8px;
        }
        .reply-thread-actions button {
            background: transparent;
            border: none;
            color: var(--text-dim);
            cursor: pointer;
            padding: 4px;
        }
        .reply-thread-actions button:hover {
            color: var(--text);
        }
        .reply-thread-meta {
            font-size: 10px;
            color: var(--text-dim);
            margin-bottom: 8px;
        }
        .reply-thread-content {
            font-size: 11px;
            color: var(--text-dim);
            line-height: 1.5;
            padding-left: 10px;
            border-left: 2px solid rgba(255,255,255,0.1);
        }

        /* AI Reply textarea - NO resize, just scroll */
        .ai-reply-textarea {
            width: 100%;
            min-height: 100px;
            max-height: 150px;
            background: transparent;
            border: none;
            padding: 0;
            font-family: inherit;
            font-size: 12px;
            line-height: 1.6;
            color: var(--text);
            resize: none;
            outline: none;
            overflow-y: auto;
        }

        /* Reply/Forward fields */
        .reply-fields {
            display: flex;
            flex-direction: column;
            gap: 6px;
            margin-bottom: 10px;
        }
        .reply-field-inline {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }
        .reply-label {
            color: rgba(255,255,255,0.5);
            width: 50px;
            flex-shrink: 0;
        }
        .reply-value {
            color: var(--admin-color);
            cursor: pointer;
            padding: 4px 0;
        }
        .reply-value:hover { text-decoration: underline; }
        .reply-input-hidden {
            display: none;
            background: transparent;
            border: none;
            color: var(--admin-color);
            font-size: 12px;
            padding: 4px 0;
            outline: none;
            flex: 1;
        }
        .reply-input-hidden.active { display: block; }
        .reply-input-inline {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 12px;
            padding: 4px 0;
            outline: none;
            flex: 1;
        }
        .reply-input-inline:focus { color: var(--admin-color); }
        .reply-input-inline::placeholder { color: rgba(255,255,255,0.3); }
        .reply-add-links {
            margin-left: auto;
            display: flex;
            gap: 10px;
        }
        .reply-add-links {
            margin-left: auto;
            display: flex;
            gap: 12px;
        }
        .add-cc-link {
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            font-size: 12px;
            transition: color 0.15s ease;
        }
        .add-cc-link:hover { 
            color: var(--admin-color);
        }
        .reply-field-close {
            background: none;
            border: none;
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            font-size: 18px;
            line-height: 1;
            padding: 0 4px;
            margin-left: 8px;
        }
        .reply-field-close:hover { color: var(--red); }

        .ai-reply-footer {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
            padding-top: 10px;
            border-top: 1px solid rgba(255,255,255,0.06);
        }

        .ai-footer-left {
            display: flex;
            gap: 16px;
        }
        .ai-footer-btn {
            background: transparent;
            border: none;
            font-size: 11px;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 0;
            font-family: inherit;
        }
        .ai-footer-btn:hover { color: var(--text); }
        .ai-footer-btn svg { width: 14px; height: 14px; }
        
        .ai-time-saved { font-size: 9px; color: var(--text-dim); }
        .ai-time-saved strong { color: var(--green); }
        .ai-reply-btns { display: flex; gap: 8px; align-items: center; }

        /* Refined buttons */
        .btn-regen {
            padding: 6px 12px;
            background: transparent;
            border: none;
            font-size: 10px;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 4px;
        }

        .btn-regen:hover { color: var(--text); }
        .btn-regen svg { width: 12px; height: 12px; }

        .btn-send {
            padding: 7px 18px;
            background: linear-gradient(135deg, #50DC78 0%, #3cb868 100%);
            border: none;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            box-shadow: 0 2px 8px rgba(80, 220, 120, 0.3);
            transition: all 0.2s ease;
        }

        .btn-send:hover { 
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(80, 220, 120, 0.4);
        }
        .btn-send svg { width: 12px; height: 12px; }

        /* Schedule/Remind button wrapper */
        .schedule-btn-wrapper { position: relative; }

        /* Schedule/Remind button */
        .btn-schedule {
            padding: 7px 10px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            color: var(--text-dim);
            cursor: pointer;
            display: flex;
            align-items: center;
            transition: all 0.2s ease;
        }
        .btn-schedule:hover { background: rgba(255,255,255,0.12); color: var(--admin-color); }
        .btn-schedule svg { width: 14px; height: 14px; }

        /* Schedule dropdown */
        .schedule-dropdown {
            display: none;
            position: fixed;
            background: rgba(23, 23, 37, 0.98);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 12px;
            padding: 8px 0;
            min-width: 220px;
            z-index: 99999;
            backdrop-filter: blur(20px);
            box-shadow: 0 12px 40px rgba(0,0,0,0.5);
        }
        .schedule-dropdown.active { display: block; }
        .schedule-section { padding: 4px 0; }
        .schedule-title {
            padding: 6px 14px;
            font-size: 10px;
            font-weight: 600;
            color: rgba(255,255,255,0.4);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        .schedule-option {
            padding: 10px 14px;
            font-size: 12px;
            color: rgba(255,255,255,0.85);
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.15s ease;
        }
        .schedule-option:hover { background: rgba(78, 180, 249, 0.15); color: var(--admin-color); }
        .schedule-option span { font-size: 10px; color: var(--text-dim); }
        .schedule-divider { height: 1px; background: rgba(255,255,255,0.08); margin: 4px 0; }
        .remind-custom { flex-direction: column; align-items: flex-start; gap: 4px; }
        .remind-condition { color: var(--admin-color); font-size: 10px; }

        /* Remind Me Modal */
        .remind-modal {
            display: none;
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(4px);
        }
        .remind-modal.active { display: flex; }
        .remind-modal-content {
            background: #1e202c;
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            width: 400px;
            max-width: 90vw;
            overflow: hidden;
        }
        .remind-modal-header {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .remind-modal-header svg { width: 20px; height: 20px; color: var(--text-dim); }
        .remind-modal-header span { font-size: 14px; font-weight: 500; color: var(--text); }
        .remind-modal-body { padding: 16px 20px; }
        .remind-input-row {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: rgba(0,0,0,0.3);
            border-radius: 10px;
            margin-bottom: 12px;
        }
        .remind-input {
            flex: 1;
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 16px;
            outline: none;
        }
        .remind-input::placeholder { color: rgba(255,255,255,0.3); }
        .remind-condition-select {
            padding: 6px 10px;
            background: rgba(78, 180, 249, 0.1);
            border: 1px solid rgba(78, 180, 249, 0.3);
            border-radius: 6px;
            color: var(--admin-color);
            font-size: 11px;
            cursor: pointer;
        }
        .remind-suggestions {
            display: flex;
            flex-direction: column;
            gap: 2px;
        }
        .remind-suggestion {
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: all 0.15s ease;
        }
        .remind-suggestion:hover { background: rgba(255,255,255,0.06); }
        .remind-suggestion.selected { background: rgba(78, 180, 249, 0.15); }
        .remind-suggestion-label { font-size: 13px; color: var(--text); }
        .remind-suggestion-time { font-size: 11px; color: var(--text-dim); }
        .remind-modal-footer {
            padding: 12px 20px;
            border-top: 1px solid rgba(255,255,255,0.06);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
        .remind-cancel {
            padding: 8px 16px;
            background: transparent;
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 8px;
            color: var(--text-dim);
            font-size: 12px;
            cursor: pointer;
        }
        .remind-confirm {
            padding: 8px 20px;
            background: var(--admin-color);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
        }

        /* Chat Widget */
        .chat-widget { display: none; flex-direction: column; }
        .chat-widget.visible { display: flex; }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .chat-msg { max-width: 90%; animation: msgIn 0.3s ease; }

        @keyframes msgIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        @keyframes fadeInUp {
            from { opacity: 0; transform: translate(-50%, 10px); }
            to { opacity: 1; transform: translate(-50%, 0); }
        }

        .chat-msg.user { align-self: flex-end; }
        .chat-msg.assistant { align-self: flex-start; }
        .chat-bubble { padding: 12px 14px; border-radius: 16px; font-size: 13px; line-height: 1.5; }
        .chat-msg.user .chat-bubble { background: linear-gradient(135deg, #8B5CF6, #6366F1); color: white; border-bottom-right-radius: 4px; }
        .chat-msg.assistant .chat-bubble { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.08); color: var(--text); border-bottom-left-radius: 4px; }
        .chat-time { font-size: 9px; color: var(--text-dim); margin-top: 4px; padding: 0 4px; }
        .chat-msg.user .chat-time { text-align: right; }

        .chat-quick-actions { display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px; }

        .quick-action-chip {
            padding: 5px 10px;
            background: rgba(255,255,255,0.04);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 14px;
            font-size: 10px;
            color: var(--text-dim);
            cursor: pointer;
        }

        .quick-action-chip:hover { background: var(--admin-bg); border-color: var(--admin-border); color: var(--admin-color); }

        .chat-input-area { padding: 12px 16px 16px; }

        .input-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding: 6px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 24px;
            transition: border-color 0.2s, border-radius 0.2s;
            position: relative;
        }

        .input-row:focus-within { border-color: var(--admin-border); }
        .input-row.recording { border-color: var(--admin-border); }
        .input-row.expanded { border-radius: 16px; }

        .plus-btn {
            width: 36px;
            height: 36px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.06);
            border: 1px solid var(--border);
            border-radius: 50%;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
            z-index: 2;
        }

        .plus-btn:hover { background: rgba(255,255,255,0.1); color: rgba(255,255,255,0.8); }
        .plus-btn .icon { width: 16px; height: 16px; color: var(--admin-color); }
        .plus-btn svg { width: 16px; height: 16px; }

        /* Attachment menu */
        .chat-attach-menu {
            position: absolute;
            bottom: calc(100% + 8px);
            left: 0;
            background: rgba(23, 23, 37, 0.98);
            border: 1px solid var(--border);
            border-radius: 10px;
            padding: 4px;
            display: none;
            flex-direction: column;
            gap: 2px;
            min-width: 180px;
            z-index: 1000;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        .chat-attach-menu.show { display: flex; }
        .chat-attach-opt {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 10px;
            border-radius: 6px;
            font-size: 12px;
            color: rgba(255,255,255,0.7);
            cursor: pointer;
            transition: background 0.2s;
        }
        .chat-attach-opt:hover { background: rgba(255,255,255,0.05); }
        .chat-attach-opt svg { width: 14px; height: 14px; color: var(--admin-color); }

        .input-area { flex: 1; position: relative; min-height: 36px; display: flex; align-items: flex-end; }

        .input-text {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text);
            font-family: inherit;
            font-size: 13px;
            line-height: 1.5;
            outline: none;
            padding: 8px 10px;
            position: relative;
            z-index: 1;
            resize: none;
            overflow-y: hidden;
            min-height: 36px;
            max-height: 25vh;
        }

        .input-text::placeholder { color: rgba(255,255,255,0.25); }
        .input-text.scrollable { overflow-y: auto; }
        .input-row.recording .input-text { opacity: 0; pointer-events: none; }

        /* Voice waveform - FixAIR style */
        .voice-waveform {
            position: absolute;
            left: 0;
            right: 0;
            top: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .input-row.recording .voice-waveform { opacity: 1; }
        .wave-bars {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 2px;
            height: 100%;
            padding: 0;
            overflow: hidden;
        }
        .wave-bar {
            width: 3px;
            min-width: 3px;
            height: 3px;
            border-radius: 2px;
            flex-shrink: 0;
            background: var(--admin-color);
        }
        .voice-timer {
            font-size: 11px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            color: var(--text);
            min-width: 36px;
            text-align: right;
            opacity: 0.7;
            padding-right: 4px;
            background: linear-gradient(to right, transparent, var(--card) 20%);
            padding-left: 12px;
        }

        /* Dynamic action button (mic/send/stop) */
        .action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            flex-shrink: 0;
            z-index: 2;
            position: relative;
            background: linear-gradient(135deg, #8B5CF6, #6366F1);
            color: white;
        }
        .action-btn:hover { transform: scale(1.05); }
        .action-btn:active { transform: scale(0.95); }
        .action-btn .icon-wrap { position: relative; width: 16px; height: 16px; }
        .action-btn .btn-icon { position: absolute; top: 0; left: 0; width: 16px; height: 16px; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        .action-btn .btn-icon svg { width: 16px; height: 16px; }
        .action-btn .mic-icon { opacity: 1; transform: scale(1); }
        .action-btn .send-icon { opacity: 0; transform: scale(0.5) translateY(6px); }
        .action-btn .stop-icon { opacity: 0; transform: scale(0); }
        .action-btn.has-text .mic-icon { opacity: 0; transform: scale(0.5) translateY(-6px); }
        .action-btn.has-text .send-icon { opacity: 1; transform: scale(1) translateY(0); }
        .action-btn.recording .mic-icon { opacity: 0; transform: scale(0); }
        .action-btn.recording .stop-icon { opacity: 1; transform: scale(1); }
        .action-btn.recording { background: linear-gradient(135deg, #8B5CF6, #6366F1) !important; }

        /* Transcription glass sphere */
        .transcription-sphere {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            flex-shrink: 0;
            z-index: 2;
            display: none;
            animation: sphereGlow 3s ease-in-out infinite;
        }
        .transcription-sphere.active { display: block; }
        @keyframes sphereGlow {
            0%, 100% { box-shadow: 0 0 14px rgba(139,92,246,0.7), 0 0 28px rgba(139,92,246,0.3); }
            25% { box-shadow: 0 0 14px rgba(99,102,241,0.7), 0 0 28px rgba(99,102,241,0.3); }
            50% { box-shadow: 0 0 14px rgba(78,180,249,0.7), 0 0 28px rgba(78,180,249,0.3); }
            75% { box-shadow: 0 0 14px rgba(80,220,120,0.7), 0 0 28px rgba(80,220,120,0.3); }
        }
        .sphere-fog-wrap {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            overflow: hidden;
            background: rgba(20,24,32,0.3);
        }
        .sphere-fog-transcribe {
            position: absolute;
            inset: -50%;
            border-radius: 50%;
            background: radial-gradient(circle at 30% 40%, currentColor, transparent 50%), radial-gradient(circle at 70% 60%, currentColor, transparent 40%);
            filter: blur(3px);
            animation: fogSwirlT 4s ease-in-out infinite, fogColorT 3s ease-in-out infinite;
            opacity: 0.9;
        }
        .sphere-fog-transcribe-2 {
            position: absolute;
            inset: -30%;
            border-radius: 50%;
            background: radial-gradient(circle at 60% 30%, currentColor, transparent 45%);
            filter: blur(3px);
            animation: fogSwirlT2 3s ease-in-out infinite reverse, fogColorT2 3s ease-in-out infinite;
            opacity: 0.7;
        }
        .sphere-highlight {
            position: absolute;
            top: 4px;
            left: 8px;
            width: 8px;
            height: 6px;
            border-radius: 50%;
            background: radial-gradient(circle, rgba(255,255,255,0.5), transparent 70%);
        }
        @keyframes fogSwirlT { 0%, 100% { transform: rotate(0deg) scale(1); } 50% { transform: rotate(180deg) scale(1.2); } }
        @keyframes fogSwirlT2 { 0%, 100% { transform: rotate(0deg) scale(1.1); } 50% { transform: rotate(-180deg) scale(0.9); } }
        @keyframes fogColorT {
            0%, 100% { color: #8B5CF6; }
            33% { color: #6366F1; }
            66% { color: #4EB4F9; }
        }
        @keyframes fogColorT2 {
            0%, 100% { color: #6366F1; }
            50% { color: #50DC78; }
        }

        /* Sticky Note */
        .sticky-note {
            position: absolute;
            width: 220px;
            min-height: 140px;
            border-radius: 4px;
            padding: 0;
            z-index: 50;
            cursor: grab;
            display: none;
            box-shadow: 0 4px 16px rgba(0,0,0,0.3), 0 1px 3px rgba(0,0,0,0.2);
            overflow: hidden;
        }
        
        .sticky-note.visible { display: block; }
        .sticky-note:active { cursor: grabbing; }
        
        .sticky-note-header {
            padding: 10px 12px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            border-bottom: 1px solid rgba(0,0,0,0.1);
        }
        
        .sticky-note-title {
            flex: 1;
            font-size: 13px;
            font-weight: 600;
            background: transparent;
            border: none;
            color: inherit;
            outline: none;
            cursor: text;
        }
        
        .sticky-note-title::placeholder { opacity: 0.6; }
        
        .sticky-note-delete {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            border-radius: 4px;
            color: inherit;
            opacity: 0.5;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .sticky-note-delete:hover { opacity: 1; }
        .sticky-note-delete svg { width: 14px; height: 14px; }
        
        .sticky-note-content {
            padding: 10px 12px;
            min-height: 80px;
        }
        
        .sticky-note-text {
            width: 100%;
            min-height: 60px;
            background: transparent;
            border: none;
            color: inherit;
            font-size: 12px;
            line-height: 1.5;
            resize: none;
            outline: none;
        }
        
        .sticky-note-text::placeholder { opacity: 0.5; }
        
        .sticky-note-footer {
            padding: 6px 12px;
            font-size: 9px;
            opacity: 0.5;
            text-align: right;
        }
        
        /* Sticky note colors */
        .sticky-note.yellow { background: #FEF3C7; color: #78350F; }
        .sticky-note.pink { background: #FCE7F3; color: #831843; }
        .sticky-note.blue { background: #DBEAFE; color: #1E3A8A; }
        .sticky-note.green { background: #D1FAE5; color: #064E3B; }
        .sticky-note.purple { background: #EDE9FE; color: #4C1D95; }
        .sticky-note.orange { background: #FFEDD5; color: #7C2D12; }

        /* Voice Note */
        .voice-note {
            position: absolute;
            width: 260px;
            background: rgba(23, 23, 37, 0.55);
            backdrop-filter: blur(6px);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            padding: 14px;
            z-index: 50;
            cursor: grab;
            display: none;
        }

        .voice-note.visible { display: block; }
        .voice-note:active { cursor: grabbing; }
        .voice-note-header { display: flex; align-items: center; gap: 12px; margin-bottom: 10px; }

        .voice-note-play {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--admin-bg);
            border: 1px solid var(--admin-border);
            border-radius: 50%;
            color: var(--admin-color);
            cursor: pointer;
            transition: all 0.2s;
        }

        .voice-note-play:hover { background: rgba(78,180,249,0.2); }
        .voice-note-play svg { width: 16px; height: 16px; margin-left: 2px; }
        
        @keyframes voiceNotePulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(139, 92, 246, 0.4); }
            50% { box-shadow: 0 0 0 8px rgba(139, 92, 246, 0); }
        }
        
        /* Recording state - use purple instead of red */
        .voice-note.recording .voice-note-play {
            background: linear-gradient(135deg, #8B5CF6, #6366F1);
            border-color: transparent;
            color: white;
            animation: voiceNotePulse 1.5s ease-in-out infinite;
        }
        .voice-note.recording .voice-note-play svg { margin-left: 0; }
        
        /* Transcribing state - sphere replaces button */
        .voice-note.transcribing .voice-note-play {
            display: none;
        }
        .voice-note.transcribing .voice-note-transcription-sphere {
            display: flex;
        }
        
        .voice-note-transcription-sphere {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            position: relative;
            overflow: hidden;
            display: none;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            animation: sphereGlow 3s ease-in-out infinite;
        }
        
        .voice-note-transcription-sphere .sphere-fog-wrap {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            overflow: hidden;
            background: rgba(20,24,32,0.3);
        }
        
        /* Playing state */
        .voice-note.playing .voice-note-play {
            background: linear-gradient(135deg, #8B5CF6, #6366F1);
            border-color: transparent;
            color: white;
        }
        .voice-note.playing .voice-note-play svg { margin-left: 0; }
        
        /* Progress bar for playback */
        .voice-note-progress {
            width: 100%;
            height: 4px;
            background: rgba(255,255,255,0.1);
            border-radius: 2px;
            margin-top: 8px;
            cursor: pointer;
            position: relative;
        }
        .voice-note-progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #8B5CF6, #6366F1);
            border-radius: 2px;
            width: 0%;
            transition: width 0.1s linear;
        }
        .voice-note-progress-handle {
            position: absolute;
            top: 50%;
            transform: translate(-50%, -50%);
            width: 10px;
            height: 10px;
            background: white;
            border-radius: 50%;
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
            left: 0%;
        }
        
        .voice-note-info { flex: 1; }
        .voice-note-title { font-size: 13px; font-weight: 500; color: var(--text); margin-bottom: 2px; }
        .voice-note-duration { font-size: 10px; color: var(--text-dim); }
        .voice-note-summary { 
            font-size: 11px; 
            color: rgba(255,255,255,0.5); 
            line-height: 1.5; 
            min-height: 20px;
            max-height: 50px; /* approximately 3 lines */
            overflow-y: auto;
            scrollbar-width: thin; /* Firefox */
            scrollbar-color: transparent transparent; /* Firefox - hidden by default */
            transition: scrollbar-color 0.3s;
        }
        .voice-note-summary:hover {
            scrollbar-color: rgba(255,255,255,0.3) transparent; /* Show on hover */
        }
        .voice-note-summary::-webkit-scrollbar { width: 4px; }
        .voice-note-summary::-webkit-scrollbar-track { background: transparent; }
        .voice-note-summary::-webkit-scrollbar-thumb { 
            background: transparent; 
            border-radius: 2px;
            transition: background 0.3s;
        }
        .voice-note-summary:hover::-webkit-scrollbar-thumb { 
            background: rgba(255,255,255,0.3); 
        }
        
        /* STT Quick Text - Chat Input Style */
        .stt-controls {
            position: fixed;
            bottom: 24px;
            right: 24px;
            z-index: 99999;
            opacity: 0.3;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .stt-controls:hover { opacity: 1; }
        .stt-controls.expanded { opacity: 1; }
        
        .stt-trigger {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            background: rgba(32, 34, 49, 0.4);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255, 255, 255, 0.06);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s;
            color: rgba(255,255,255,0.5);
        }
        .stt-controls:hover .stt-trigger {
            background: rgba(32, 34, 49, 0.9);
            border-color: rgba(255, 255, 255, 0.1);
            color: rgba(255,255,255,0.9);
        }
        .stt-trigger svg { width: 18px; height: 18px; stroke: currentColor; fill: none; }
        .stt-controls.expanded .stt-trigger { display: none; }
        
        .stt-panel {
            display: none;
            width: 320px;
            background: rgba(23, 23, 37, 0.95);
            backdrop-filter: blur(30px);
            border: 1px solid rgba(255,255,255,0.08);
            border-radius: 20px;
            box-shadow: 0 8px 40px rgba(0,0,0,0.4);
            overflow: hidden;
        }
        .stt-controls.expanded .stt-panel { display: block; }
        
        .stt-panel-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
        }
        .stt-panel-title { font-size: 12px; font-weight: 500; color: var(--text-dim); }
        .stt-panel-close {
            width: 24px;
            height: 24px;
            border: none;
            background: transparent;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-dim);
            transition: all 0.15s;
        }
        .stt-panel-close:hover { background: rgba(255,255,255,0.1); color: var(--text); }
        .stt-panel-close svg { width: 14px; height: 14px; }
        
        .stt-input-area { padding: 12px; }
        
        .stt-input-row {
            display: flex;
            align-items: flex-end;
            gap: 8px;
            padding: 6px;
            background: var(--card);
            border: 1px solid var(--border);
            border-radius: 24px;
            transition: border-color 0.2s;
            position: relative;
        }
        .stt-input-row:focus-within { border-color: var(--admin-border); }
        .stt-input-row.recording { border-color: var(--admin-border); }
        
        .stt-input-wrap { flex: 1; position: relative; min-height: 36px; display: flex; align-items: flex-end; }
        
        .stt-textarea {
            width: 100%;
            background: transparent;
            border: none;
            color: var(--text);
            font-family: inherit;
            font-size: 13px;
            line-height: 1.5;
            outline: none;
            padding: 8px 10px;
            resize: none;
            min-height: 36px;
            max-height: 120px;
        }
        .stt-textarea::placeholder { color: rgba(255,255,255,0.25); }
        .stt-input-row.recording .stt-textarea { opacity: 0; pointer-events: none; }
        
        .stt-waveform {
            position: absolute;
            left: 0; right: 0; top: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }
        .stt-input-row.recording .stt-waveform { opacity: 1; }
        .stt-wave-bars {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            gap: 2px;
            height: 100%;
            padding: 0 10px;
            overflow: hidden;
        }
        .stt-wave-bar {
            width: 3px;
            min-width: 3px;
            height: 3px;
            border-radius: 2px;
            flex-shrink: 0;
            background: var(--admin-color);
        }
        .stt-timer {
            font-size: 11px;
            font-weight: 600;
            font-variant-numeric: tabular-nums;
            color: var(--text);
            min-width: 36px;
            text-align: right;
            opacity: 0.7;
            padding-right: 4px;
            background: linear-gradient(to right, transparent, var(--card) 20%);
            padding-left: 12px;
        }
        
        .stt-action-btn {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform 0.2s;
            flex-shrink: 0;
            position: relative;
            background: linear-gradient(135deg, #8B5CF6, #6366F1);
            color: white;
        }
        .stt-action-btn:hover { transform: scale(1.05); }
        .stt-action-btn:active { transform: scale(0.95); }
        .stt-action-btn .stt-icon-wrap { position: relative; width: 16px; height: 16px; }
        .stt-action-btn .stt-btn-icon { position: absolute; top: 0; left: 0; width: 16px; height: 16px; transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1); }
        .stt-action-btn .stt-btn-icon svg { width: 16px; height: 16px; }
        .stt-action-btn .stt-mic-icon { opacity: 1; transform: scale(1); }
        .stt-action-btn .stt-stop-icon { opacity: 0; transform: scale(0); }
        .stt-action-btn .stt-copy-icon { opacity: 0; transform: scale(0); }
        .stt-action-btn.recording .stt-mic-icon { opacity: 0; transform: scale(0); }
        .stt-action-btn.recording .stt-stop-icon { opacity: 1; transform: scale(1); }
        .stt-action-btn.recording { background: linear-gradient(135deg, #EF4444, #DC2626) !important; }
        .stt-action-btn.has-text .stt-mic-icon { opacity: 0; transform: scale(0); }
        .stt-action-btn.has-text .stt-copy-icon { opacity: 1; transform: scale(1); }
        .stt-action-btn.has-text { background: linear-gradient(135deg, #10B981, #059669) !important; }
        
        /* Waveform in voice note */
        .voice-note-waveform {
            display: flex;
            align-items: center;
            justify-content: flex-start;
            gap: 2px;
            height: 24px;
            overflow: hidden;
        }
        .voice-note-waveform .wave-bar {
            width: 3px;
            min-width: 3px;
            height: 3px;
            border-radius: 2px;
            flex-shrink: 0;
            background: var(--admin-color);
        }
        
        /* Voice note action buttons (copy + delete) */
        .voice-note-actions {
            position: absolute;
            top: 8px;
            right: 8px;
            display: flex;
            gap: 6px;
            opacity: 0;
            transition: opacity 0.2s;
            z-index: 10;
        }
        .voice-note:hover .voice-note-actions { opacity: 1; }
        
        .voice-note-copy,
        .voice-note-actions .voice-note-delete {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.15s;
            position: static;
        }
        .voice-note-copy:hover { background: rgba(78, 180, 249, 0.2); color: var(--admin-color); }
        .voice-note-actions .voice-note-delete:hover { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .voice-note-copy svg,
        .voice-note-actions .voice-note-delete svg { width: 14px; height: 14px; }
        
        /* Standalone delete button (during recording) - positioned separately */
        .voice-note > .voice-note-delete {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255,255,255,0.1);
            border: none;
            border-radius: 6px;
            color: var(--text-dim);
            cursor: pointer;
            transition: all 0.15s;
            opacity: 0;
            z-index: 10;
        }
        .voice-note:hover > .voice-note-delete { opacity: 1; }
        .voice-note > .voice-note-delete:hover { background: rgba(239, 68, 68, 0.2); color: var(--red); }
        .voice-note > .voice-note-delete svg { width: 14px; height: 14px; }

        /* Context Menu */
        .context-menu {
            position: fixed;
            background: rgba(23, 23, 37, 0.95);
            backdrop-filter: blur(20px);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 6px;
            min-width: 180px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.4);
            z-index: 2000;
            display: none;
        }

        .context-menu.active { display: block; }
        .context-menu-item { display: flex; align-items: center; gap: 10px; padding: 10px 12px; border-radius: 8px; font-size: 12px; color: var(--text); cursor: pointer; }
        .context-menu-item:hover { background: rgba(255,255,255,0.08); }
        .context-menu-item svg { width: 14px; height: 14px; color: var(--text-dim); }
        .context-menu-divider { height: 1px; background: var(--border); margin: 4px 0; }

        /* Voice Overlay */
        .voice-overlay {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.85);
            backdrop-filter: blur(12px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 3000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.3s ease;
        }

        .voice-overlay.active { opacity: 1; pointer-events: auto; }

        .voice-sphere-large { position: relative; width: 140px; height: 140px; margin-bottom: 50px; }

        .voice-sphere-large .sphere-glow {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 180%;
            height: 180%;
            border-radius: 50%;
            background: radial-gradient(circle, var(--admin-glow) 0%, transparent 70%);
            filter: blur(30px);
            animation: sphereGlowLarge 2s ease-in-out infinite;
        }

        @keyframes sphereGlowLarge {
            0%, 100% { opacity: 0.5; transform: translate(-50%, -50%) scale(1); }
            50% { opacity: 1; transform: translate(-50%, -50%) scale(1.15); }
        }

        .voice-sphere-large .sphere-core {
            position: absolute;
            inset: 0;
            border-radius: 50%;
            background: linear-gradient(180deg, #7dd3fc 0%, #4eb4f9 30%, #2892d7 60%, #2a8fd3 100%);
            box-shadow: 0 0 80px 30px rgba(78, 180, 249, 0.3);
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .voice-sphere-large .voice-bars-large { display: flex; gap: 8px; align-items: center; }
        .voice-sphere-large .voice-bar-lg { width: 8px; background: rgba(255,255,255,0.9); border-radius: 4px; }
        .voice-sphere-large .voice-bar-lg:nth-child(1) { height: 24px; animation: voiceBarLg 0.5s ease-in-out infinite 0s; }
        .voice-sphere-large .voice-bar-lg:nth-child(2) { height: 40px; animation: voiceBarLg 0.5s ease-in-out infinite 0.1s; }
        .voice-sphere-large .voice-bar-lg:nth-child(3) { height: 56px; animation: voiceBarLg 0.5s ease-in-out infinite 0.15s; }
        .voice-sphere-large .voice-bar-lg:nth-child(4) { height: 40px; animation: voiceBarLg 0.5s ease-in-out infinite 0.2s; }
        .voice-sphere-large .voice-bar-lg:nth-child(5) { height: 24px; animation: voiceBarLg 0.5s ease-in-out infinite 0.25s; }

        @keyframes voiceBarLg {
            0%, 100% { transform: scaleY(0.4); opacity: 0.5; }
            50% { transform: scaleY(1); opacity: 1; }
        }

        .voice-transcript { text-align: center; max-width: 600px; padding: 0 30px; }
        .voice-transcript-text { font-size: 26px; font-weight: 300; color: var(--text); line-height: 1.5; min-height: 78px; }
        .voice-transcript-hint { font-size: 13px; color: var(--text-dim); margin-top: 24px; }

        .voice-cancel-btn {
            position: absolute;
            bottom: 60px;
            padding: 12px 28px;
            background: rgba(255,255,255,0.08);
            border: 1px solid rgba(255,255,255,0.15);
            border-radius: 24px;
            color: rgba(255,255,255,0.7);
            font-size: 13px;
            cursor: pointer;
        }

        .voice-cancel-btn:hover { background: rgba(255,255,255,0.12); color: var(--text); }

        /* Compose/Forward Modal */
        .compose-modal {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.7);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4000;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .compose-modal.active { opacity: 1; pointer-events: auto; }
        .compose-content {
            background: rgba(23, 23, 37, 0.98);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 16px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.5);
        }
        .compose-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 16px 20px;
            border-bottom: 1px solid rgba(255,255,255,0.06);
            font-weight: 600;
            font-size: 14px;
        }
        .compose-close {
            background: none;
            border: none;
            color: rgba(255,255,255,0.5);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            line-height: 1;
        }
        .compose-close:hover { color: var(--text); }
        .compose-fields { padding: 16px 20px; }
        .compose-field {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 12px;
        }
        .compose-field label {
            width: 50px;
            font-size: 12px;
            color: rgba(255,255,255,0.5);
        }
        .compose-field input {
            flex: 1;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 10px 12px;
            font-size: 13px;
            color: var(--text);
        }
        .compose-field input:focus {
            outline: none;
            border-color: var(--admin-color);
            background: rgba(78, 180, 249, 0.05);
        }
        #composeBody {
            width: 100%;
            min-height: 120px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 8px;
            padding: 12px;
            font-size: 13px;
            color: var(--text);
            resize: vertical;
            font-family: inherit;
        }
        #composeBody:focus {
            outline: none;
            border-color: var(--admin-color);
        }
        .compose-footer {
            padding: 16px 20px;
            border-top: 1px solid rgba(255,255,255,0.06);
            display: flex;
            justify-content: flex-end;
        }
        .compose-send {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 10px 20px;
            background: linear-gradient(135deg, var(--admin-color), #2892d7);
            border: none;
            border-radius: 8px;
            color: white;
            font-size: 13px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        .compose-send:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(78,180,249,0.3); }
        .compose-send svg { width: 16px; height: 16px; }

        /* AI Draft Modal - Clean minimal style */
        .ai-draft-modal {
            position: fixed;
            inset: 0;
            background: rgba(40, 50, 70, 0.75);
            backdrop-filter: blur(20px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 4001;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .ai-draft-modal.active { opacity: 1; pointer-events: auto; }
        .ai-draft-content {
            width: 90%;
            max-width: 580px;
            text-align: center;
        }
        .ai-draft-title {
            font-size: 28px;
            font-weight: 500;
            color: var(--text);
            margin-bottom: 12px;
        }
        .ai-draft-subtitle {
            font-size: 14px;
            color: rgba(255,255,255,0.5);
            margin-bottom: 28px;
        }
        .ai-draft-input-wrapper {
            background: rgba(60, 60, 70, 0.9);
            border-radius: 12px;
            overflow: hidden;
        }
        .ai-draft-input {
            width: 100%;
            background: transparent;
            border: none;
            padding: 16px 18px 8px 18px;
            font-size: 15px;
            color: var(--text);
            resize: none;
            min-height: 24px;
            max-height: 120px;
            font-family: inherit;
        }
        .ai-draft-input:focus {
            outline: none;
        }
        .ai-draft-input::placeholder {
            color: rgba(255,255,255,0.4);
        }
        .ai-draft-toolbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 8px 12px 12px 12px;
        }
        .ai-draft-toolbar-left {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .ai-draft-tool-btn {
            background: none;
            border: none;
            color: rgba(255,255,255,0.5);
            cursor: pointer;
            padding: 4px;
            display: flex;
            align-items: center;
            gap: 4px;
            font-size: 12px;
            transition: color 0.15s;
        }
        .ai-draft-tool-btn:hover { color: var(--text); }
        .ai-draft-tool-btn svg { width: 16px; height: 16px; }
        .ai-draft-divider {
            width: 1px;
            height: 16px;
            background: rgba(255,255,255,0.15);
        }
        .ai-draft-smarter {
            display: flex;
            align-items: center;
            gap: 4px;
            color: rgba(255,255,255,0.5);
            font-size: 12px;
        }
        .ai-draft-smarter svg {
            width: 14px;
            height: 14px;
            color: #F0C060;
        }
        .ai-draft-mic {
            background: none;
            border: none;
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            padding: 6px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.15s;
        }
        .ai-draft-mic:hover { 
            background: rgba(255,255,255,0.1);
            color: var(--text); 
        }
        .ai-draft-mic svg { width: 18px; height: 18px; }
        .ai-draft-close {
            position: absolute;
            top: 20px;
            right: 20px;
            background: none;
            border: none;
            color: rgba(255,255,255,0.4);
            cursor: pointer;
            padding: 8px;
            font-size: 24px;
            line-height: 1;
        }
        .ai-draft-close:hover { color: var(--text); }
        .ai-draft-hint {
            font-size: 12px;
            color: rgba(255,255,255,0.35);
            margin-top: 16px;
        }

        /* Mobile Responsiveness */
        @media (max-width: 768px) {
            .admin-bar {
                transform: scale(0.85);
                transform-origin: center top;
            }
            .widget {
                min-width: 300px !important;
            }
            .email-content {
                flex-wrap: wrap;
            }
            .email-sender {
                width: 100% !important;
                max-width: none !important;
            }
            .email-subject, .email-preview {
                width: 100%;
                max-width: none !important;
            }
            .email-drawer {
                width: 100% !important;
                left: 0 !important;
            }
            .ai-tools-bar {
                flex-wrap: wrap;
                gap: 4px;
            }
            .ai-tools-separator {
                display: none;
            }
            .ai-keyboard-hint {
                display: none;
            }
        }

        @media (max-width: 480px) {
            .admin-bar {
                transform: scale(0.7);
            }
            .compose-content, .ai-draft-content {
                width: 95%;
                margin: 10px;
            }
            .email-item {
                padding: 10px 8px;
            }
            .email-sender {
                font-size: 12px;
            }
            .email-subject {
                font-size: 12px;
            }
        }
    </style>
    <!-- Supabase Realtime Client -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="workspace" id="workspace">
        <div class="workspace-content" id="workspaceContent">
            <!-- Admin Bar -->
            <div class="admin-bar inactive" id="adminBar">
                <div class="admin-sphere" id="adminSphere" onclick="toggleModule()">
                    <div class="admin-sphere-atmosphere"></div>
                    <div class="admin-sphere-ring"></div>
                    <div class="admin-sphere-ring"></div>
                    <div class="admin-sphere-ring"></div>
                    <div class="admin-sphere-core">
                        <div class="sphere-voice-bars">
                            <div class="sphere-voice-bar"></div>
                            <div class="sphere-voice-bar"></div>
                            <div class="sphere-voice-bar"></div>
                            <div class="sphere-voice-bar"></div>
                            <div class="sphere-voice-bar"></div>
                        </div>
                    </div>
                </div>
                <div class="admin-bar-content">
                    <span class="admin-bar-title">NŪR</span>
                    <div class="admin-bar-divider"></div>
                    <span class="admin-bar-subtitle">Time = Currency</span>
                    <div class="admin-value-badge">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>
                        <span id="todayValue">$350</span>
                    </div>
                    <button class="admin-bar-fullscreen-btn" onclick="toggleWorkspaceFullscreen(event)" title="Fullscreen">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
                    </button>
                </div>
            </div>

            <!-- Task Widget -->
            <div class="widget" id="widgetTasks" onmousedown="bringToFront('widgetTasks')" onclick="handleWidgetClick(event, 'widgetTasks')">
                <div class="widget-drag-zone" onmousedown="startWidgetDrag(event, 'widgetTasks')" onclick="handleDragZoneClick(event, 'widgetTasks')"></div>
                <button class="widget-fullscreen-btn" onclick="toggleFullscreen(event, 'widgetTasks')" title="Fullscreen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
                </button>
                <button class="widget-close-btn" onclick="collapseWidget(event, 'widgetTasks')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
                <div class="widget-body">
                    <div class="task-section-label">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                        Today's Focus
                    </div>
                    <div class="task-card high" onclick="event.stopPropagation()">
                        <div class="task-card-header">
                            <span class="task-card-title">Close investor meeting with SWF</span>
                            <span class="task-ris high">95</span>
                        </div>
                        <div class="task-card-meta">
                            <span class="task-meta-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>2h</span>
                            <span class="task-meta-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>$50K potential</span>
                        </div>
                    </div>
                    <div class="task-card high" onclick="event.stopPropagation()">
                        <div class="task-card-header">
                            <span class="task-card-title">Finalize PULSE Live Closer demo</span>
                            <span class="task-ris high">88</span>
                        </div>
                        <div class="task-card-meta">
                            <span class="task-meta-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>1.5h</span>
                            <span class="task-meta-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>$10K potential</span>
                        </div>
                    </div>
                    <div class="task-card medium" onclick="event.stopPropagation()">
                        <div class="task-card-header">
                            <span class="task-card-title">Review partnership proposal</span>
                            <span class="task-ris medium">72</span>
                        </div>
                        <div class="task-card-meta">
                            <span class="task-meta-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>45m</span>
                            <span class="task-meta-item"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg>$5K potential</span>
                        </div>
                    </div>
                    <div class="task-list-section">
                        <div class="task-list-header">
                            <span class="task-list-title">Backlog</span>
                            <span class="task-list-count">4 tasks</span>
                        </div>
                        <div class="task-mini" onclick="event.stopPropagation(); toggleTask(this)">
                            <div class="task-checkbox"></div>
                            <span class="task-mini-text">Follow up with lead from demo</span>
                            <span class="task-mini-value">$2K</span>
                        </div>
                        <div class="task-mini" onclick="event.stopPropagation(); toggleTask(this)">
                            <div class="task-checkbox"></div>
                            <span class="task-mini-text">Update pricing documentation</span>
                            <span class="task-mini-value">$500</span>
                        </div>
                        <div class="task-mini completed" onclick="event.stopPropagation(); toggleTask(this)">
                            <div class="task-checkbox checked"></div>
                            <span class="task-mini-text">Send weekly status report</span>
                            <span class="task-mini-value">$100</span>
                        </div>
                        <div class="task-mini" onclick="event.stopPropagation(); toggleTask(this)">
                            <div class="task-checkbox"></div>
                            <span class="task-mini-text">Schedule team sync</span>
                            <span class="task-mini-value">$75</span>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Calendar Widget -->
            <div class="widget" id="widgetCalendar" onmousedown="bringToFront('widgetCalendar')" onclick="handleWidgetClick(event, 'widgetCalendar')">
                <div class="widget-drag-zone" onmousedown="startWidgetDrag(event, 'widgetCalendar')" onclick="handleDragZoneClick(event, 'widgetCalendar')"></div>
                <button class="widget-fullscreen-btn" onclick="toggleFullscreen(event, 'widgetCalendar')" title="Fullscreen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
                </button>
                <button class="widget-close-btn" onclick="collapseWidget(event, 'widgetCalendar')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
                <div class="widget-body">
                    <div class="calendar-header">
                        <button class="calendar-nav-btn" onclick="event.stopPropagation()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg></button>
                        <span class="calendar-date-label">Tuesday, December 31</span>
                        <button class="calendar-nav-btn" onclick="event.stopPropagation()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg></button>
                        <div class="calendar-tabs">
                            <button class="calendar-tab active" onclick="event.stopPropagation()">Day</button>
                            <button class="calendar-tab" onclick="event.stopPropagation()">Week</button>
                            <button class="calendar-tab" onclick="event.stopPropagation()">Month</button>
                        </div>
                    </div>
                    <div class="calendar-grid">
                        <div class="calendar-times">
                            <div class="calendar-time-slot">9 AM</div>
                            <div class="calendar-time-slot">10 AM</div>
                            <div class="calendar-time-slot">11 AM</div>
                            <div class="calendar-time-slot">12 PM</div>
                            <div class="calendar-time-slot">1 PM</div>
                        </div>
                        <div class="calendar-events">
                            <div class="calendar-hour-line"></div>
                            <div class="calendar-hour-line"></div>
                            <div class="calendar-hour-line"></div>
                            <div class="calendar-hour-line"></div>
                            <div class="calendar-hour-line"></div>
                            <div class="calendar-event revenue" style="top: 5px; height: 95px;" onclick="event.stopPropagation()">
                                <div>Investor Call - SWF</div>
                                <div class="calendar-event-value">$500 potential</div>
                            </div>
                            <div class="calendar-event work" style="top: 105px; height: 45px;" onclick="event.stopPropagation()"><div>Team Standup</div></div>
                            <div class="calendar-event personal" style="top: 155px; height: 45px;" onclick="event.stopPropagation()"><div>Lunch Break</div></div>
                        </div>
                    </div>
                    <div class="calendar-summary">
                        <div class="summary-stat"><span class="summary-value">6.5h</span><span class="summary-label">Scheduled</span></div>
                        <div class="summary-stat"><span class="summary-value green">3.5h</span><span class="summary-label">High Value</span></div>
                        <div class="summary-stat"><span class="summary-value cyan">$650</span><span class="summary-label">Projected</span></div>
                        <div class="summary-stat"><span class="summary-value">54%</span><span class="summary-label">Efficiency</span></div>
                    </div>
                </div>
            </div>

            <!-- Email Widget -->
            <div class="widget" id="widgetEmail" onmousedown="bringToFront('widgetEmail')" onclick="handleWidgetClick(event, 'widgetEmail')">
                <div class="widget-drag-zone" onmousedown="startWidgetDrag(event, 'widgetEmail')" onclick="handleDragZoneClick(event, 'widgetEmail')"></div>
                <button class="widget-fullscreen-btn" onclick="toggleFullscreen(event, 'widgetEmail')" title="Fullscreen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
                </button>
                <button class="widget-close-btn" onclick="collapseWidget(event, 'widgetEmail')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
                <div class="widget-body">
                    <div class="email-widget-container" onclick="handleWidgetClick(event, 'widgetEmail')">
                        <div class="email-header">
                            <div class="email-tabs-row">
                                <button class="email-compose-btn" onclick="event.stopPropagation(); openAiDraftModal()" title="New email">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                </button>
                                <button class="email-tab active" onclick="event.stopPropagation(); switchEmailTab('inbox')">Inbox <span class="email-tab-count" id="inboxCount">0</span></button>
                                <button class="email-tab" onclick="event.stopPropagation(); switchEmailTab('sent')">Sent</button>
                                <button class="email-tab" onclick="event.stopPropagation(); switchEmailTab('archive')">Archive</button>
                                <div class="email-options-dropdown">
                                    <button class="email-options-btn" onclick="event.stopPropagation(); toggleEmailOptions()" title="More options">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="12" cy="5" r="1"/><circle cx="12" cy="19" r="1"/></svg>
                                    </button>
                                    <div class="email-options-menu" id="emailOptionsMenu">
                                        <button onclick="event.stopPropagation(); loadEmails(true); closeEmailOptions()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M1 4v6h6M23 20v-6h-6"/><path d="M20.49 9A9 9 0 0 0 5.64 5.64L1 10m22 4l-4.64 4.36A9 9 0 0 1 3.51 15"/></svg>
                                            Sync Emails
                                        </button>
                                        <button onclick="event.stopPropagation(); createMeeting(); closeEmailOptions()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"/><line x1="16" y1="2" x2="16" y2="6"/><line x1="8" y1="2" x2="8" y2="6"/><line x1="3" y1="10" x2="21" y2="10"/></svg>
                                            Create Meeting
                                        </button>
                                    </div>
                                </div>
                                <button class="email-fullscreen-btn" onclick="event.stopPropagation(); toggleFullscreen(event, 'widgetEmail')" title="Toggle fullscreen">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
                                </button>
                            </div>
                            <div class="email-search-row">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                                <input type="text" id="emailSearchInput" placeholder="Search emails..." oninput="searchEmails(this.value)" onclick="event.stopPropagation()">
                                <button class="search-clear" id="searchClear" onclick="event.stopPropagation(); clearSearch()" style="display: none;">×</button>
                            </div>
                            <div class="email-filter-row" id="emailFilterToggle">
                                <div class="filter-option active" onclick="event.stopPropagation(); switchFilter('focused')">Focused</div>
                                <div class="filter-option" onclick="event.stopPropagation(); switchFilter('reply')">Needs Reply</div>
                                <div class="filter-option" onclick="event.stopPropagation(); switchFilter('others')">Others</div>
                            </div>
                        </div>
                        <div class="email-list" id="emailList">
                            <div class="email-empty" id="emailEmpty">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                                <span>Click refresh to load emails</span>
                            </div>
                        </div>
                        <div class="email-summary" id="emailSummary">
                            <div class="summary-left">
                                <div class="summary-stat"><span class="summary-value" id="statTotal">0</span><span class="summary-label">emails</span></div>
                                <div class="summary-separator"></div>
                                <div class="summary-stat"><span class="summary-value" id="statProcessed">0</span><span class="summary-label">processed</span></div>
                            </div>
                            <div class="summary-stat"><span class="summary-value cyan" id="statSaved">~0m</span><span class="summary-label">saved</span></div>
                        </div>
                        <!-- Selection Bar -->
                        <div class="email-selection-bar" id="emailSelectionBar">
                            <button class="selection-btn primary" onclick="event.stopPropagation(); markSelectedAsDone()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                Mark <span id="selectionCount">0</span> Emails as Done
                            </button>
                            <button class="selection-btn secondary" id="readUnreadBtn" onclick="event.stopPropagation(); toggleSelectedReadStatus()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" id="readUnreadIcon"><path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/></svg>
                                <span id="readUnreadText">Mark <span id="selectionCount2">0</span> Emails as Read</span>
                            </button>
                            <button class="selection-close" onclick="event.stopPropagation(); clearSelection()">
                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                            </button>
                        </div>
                        <!-- Email Drawer -->
                        <div class="email-drawer" id="emailDrawer">
                            <div class="email-drawer-header">
                                <button class="drawer-close-btn" onclick="event.stopPropagation(); closeEmailDrawer()">
                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                </button>
                                <div class="drawer-actions">
                                    <button class="drawer-action-btn primary" onclick="event.stopPropagation(); replyToEmail()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 17 4 12 9 7"/><path d="M20 18v-2a4 4 0 0 0-4-4H4"/></svg>
                                        Reply
                                    </button>
                                    <button class="drawer-action-btn" onclick="event.stopPropagation(); forwardEmail()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 17 20 12 15 7"/><path d="M4 18v-2a4 4 0 0 1 4-4h12"/></svg>
                                        Forward
                                    </button>
                                    <button class="drawer-action-btn" onclick="event.stopPropagation(); archiveCurrentEmail()">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                        Done
                                    </button>
                                    <div class="more-dropdown" style="position: relative;">
                                        <button class="drawer-action-btn" onclick="event.stopPropagation(); toggleMoreMenu()">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="1"/><circle cx="19" cy="12" r="1"/><circle cx="5" cy="12" r="1"/></svg>
                                        </button>
                                        <div class="more-menu" id="moreMenu">
                                            <button onclick="event.stopPropagation(); markAsUnread()">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"/><polyline points="22,6 12,13 2,6"/></svg>
                                                Mark Unread
                                            </button>
                                            <button onclick="event.stopPropagation(); snoozeEmail()">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                                Snooze
                                            </button>
                                            <button onclick="event.stopPropagation(); deleteCurrentEmail()">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                                Delete
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            <div class="email-drawer-content">
                                <div class="drawer-email-header">
                                    <div class="drawer-subject" id="drawerSubject"></div>
                                    <div class="drawer-sender-row">
                                        <div class="drawer-avatar" id="drawerAvatar">--</div>
                                        <div class="drawer-sender-info">
                                            <div class="drawer-sender-name" id="drawerSender">Select an email</div>
                                            <div class="drawer-sender-email" id="drawerSenderEmail"></div>
                                        </div>
                                        <div class="drawer-date" id="drawerDate"></div>
                                    </div>
                                    <div class="drawer-tags">
                                    </div>
                                </div>
                                <iframe class="drawer-email-body" id="drawerBody" sandbox="allow-same-origin allow-popups allow-popups-to-escape-sandbox"></iframe>
                                
                                <!-- Email Attachments Display -->
                                <div class="email-attachments-section" id="emailAttachmentsSection" style="display: none;">
                                    <div class="attachments-header">
                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                                        <span id="attachmentsCount">0 Attachments</span>
                                    </div>
                                    <div class="attachments-grid" id="attachmentsGrid"></div>
                                </div>
                                
                                <div class="ai-reply-section">
                                    <div class="ai-reply-header">
                                        <div class="ai-badge">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 16v-4M12 8h.01"/></svg>
                                            <span id="replyModeLabel">AI Draft</span>
                                        </div>
                                        <span class="ai-label" id="replyModeDesc">Generated reply</span>
                                    </div>
                                    <!-- Reply/Forward fields (hidden by default) -->
                                    <div class="reply-fields" id="replyFields" style="display: none;">
                                        <div class="reply-field-inline">
                                            <span class="reply-label">To:</span>
                                            <span class="reply-value" id="replyToText" onclick="makeEditable('replyTo')">sender@example.com</span>
                                            <input type="email" id="replyTo" class="reply-input-hidden" onblur="hideEditable('replyTo')" oninput="scheduleDraftSave()">
                                            <span class="reply-add-links">
                                                <span class="add-cc-link" id="addCcLink" onclick="showCcField()">Cc</span>
                                                <span class="add-cc-link" id="addBccLink" onclick="showBccField()">Bcc</span>
                                            </span>
                                        </div>
                                        <div class="reply-field-inline" id="ccFieldRow" style="display: none;">
                                            <span class="reply-label">Cc:</span>
                                            <input type="email" id="replyCc" class="reply-input-inline" placeholder="Add email addresses, comma separated" oninput="scheduleDraftSave()">
                                            <button class="reply-field-close" onclick="hideCcField()" title="Remove Cc">×</button>
                                        </div>
                                        <div class="reply-field-inline" id="bccFieldRow" style="display: none;">
                                            <span class="reply-label">Bcc:</span>
                                            <input type="email" id="replyBcc" class="reply-input-inline" placeholder="Add email addresses, comma separated">
                                            <button class="reply-field-close" onclick="hideBccField()" title="Remove Bcc">×</button>
                                        </div>
                                        <div class="reply-field-inline" id="subjectFieldRow" style="display: none;">
                                            <span class="reply-label">Subject:</span>
                                            <input type="text" id="replySubject" class="reply-input-inline" placeholder="Email subject" oninput="scheduleDraftSave()">
                                        </div>
                                    </div>
                                    <!-- Reply Thread Toggle -->
                                    <button class="reply-thread-toggle" onclick="event.stopPropagation(); toggleReplyThread()" title="Show original email">•••</button>
                                    <div class="reply-thread-card" id="replyThreadCard">
                                        <div class="reply-thread-header">
                                            <span class="reply-thread-title">Reply thread</span>
                                            <div class="reply-thread-actions">
                                                <button onclick="event.stopPropagation();" title="Edit">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><path d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/></svg>
                                                </button>
                                                <button onclick="event.stopPropagation(); toggleReplyThread()" title="Close">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="reply-thread-meta" id="replyThreadMeta">On Fri, Dec 26, 2025, sender@example.com wrote:</div>
                                        <div class="reply-thread-content" id="replyThreadContent">Original email content will appear here...</div>
                                    </div>
                                    
                                    <!-- Textarea FIRST -->
                                    <textarea class="ai-reply-textarea" id="aiReplyText" placeholder="Write your message or describe what you want and click Generate..." oninput="scheduleDraftSave()" onkeydown="if((event.metaKey || event.ctrlKey) && event.key === 'Enter') { event.preventDefault(); sendReply(); }"></textarea>
                                    
                                    <!-- AI Tools Bar - Jace style -->
                                    <div class="ai-tools-bar">
                                        <!-- Attachment - paperclip -->
                                        <button class="ai-tool-btn" onclick="event.stopPropagation(); openAttachmentPicker()" title="Attach file">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 01-8.49-8.49l9.19-9.19a4 4 0 015.66 5.66l-9.2 9.19a2 2 0 01-2.83-2.83l8.49-8.48"/></svg>
                                        </button>
                                        <!-- Font - A -->
                                        <button class="ai-tool-btn" onclick="event.stopPropagation();" title="Formatting">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 20h16M6 20l6-16 6 16M8 14h8"/></svg>
                                        </button>
                                        
                                        <div class="ai-tools-separator"></div>
                                        
                                        <!-- Generate - document with lines -->
                                        <button class="ai-tool-btn" onclick="event.stopPropagation(); generateAIReply()" title="Generate AI draft">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
                                        </button>
                                        <!-- Professional - briefcase person -->
                                        <button class="ai-tool-btn" onclick="event.stopPropagation(); applyAITool('professional')" title="Make professional">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
                                        </button>
                                        <!-- Casual - chat bubble -->
                                        <button class="ai-tool-btn" onclick="event.stopPropagation(); applyAITool('casual')" title="Make casual">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"/></svg>
                                        </button>
                                        <!-- Shorter - arrows pointing inward (→|←) -->
                                        <button class="ai-tool-btn" onclick="event.stopPropagation(); applyAITool('shorter')" title="Make shorter">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="4" x2="12" y2="10"/><polyline points="9 7 12 10 15 7"/><line x1="12" y1="20" x2="12" y2="14"/><polyline points="15 17 12 14 9 17"/></svg>
                                        </button>
                                        <!-- Longer - arrows pointing outward vertically -->
                                        <button class="ai-tool-btn" onclick="event.stopPropagation(); applyAITool('longer')" title="Make longer">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="10" x2="12" y2="4"/><polyline points="9 7 12 4 15 7"/><line x1="12" y1="14" x2="12" y2="20"/><polyline points="9 17 12 20 15 17"/></svg>
                                        </button>
                                        
                                        <div class="ai-tools-separator"></div>
                                        
                                        <!-- Grammar fix - checkmark -->
                                        <button class="ai-tool-btn" onclick="event.stopPropagation(); applyAITool('grammar')" title="Fix grammar">
                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg>
                                        </button>
                                        
                                        <div class="ai-tools-spacer"></div>
                                        
                                        <!-- Keyboard hint -->
                                        <span class="ai-keyboard-hint">Press <kbd>⌘</kbd> <kbd>↵</kbd> to</span>
                                        
                                        <!-- Send button with dropdown -->
                                        <div class="send-btn-wrapper">
                                            <button class="btn-send-gradient" onclick="event.stopPropagation(); sendReply()">
                                                Send
                                            </button>
                                            <button class="btn-send-dropdown" onclick="event.stopPropagation(); toggleSendLaterDropdown()">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="6 9 12 15 18 9"/></svg>
                                            </button>
                                            <!-- Send Later Dropdown -->
                                            <div class="send-later-dropdown" id="sendLaterDropdown">
                                                <div class="send-later-header">
                                                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                                    <input type="text" class="send-later-input" id="sendLaterInput" placeholder="Try typing 'in 3h' or 'fri at 4pm'">
                                                </div>
                                                <div class="send-later-picker" onclick="event.stopPropagation(); openSendLaterCalendar()">Pick a time</div>
                                                <div class="send-later-calendar" id="sendLaterCalendar" style="display: none;">
                                                    <div class="calendar-header">
                                                        <button class="calendar-nav" onclick="event.stopPropagation(); prevMonth('sendLater')">
                                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="15 18 9 12 15 6"/></svg>
                                                        </button>
                                                        <div class="calendar-month-year">
                                                            <select id="sendLaterMonth" onchange="updateCalendar('sendLater')"></select>
                                                            <select id="sendLaterYear" onchange="updateCalendar('sendLater')"></select>
                                                        </div>
                                                        <button class="calendar-nav" onclick="event.stopPropagation(); nextMonth('sendLater')">
                                                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" width="14" height="14"><polyline points="9 18 15 12 9 6"/></svg>
                                                        </button>
                                                    </div>
                                                    <div class="calendar-grid" id="sendLaterGrid"></div>
                                                    <div class="calendar-time">
                                                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                                                        <input type="number" class="time-input" id="sendLaterHour" value="14" min="0" max="23">
                                                        <span>:</span>
                                                        <input type="number" class="time-input" id="sendLaterMinute" value="00" min="0" max="59">
                                                    </div>
                                                    <div class="calendar-actions">
                                                        <button class="btn-calendar-select" onclick="event.stopPropagation(); confirmSendLater()">Select</button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Bottom actions - only Create Empty Draft and Delete Draft -->
                                    <div class="ai-reply-footer">
                                        <div class="ai-footer-left">
                                            <button class="ai-footer-btn" onclick="event.stopPropagation(); clearDraft()">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                                                Create Empty Draft
                                            </button>
                                            <button class="ai-footer-btn" onclick="event.stopPropagation(); deleteDraft()">
                                                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg>
                                                Delete Draft
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Chat Widget -->
            <div class="widget chat-widget" id="widgetChat" onmousedown="bringToFront('widgetChat')" onclick="handleWidgetClick(event, 'widgetChat')">
                <div class="widget-drag-zone" onmousedown="startWidgetDrag(event, 'widgetChat')" onclick="handleDragZoneClick(event, 'widgetChat')"></div>
                <button class="widget-fullscreen-btn" onclick="toggleFullscreen(event, 'widgetChat')" title="Fullscreen">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
                </button>
                <button class="widget-close-btn" onclick="collapseWidget(event, 'widgetChat')">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                </button>
                <div class="chat-messages" id="chatMessages">
                    <div class="chat-msg assistant">
                        <div class="chat-bubble">Good morning! You have <strong>3 high-impact tasks</strong> today worth approximately <strong>$65K</strong> in potential revenue.</div>
                        <div class="chat-time">8:00 AM</div>
                        <div class="chat-quick-actions">
                            <span class="quick-action-chip" onclick="event.stopPropagation()">📅 Show schedule</span>
                            <span class="quick-action-chip" onclick="event.stopPropagation()">📧 Check emails</span>
                        </div>
                    </div>
                    <div class="chat-msg user">
                        <div class="chat-bubble">What do I have to focus on today?</div>
                        <div class="chat-time">8:02 AM</div>
                    </div>
                    <div class="chat-msg assistant">
                        <div class="chat-bubble">Click the <strong>refresh button</strong> in your Email widget to sync your latest emails. I'll help you prioritize them!</div>
                        <div class="chat-time">8:02 AM</div>
                    </div>
                </div>
                <div class="chat-input-area" onclick="event.stopPropagation()">
                    <div class="input-row" id="chatInputRow">
                        <div class="chat-attach-menu" id="chatAttachMenu">
                            <div class="chat-attach-opt" onclick="chatAttachAction('photo')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M23 19a2 2 0 0 1-2 2H3a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h4l2-3h6l2 3h4a2 2 0 0 1 2 2z"/><circle cx="12" cy="13" r="4"/></svg>Photo / Capture</div>
                            <div class="chat-attach-opt" onclick="chatAttachAction('file')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>Import File</div>
                        </div>
                        <button class="plus-btn" onclick="event.stopPropagation(); toggleChatAttach()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg></button>
                        <div class="input-area">
                            <textarea class="input-text" id="chatInput" placeholder="Ask anything..." rows="1" oninput="handleChatInput()" onkeydown="handleChatKeydown(event)"></textarea>
                            <div class="voice-waveform" id="voiceWaveform">
                                <div class="wave-bars" id="waveBars"></div>
                                <div class="voice-timer" id="voiceTimer">0:00</div>
                            </div>
                        </div>
                        <button class="action-btn" id="actionBtn" onclick="handleAction()">
                            <div class="icon-wrap">
                                <span class="btn-icon mic-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></span>
                                <span class="btn-icon send-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="19" x2="12" y2="5"/><polyline points="5 12 12 5 19 12"/></svg></span>
                                <span class="btn-icon stop-icon"><svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg></span>
                            </div>
                        </button>
                        <!-- Transcription Sphere -->
                        <div class="transcription-sphere" id="transcriptionSphere">
                            <div class="sphere-fog-wrap">
                                <div class="sphere-fog-transcribe"></div>
                                <div class="sphere-fog-transcribe-2"></div>
                            </div>
                            <div class="sphere-highlight"></div>
                        </div>
                    </div>
                    <!-- Hidden file inputs -->
                    <input type="file" id="chatFileInput" accept="*/*" style="display:none" onchange="handleChatFileSelect(event)">
                    <input type="file" id="chatCameraInput" accept="image/*" capture="environment" style="display:none" onchange="handleChatFileSelect(event)">
                </div>
            </div>

            <!-- Voice Notes will be dynamically created -->
        </div>
    </div>

    <!-- Mini Map -->
    <div class="mini-map" id="miniMap">
        <div class="mini-map-content" id="miniMapContent">
            <div class="mini-map-viewport" id="miniMapViewport"></div>
        </div>
        <div class="mini-map-zoom-slider">
            <span class="zoom-label">20%</span>
            <div class="zoom-track" onclick="handleZoomSliderClick(event)">
                <div class="zoom-track-fill" id="zoomTrackFill"></div>
                <div class="zoom-handle" id="zoomHandle"></div>
            </div>
            <span class="zoom-label">200%</span>
        </div>
    </div>

    <!-- Workspace Controls -->
    <div class="workspace-controls" id="workspaceControls">
        <button class="workspace-btn" onclick="centerView()" title="Center view"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M12 2v4M12 18v4M2 12h4M18 12h4"/></svg></button>
        <div class="expandable">
            <div class="workspace-divider"></div>
            <button class="workspace-btn" onclick="zoomOut()" title="Zoom out"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="8" y1="11" x2="14" y2="11"/></svg></button>
            <div class="zoom-display" id="zoomDisplay">100%</div>
            <button class="workspace-btn" onclick="zoomIn()" title="Zoom in"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/><line x1="11" y1="8" x2="11" y2="14"/><line x1="8" y1="11" x2="14" y2="11"/></svg></button>
        </div>
    </div>

    <!-- Context Menu -->
    <div class="context-menu" id="contextMenu">
        <div class="context-menu-item" onclick="addStickyNote()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14.5 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V7.5L14.5 2z"/></svg>Add Sticky Note</div>
        <div class="context-menu-item" onclick="addVoiceNote()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg>Add Voice Note</div>
        <div class="context-menu-divider"></div>
        <div class="context-menu-item" onclick="pasteUrlFromClipboard()"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><line x1="2" y1="12" x2="22" y2="12"/><path d="M12 2a15.3 15.3 0 0 1 4 10 15.3 15.3 0 0 1-4 10 15.3 15.3 0 0 1-4-10 15.3 15.3 0 0 1 4-10z"/></svg>Paste URL</div>
    </div>

    <!-- Voice Overlay -->
    <div class="voice-overlay" id="voiceOverlay">
        <div class="voice-sphere-large">
            <div class="sphere-glow"></div>
            <div class="sphere-core">
                <div class="voice-bars-large">
                    <div class="voice-bar-lg"></div>
                    <div class="voice-bar-lg"></div>
                    <div class="voice-bar-lg"></div>
                    <div class="voice-bar-lg"></div>
                    <div class="voice-bar-lg"></div>
                </div>
            </div>
        </div>
        <div class="voice-transcript">
            <div class="voice-transcript-text" id="voiceTranscriptText">Listening...</div>
            <div class="voice-transcript-hint">Try: "Add task to call investor"</div>
        </div>
        <button class="voice-cancel-btn" onclick="closeVoiceOverlay()">Cancel</button>
    </div>

    <!-- Remind Me Modal -->
    <div class="remind-modal" id="remindModal">
        <div class="remind-modal-content">
            <div class="remind-modal-header">
                <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg>
                <span>Remind me</span>
            </div>
            <div class="remind-modal-body">
                <div class="remind-input-row">
                    <input type="text" class="remind-input" id="remindInput" placeholder="Try: 8 am, 3 days, aug 7" oninput="handleRemindInput(this.value)">
                    <button class="remind-condition-select" id="remindCondition" onclick="toggleRemindCondition()">if no reply ▾</button>
                </div>
                <div class="remind-suggestions" id="remindSuggestions">
                    <div class="remind-suggestion" onclick="selectReminder('tomorrow_morning')">
                        <span class="remind-suggestion-label">tomorrow morning</span>
                        <span class="remind-suggestion-time" id="tomorrowMorningTime">TUE, 8:00 AM</span>
                    </div>
                    <div class="remind-suggestion" onclick="selectReminder('tomorrow_afternoon')">
                        <span class="remind-suggestion-label">tomorrow afternoon</span>
                        <span class="remind-suggestion-time" id="tomorrowAfternoonTime">TUE, 1:00 PM</span>
                    </div>
                    <div class="remind-suggestion" onclick="selectReminder('monday_morning')">
                        <span class="remind-suggestion-label">Monday morning</span>
                        <span class="remind-suggestion-time" id="mondayMorningTime">MON, 8:00 AM</span>
                    </div>
                    <div class="remind-suggestion" onclick="selectReminder('next_week')">
                        <span class="remind-suggestion-label">next week</span>
                        <span class="remind-suggestion-time" id="nextWeekTime">MON, MAY 18, 8:00 AM</span>
                    </div>
                </div>
            </div>
            <div class="remind-modal-footer">
                <button class="remind-cancel" onclick="closeRemindModal()">Cancel</button>
                <button class="remind-confirm" onclick="confirmReminder()">Set Reminder</button>
            </div>
        </div>
    </div>

    <!-- Compose/Forward Modal -->
    <div class="compose-modal" id="composeModal">
        <div class="compose-content">
            <div class="compose-header">
                <span id="composeTitle">Forward Email</span>
                <button class="compose-close" onclick="closeComposeModal()">×</button>
            </div>
            <div class="compose-fields">
                <div class="compose-field">
                    <label>To:</label>
                    <input type="email" id="composeTo" placeholder="recipient@email.com">
                </div>
                <div class="compose-field">
                    <label>Cc:</label>
                    <input type="email" id="composeCc" placeholder="cc@email.com (optional)">
                </div>
                <div class="compose-field">
                    <label>Subject:</label>
                    <input type="text" id="composeSubject" placeholder="Subject">
                </div>
                <textarea id="composeBody" placeholder="Add a message..."></textarea>
            </div>
            <div class="compose-footer">
                <button class="compose-send" onclick="sendComposedEmail()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"/><polygon points="22 2 15 22 11 13 2 9 22 2"/></svg>
                    Send
                </button>
            </div>
        </div>
    </div>

    <!-- AI Draft Modal - Clean minimal style -->
    <div class="ai-draft-modal" id="aiDraftModal" onclick="if(event.target === this) closeAiDraftModal()">
        <button class="ai-draft-close" onclick="closeAiDraftModal()">×</button>
        <div class="ai-draft-content">
            <div class="ai-draft-title">What would you like me to draft?</div>
            <div class="ai-draft-subtitle">e.g. Reschedule coffee with Pat to next week</div>
            <div class="ai-draft-input-wrapper">
                <textarea class="ai-draft-input" id="aiDraftPrompt" placeholder="Just say what you want me to draft" rows="1" onkeydown="if(event.key==='Enter' && !event.shiftKey){event.preventDefault(); generateAiDraft()}" oninput="autoResizeTextarea(this)"></textarea>
                <div class="ai-draft-toolbar">
                    <div class="ai-draft-toolbar-left">
                        <button class="ai-draft-tool-btn" onclick="event.stopPropagation(); openAttachmentPicker()" title="Add attachment">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg>
                        </button>
                        <div class="ai-draft-divider"></div>
                        <div class="ai-draft-smarter">
                            <svg viewBox="0 0 24 24" fill="currentColor"><path d="M9 21c0 .55.45 1 1 1h4c.55 0 1-.45 1-1v-1H9v1zm3-19C8.14 2 5 5.14 5 9c0 2.38 1.19 4.47 3 5.74V17c0 .55.45 1 1 1h6c.55 0 1-.45 1-1v-2.26c1.81-1.27 3-3.36 3-5.74 0-3.86-3.14-7-7-7z"/></svg>
                            Smarter
                        </div>
                    </div>
                    <button class="ai-draft-mic" onclick="startVoiceDraft()" title="Voice input">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/></svg>
                    </button>
                </div>
            </div>
            <div class="ai-draft-hint">Press Enter to generate • Esc to close</div>
        </div>
    </div>

    <!-- Attachment Preview Modal -->
    <div class="attachment-preview-modal" id="attachmentPreviewModal">
        <div class="attachment-preview-header">
            <span class="attachment-preview-title" id="attachmentPreviewTitle">attachment.pdf</span>
            <div class="attachment-preview-actions">
                <button class="attachment-preview-btn" onclick="downloadAttachment()">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:14px;height:14px;"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" y1="15" x2="12" y2="3"/></svg>
                    Download
                </button>
                <button class="attachment-preview-close" onclick="closeAttachmentPreview()">×</button>
            </div>
        </div>
        <div class="attachment-preview-content" id="attachmentPreviewContent"></div>
    </div>

    <!-- Priority Picker Dropdown -->
    <div class="tag-picker" id="priorityPicker">
        <div class="tag-picker-title">Priority</div>
        <div class="tag-picker-option" data-value="1" onclick="setPriority(1)">
            <span class="tag-dot" style="background: #EE6464;"></span> P1 - Urgent
        </div>
        <div class="tag-picker-option" data-value="2" onclick="setPriority(2)">
            <span class="tag-dot" style="background: #F0A050;"></span> P2 - High
        </div>
        <div class="tag-picker-option" data-value="3" onclick="setPriority(3)">
            <span class="tag-dot" style="background: #9CA3AF;"></span> P3 - Normal
        </div>
    </div>

    <!-- Category Picker Dropdown -->
    <div class="tag-picker" id="categoryPicker">
        <div class="tag-picker-title">Category</div>
        <div class="tag-picker-option" data-value="work" onclick="setCategory('work')">
            <span class="tag-dot" style="background: #7CB8DC;"></span> Work
        </div>
        <div class="tag-picker-option" data-value="personal" onclick="setCategory('personal')">
            <span class="tag-dot" style="background: #B478C8;"></span> Personal
        </div>
        <div class="tag-picker-option" data-value="finance" onclick="setCategory('finance')">
            <span class="tag-dot" style="background: #50C878;"></span> Finance
        </div>
        <div class="tag-picker-option" data-value="meeting" onclick="setCategory('meeting')">
            <span class="tag-dot" style="background: #50C878;"></span> Meeting
        </div>
        <div class="tag-picker-option" data-value="job" onclick="setCategory('job')">
            <span class="tag-dot" style="background: #A082DC;"></span> Job
        </div>
        <div class="tag-picker-option" data-value="leads" onclick="setCategory('leads')">
            <span class="tag-dot" style="background: #4EB4F9;"></span> Leads
        </div>
        <div class="tag-picker-option" data-value="clients" onclick="setCategory('clients')">
            <span class="tag-dot" style="background: #50DC78;"></span> Clients
        </div>
        <div class="tag-picker-option" data-value="newsletter" onclick="setCategory('newsletter')">
            <span class="tag-dot" style="background: #78B4C8;"></span> Newsletter
        </div>
        <div class="tag-picker-option" data-value="fyi" onclick="setCategory('fyi')">
            <span class="tag-dot" style="background: #9CA3AF;"></span> FYI
        </div>
    </div>

    <script>
        const state = {
            isActive: false,
            zoom: 1,
            highestZIndex: 100,
            emailDrawerOpen: false,
            isRecording: false,
            recordingTime: 0,
            recordingInterval: null,
            initialScrollLeft: 0,
            initialScrollTop: 0,
            miniMapTimeout: null,
            voiceNotes: [],
            adminBarTop: 0,
            adminBarLeft: 0,
            emails: [],
            emailsWithDrafts: new Set(),
            currentFilter: 'focused',
            isLoadingEmails: false
        };

        // ============================================
        // SUPABASE CONFIGURATION - UPDATE THESE VALUES
        // ============================================
        // SUPABASE CONFIGURATION
        // ============================================
        const SUPABASE_URL = 'https://cjkiglknunevvusfbqer.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNqa2lnbGtudW5ldnZ1c2ZicWVyIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjcyMDMzNDIsImV4cCI6MjA4Mjc3OTM0Mn0.QTjSoCUcillFmwKzr56KPkQFCzIJLwvA6-Jcu1ctK88';
        
        // N8N Webhook URL - Triggers email sync from Gmail
        const N8N_WEBHOOK_URL = 'https://cherhabil.app.n8n.cloud/webhook/6b9fd857-4434-45d4-9dc9-759ac4732278';
        const FETCH_ATTACHMENT_WEBHOOK = 'https://cherhabil.app.n8n.cloud/webhook/fetch-attachment';
        
        // Supabase Realtime channel
        let realtimeChannel = null;
        let isRealtimeConnected = false;
        // ============================================

        // Dynamic workspace - starts at base size, expands as needed
        let WORKSPACE_WIDTH = 6000, WORKSPACE_HEIGHT = 4000;
        const BAR_WIDTH = 1390;
        const WORKSPACE_PADDING = 500; // Extra space when expanding
        
        const widgetSizes = {
            widgetTasks: { width: 450, height: 520 },
            widgetCalendar: { width: 450, height: 520 },
            widgetEmail: { width: 450, height: 520 },
            widgetChat: { width: 450, height: 520 },
            browserWidget: { width: 450, height: 520 }
        };
        
        // Browser widgets storage
        let browserWidgets = [];

        document.addEventListener('DOMContentLoaded', () => {
            initDraggable();
            positionElements();
            centerView();
            document.getElementById('workspace').addEventListener('scroll', showMiniMap);
            
            // INFINITE WORKSPACE - Auto-expand when scrolling near edges
            const workspace = document.getElementById('workspace');
            workspace.addEventListener('scroll', () => {
                const content = document.getElementById('workspaceContent');
                const scrollRight = workspace.scrollLeft + workspace.clientWidth;
                const scrollBottom = workspace.scrollTop + workspace.clientHeight;
                const expandThreshold = 200; // Pixels from edge to trigger expansion
                const expandAmount = 500; // How much to expand
                
                // Expand right
                if (scrollRight > WORKSPACE_WIDTH - expandThreshold) {
                    WORKSPACE_WIDTH += expandAmount;
                    content.style.width = WORKSPACE_WIDTH + 'px';
                }
                
                // Expand bottom
                if (scrollBottom > WORKSPACE_HEIGHT - expandThreshold) {
                    WORKSPACE_HEIGHT += expandAmount;
                    content.style.height = WORKSPACE_HEIGHT + 'px';
                }
                
                // Expand left (shift everything right)
                if (workspace.scrollLeft < expandThreshold && workspace.scrollLeft > 0) {
                    WORKSPACE_WIDTH += expandAmount;
                    content.style.width = WORKSPACE_WIDTH + 'px';
                    // Shift all elements to the right
                    document.querySelectorAll('.widget, .voice-note, .admin-bar, .browser-widget-instance').forEach(el => {
                        el.style.left = (el.offsetLeft + expandAmount) + 'px';
                    });
                    state.adminBarLeft += expandAmount;
                    state.initialScrollLeft += expandAmount;
                    workspace.scrollLeft += expandAmount;
                }
                
                // Expand top (shift everything down)
                if (workspace.scrollTop < expandThreshold && workspace.scrollTop > 0) {
                    WORKSPACE_HEIGHT += expandAmount;
                    content.style.height = WORKSPACE_HEIGHT + 'px';
                    document.querySelectorAll('.widget, .voice-note, .admin-bar, .browser-widget-instance').forEach(el => {
                        el.style.top = (el.offsetTop + expandAmount) + 'px';
                    });
                    state.adminBarTop += expandAmount;
                    state.initialScrollTop += expandAmount;
                    workspace.scrollTop += expandAmount;
                }
            });
            
            initPasteHandler();
            loadBrowserWidgets();
        });

        function bringToFront(widgetId) {
            state.highestZIndex++;
            document.getElementById(widgetId).style.zIndex = state.highestZIndex;
        }
        
        // Expand workspace dynamically when elements are near edges
        function expandWorkspaceIfNeeded(x, y, width = 0, height = 0) {
            const content = document.getElementById('workspaceContent');
            let needsUpdate = false;
            
            // Check right edge
            if (x + width + WORKSPACE_PADDING > WORKSPACE_WIDTH) {
                WORKSPACE_WIDTH = x + width + WORKSPACE_PADDING;
                needsUpdate = true;
            }
            
            // Check bottom edge
            if (y + height + WORKSPACE_PADDING > WORKSPACE_HEIGHT) {
                WORKSPACE_HEIGHT = y + height + WORKSPACE_PADDING;
                needsUpdate = true;
            }
            
            // Check left edge (expand left by shifting everything)
            if (x < WORKSPACE_PADDING) {
                const shift = WORKSPACE_PADDING - x;
                WORKSPACE_WIDTH += shift;
                // Shift all elements to the right
                document.querySelectorAll('.widget, .voice-note, .admin-bar, .browser-widget').forEach(el => {
                    el.style.left = (el.offsetLeft + shift) + 'px';
                });
                state.adminBarLeft += shift;
                state.initialScrollLeft += shift;
                needsUpdate = true;
            }
            
            // Check top edge
            if (y < WORKSPACE_PADDING) {
                const shift = WORKSPACE_PADDING - y;
                WORKSPACE_HEIGHT += shift;
                document.querySelectorAll('.widget, .voice-note, .admin-bar, .browser-widget').forEach(el => {
                    el.style.top = (el.offsetTop + shift) + 'px';
                });
                state.adminBarTop += shift;
                state.initialScrollTop += shift;
                needsUpdate = true;
            }
            
            if (needsUpdate) {
                content.style.width = WORKSPACE_WIDTH + 'px';
                content.style.height = WORKSPACE_HEIGHT + 'px';
            }
        }

        function positionElements() {
            const centerX = WORKSPACE_WIDTH / 2, centerY = 300;
            state.initialScrollLeft = centerX - window.innerWidth / 2;
            state.initialScrollTop = centerY - 100;

            const bar = document.getElementById('adminBar');
            state.adminBarLeft = centerX - BAR_WIDTH / 2;
            state.adminBarTop = centerY;
            bar.style.left = state.adminBarLeft + 'px';
            bar.style.top = state.adminBarTop + 'px';

            const barBottom = centerY + 60, startX = centerX - BAR_WIDTH / 2;
            const gap = 20; // Consistent spacing

            const widgets = [
                { id: 'widgetTasks', x: 0, y: 0 },
                { id: 'widgetCalendar', x: 470, y: 0 },
                { id: 'widgetEmail', x: 940, y: 0 },
                { id: 'widgetChat', x: 470, y: 540 }
            ];

            widgets.forEach(w => {
                const el = document.getElementById(w.id);
                el.style.left = (startX + w.x) + 'px';
                el.style.top = (barBottom + w.y) + 'px';
                el.style.width = widgetSizes[w.id].width + 'px';
                el.style.height = widgetSizes[w.id].height + 'px';
            });
            
            // Make existing voice notes draggable
            document.querySelectorAll('.voice-note').forEach(note => {
                makeVoiceNoteDraggable(note);
            });
        }

        function centerView() {
            const ws = document.getElementById('workspace');
            ws.scrollLeft = state.initialScrollLeft;
            ws.scrollTop = state.initialScrollTop;
        }

        function showMiniMap() {
            const mm = document.getElementById('miniMap');
            mm.classList.add('visible');
            updateMiniMap();
            clearTimeout(state.miniMapTimeout);
            state.miniMapTimeout = setTimeout(() => mm.classList.remove('visible'), 2000);
        }

        function updateMiniMap() {
            const ws = document.getElementById('workspace');
            const content = document.getElementById('miniMapContent');
            const vp = document.getElementById('miniMapViewport');
            
            // Use fixed scale based on total workspace size (not affected by zoom)
            const mapWidth = 180;
            const mapHeight = 100;
            const scaleX = mapWidth / WORKSPACE_WIDTH;
            const scaleY = mapHeight / WORKSPACE_HEIGHT;
            
            // Calculate visible area size (affected by zoom - smaller zoom = larger visible area)
            const visibleWidth = window.innerWidth / state.zoom;
            const visibleHeight = window.innerHeight / state.zoom;
            
            // Viewport position based on scroll
            const scrollX = ws.scrollLeft / state.zoom;
            const scrollY = ws.scrollTop / state.zoom;
            
            // Update viewport
            vp.style.width = Math.max(10, visibleWidth * scaleX) + 'px';
            vp.style.height = Math.max(8, visibleHeight * scaleY) + 'px';
            vp.style.left = Math.max(0, scrollX * scaleX) + 'px';
            vp.style.top = Math.max(0, scrollY * scaleY) + 'px';
            
            // Update zoom slider
            const zoomPercent = ((state.zoom - 0.2) / (2.0 - 0.2)) * 100;
            const zoomFill = document.getElementById('zoomTrackFill');
            const zoomHandle = document.getElementById('zoomHandle');
            if (zoomFill) zoomFill.style.width = zoomPercent + '%';
            if (zoomHandle) zoomHandle.style.left = zoomPercent + '%';
            
            // Remove old widget indicators
            content.querySelectorAll('.mini-map-widget').forEach(w => w.remove());
            
            // Widget colors for minimap (corrected IDs)
            const widgetColors = {
                'widgetEmail': '#4EB4F9',
                'widgetTasks': '#50DC78',
                'widgetCalendar': '#FFB84D',
                'widgetChat': '#8B5CF6'
            };
            
            // Add widget indicators
            document.querySelectorAll('.widget.visible').forEach(widget => {
                // Get widget position from style (absolute position in content)
                const widgetLeft = parseInt(widget.style.left) || 0;
                const widgetTop = parseInt(widget.style.top) || 0;
                const widgetWidth = parseInt(widget.style.width) || 300;
                const widgetHeight = parseInt(widget.style.height) || 400;
                
                const indicator = document.createElement('div');
                indicator.className = 'mini-map-widget';
                indicator.style.left = (widgetLeft * scaleX) + 'px';
                indicator.style.top = (widgetTop * scaleY) + 'px';
                indicator.style.width = Math.max(6, widgetWidth * scaleX) + 'px';
                indicator.style.height = Math.max(4, widgetHeight * scaleY) + 'px';
                indicator.style.background = widgetColors[widget.id] || '#888';
                indicator.style.border = '1px solid ' + (widgetColors[widget.id] || '#888');
                indicator.style.boxSizing = 'border-box';
                
                content.appendChild(indicator);
            });
            
            // Add sticky note indicators
            document.querySelectorAll('.sticky-note.visible').forEach(note => {
                const noteLeft = parseInt(note.style.left) || 0;
                const noteTop = parseInt(note.style.top) || 0;
                
                const indicator = document.createElement('div');
                indicator.className = 'mini-map-widget';
                indicator.style.left = (noteLeft * scaleX) + 'px';
                indicator.style.top = (noteTop * scaleY) + 'px';
                indicator.style.width = '5px';
                indicator.style.height = '4px';
                indicator.style.background = '#FEF3C7';
                
                content.appendChild(indicator);
            });
            
            // Add voice note indicators
            document.querySelectorAll('.voice-note.visible').forEach(note => {
                const noteLeft = parseInt(note.style.left) || 0;
                const noteTop = parseInt(note.style.top) || 0;
                
                const indicator = document.createElement('div');
                indicator.className = 'mini-map-widget';
                indicator.style.left = (noteLeft * scaleX) + 'px';
                indicator.style.top = (noteTop * scaleY) + 'px';
                indicator.style.width = '5px';
                indicator.style.height = '4px';
                indicator.style.background = '#4EB4F9';
                
                content.appendChild(indicator);
            });
            
            // Add browser widget indicators
            document.querySelectorAll('.widget[data-is-browser="true"]').forEach(bw => {
                if (bw.style.display === 'none') return;
                const bwLeft = parseInt(bw.style.left) || 0;
                const bwTop = parseInt(bw.style.top) || 0;
                
                const indicator = document.createElement('div');
                indicator.className = 'mini-map-widget';
                indicator.style.left = (bwLeft * scaleX) + 'px';
                indicator.style.top = (bwTop * scaleY) + 'px';
                indicator.style.width = '8px';
                indicator.style.height = '6px';
                indicator.style.background = '#818CF8';
                indicator.style.borderRadius = '2px';
                
                content.appendChild(indicator);
            });
        }
        
        // Zoom slider click handler
        function handleZoomSliderClick(event) {
            const track = event.currentTarget;
            const rect = track.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            
            // Map 0-1 to 0.2-2.0
            state.zoom = 0.2 + (percent * 1.8);
            state.zoom = Math.max(0.2, Math.min(2.0, state.zoom));
            applyZoom();
        }

        function zoomIn() { if (state.zoom < 2.0) { state.zoom = Math.min(2.0, state.zoom + 0.1); applyZoom(); } }
        function zoomOut() { if (state.zoom > 0.2) { state.zoom = Math.max(0.2, state.zoom - 0.1); applyZoom(); } }
        function applyZoom() {
            document.getElementById('workspaceContent').style.transform = `scale(${state.zoom})`;
            document.getElementById('zoomDisplay').textContent = Math.round(state.zoom * 100) + '%';
            showMiniMap();
        }
        
        // Zoom to cursor position (Ctrl/Cmd + scroll)
        document.getElementById('workspace').addEventListener('wheel', (e) => {
            if (e.ctrlKey || e.metaKey) {
                e.preventDefault();
                
                const workspace = document.getElementById('workspace');
                const content = document.getElementById('workspaceContent');
                
                // Get cursor position relative to workspace
                const rect = workspace.getBoundingClientRect();
                const cursorX = e.clientX - rect.left + workspace.scrollLeft;
                const cursorY = e.clientY - rect.top + workspace.scrollTop;
                
                // Calculate position in content space before zoom
                const contentX = cursorX / state.zoom;
                const contentY = cursorY / state.zoom;
                
                // Apply zoom
                const delta = e.deltaY > 0 ? -0.05 : 0.05;
                const oldZoom = state.zoom;
                state.zoom = Math.max(0.2, Math.min(2.0, state.zoom + delta));
                
                // Apply transform
                content.style.transform = `scale(${state.zoom})`;
                document.getElementById('zoomDisplay').textContent = Math.round(state.zoom * 100) + '%';
                
                // Calculate new scroll position to keep cursor point fixed
                const newCursorX = contentX * state.zoom;
                const newCursorY = contentY * state.zoom;
                
                workspace.scrollLeft = newCursorX - (e.clientX - rect.left);
                workspace.scrollTop = newCursorY - (e.clientY - rect.top);
                
                showMiniMap();
            }
        }, { passive: false });
        
        // ═══════════════════════════════════════════════════════════════
        // WORKSPACE PANNING (drag to pan)
        // ═══════════════════════════════════════════════════════════════
        
        let isPanning = false;
        let panStartX = 0;
        let panStartY = 0;
        let panScrollLeft = 0;
        let panScrollTop = 0;
        
        document.getElementById('workspace').addEventListener('mousedown', (e) => {
            // Only pan if clicking directly on workspace background (not on widgets or admin bar)
            if (e.target.closest('.widget, .admin-bar, .voice-note, .sticky-note, .workspace-controls, .context-menu')) return;
            
            isPanning = true;
            panStartX = e.clientX;
            panStartY = e.clientY;
            panScrollLeft = document.getElementById('workspace').scrollLeft;
            panScrollTop = document.getElementById('workspace').scrollTop;
            
            document.getElementById('workspace').classList.add('panning');
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isPanning) return;
            
            e.preventDefault();
            const dx = e.clientX - panStartX;
            const dy = e.clientY - panStartY;
            
            const workspace = document.getElementById('workspace');
            workspace.scrollLeft = panScrollLeft - dx;
            workspace.scrollTop = panScrollTop - dy;
            
            showMiniMap();
        });
        
        document.addEventListener('mouseup', () => {
            if (isPanning) {
                isPanning = false;
                document.getElementById('workspace').classList.remove('panning');
            }
        });

        async function toggleModule() {
            state.isActive = !state.isActive;
            const bar = document.getElementById('adminBar');
            bar.classList.toggle('active', state.isActive);
            bar.classList.toggle('inactive', !state.isActive);
            document.querySelectorAll('.widget').forEach(w => {
                // Use display for browser widgets, visible class for others
                if (w.dataset.isBrowser === 'true') {
                    w.style.display = state.isActive ? 'flex' : 'none';
                } else {
                    w.classList.toggle('visible', state.isActive);
                }
            });
            document.querySelectorAll('.voice-note').forEach(n => n.classList.toggle('visible', state.isActive));
            
            // Auto-sync all data when activating
            if (state.isActive) {
                await syncAllData();
                initSupabaseRealtime();
            } else {
                // Disconnect realtime when deactivating
                if (realtimeChannel) {
                    realtimeChannel.unsubscribe();
                    isRealtimeConnected = false;
                    const indicator = document.getElementById('realtimeIndicator');
                    if (indicator) {
                        indicator.classList.remove('connecting', 'connected');
                        indicator.title = 'Realtime: Disconnected';
                    }
                }
            }
        }
        
        // ============================================
        // WORKSPACE FULLSCREEN
        // ============================================
        function toggleWorkspaceFullscreen(e) {
            if (e) e.stopPropagation();
            
            const elem = document.documentElement;
            const btn = document.querySelector('.admin-bar-fullscreen-btn');
            
            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                // Enter fullscreen
                if (elem.requestFullscreen) {
                    elem.requestFullscreen();
                } else if (elem.webkitRequestFullscreen) {
                    elem.webkitRequestFullscreen();
                } else if (elem.mozRequestFullScreen) {
                    elem.mozRequestFullScreen();
                } else if (elem.msRequestFullscreen) {
                    elem.msRequestFullscreen();
                }
                document.body.classList.add('workspace-fullscreen');
                if (btn) {
                    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M4 14h6v6M20 10h-6V4M14 10l7-7M3 21l7-7"/></svg>';
                    btn.title = 'Exit Fullscreen';
                }
            } else {
                // Exit fullscreen
                if (document.exitFullscreen) {
                    document.exitFullscreen();
                } else if (document.webkitExitFullscreen) {
                    document.webkitExitFullscreen();
                } else if (document.mozCancelFullScreen) {
                    document.mozCancelFullScreen();
                } else if (document.msExitFullscreen) {
                    document.msExitFullscreen();
                }
                document.body.classList.remove('workspace-fullscreen');
                if (btn) {
                    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>';
                    btn.title = 'Fullscreen';
                }
            }
        }
        
        // Handle fullscreen change from browser (ESC key, etc.)
        document.addEventListener('fullscreenchange', handleFullscreenChange);
        document.addEventListener('webkitfullscreenchange', handleFullscreenChange);
        document.addEventListener('mozfullscreenchange', handleFullscreenChange);
        document.addEventListener('MSFullscreenChange', handleFullscreenChange);
        
        function handleFullscreenChange() {
            const btn = document.querySelector('.admin-bar-fullscreen-btn');
            if (!document.fullscreenElement && !document.webkitFullscreenElement && !document.mozFullScreenElement && !document.msFullscreenElement) {
                document.body.classList.remove('workspace-fullscreen');
                if (btn) {
                    btn.innerHTML = '<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>';
                    btn.title = 'Fullscreen';
                }
            }
        }
        
        // Double-click on admin bar for fullscreen
        document.getElementById('adminBar').addEventListener('dblclick', function(e) {
            // Don't trigger on sphere or buttons
            if (e.target.closest('.admin-sphere') || e.target.closest('button')) return;
            toggleWorkspaceFullscreen(e);
        });
        
        // ============================================
        // MASTER SYNC - Load all data from Supabase
        // ============================================
        async function syncAllData() {
            const sphere = document.getElementById('adminSphere');
            sphere.classList.add('syncing');
            
            try {
                // Sync all modules in parallel
                await Promise.all([
                    loadEmails(false),  // Load emails without triggering N8N
                    loadTasks(),        // Load tasks
                    loadCalendarEvents(), // Load calendar
                    loadStickyNotes(),  // Load sticky notes
                    loadVoiceNotes()    // Load voice notes
                ]);
                
                showToast('All data synced ✓');
            } catch (error) {
                console.error('Sync error:', error);
                showToast('Sync failed - check connection');
            } finally {
                sphere.classList.remove('syncing');
            }
        }
        
        // ============================================
        // SUPABASE REALTIME - Auto-update UI
        // ============================================
        function initSupabaseRealtime() {
            if (isRealtimeConnected || typeof supabase === 'undefined') return;
            
            // Show connecting state
            const indicator = document.getElementById('realtimeIndicator');
            if (indicator) {
                indicator.classList.add('connecting');
                indicator.title = 'Realtime: Connecting...';
            }
            
            try {
                const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                
                realtimeChannel = supabaseClient
                    .channel('pulse-realtime')
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'emails'
                    }, handleEmailChange)
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'tasks'
                    }, handleTaskChange)
                    .on('postgres_changes', {
                        event: '*',
                        schema: 'public',
                        table: 'calendar_events'
                    }, handleCalendarChange)
                    .subscribe((status) => {
                        const indicator = document.getElementById('realtimeIndicator');
                        if (status === 'SUBSCRIBED') {
                            isRealtimeConnected = true;
                            console.log('✓ Realtime connected');
                            if (indicator) {
                                indicator.classList.remove('connecting');
                                indicator.classList.add('connected');
                                indicator.title = 'Realtime: Connected';
                            }
                        } else if (status === 'CLOSED' || status === 'CHANNEL_ERROR') {
                            isRealtimeConnected = false;
                            console.log('✗ Realtime disconnected');
                            if (indicator) {
                                indicator.classList.remove('connecting', 'connected');
                                indicator.title = 'Realtime: Disconnected';
                            }
                        }
                    });
            } catch (error) {
                console.error('Realtime init error:', error);
                const indicator = document.getElementById('realtimeIndicator');
                if (indicator) {
                    indicator.classList.remove('connecting', 'connected');
                    indicator.title = 'Realtime: Error';
                }
            }
        }
        
        // Handle real-time email changes
        function handleEmailChange(payload) {
            console.log('Email change:', payload.eventType, payload);
            
            if (payload.eventType === 'INSERT') {
                // New email arrived
                const email = payload.new;
                state.emails.unshift(email);
                if (!email.is_read) globalUnreadCount++;
                renderEmails();
                updateStats();
                showToast(`New email from ${email.sender_name || 'Unknown'}`);
            } 
            else if (payload.eventType === 'UPDATE') {
                // Email updated (read, archived, etc.)
                const idx = state.emails.findIndex(e => e.id === payload.new.id);
                if (idx !== -1) {
                    const wasUnread = !state.emails[idx].is_read;
                    const isNowRead = payload.new.is_read;
                    state.emails[idx] = payload.new;
                    
                    // Update unread count
                    if (wasUnread && isNowRead) globalUnreadCount--;
                    else if (!wasUnread && !isNowRead) globalUnreadCount++;
                    
                    renderEmails();
                    updateStats();
                }
            }
            else if (payload.eventType === 'DELETE') {
                // Email deleted
                const idx = state.emails.findIndex(e => e.id === payload.old.id);
                if (idx !== -1) {
                    if (!state.emails[idx].is_read) globalUnreadCount--;
                    state.emails.splice(idx, 1);
                    renderEmails();
                    updateStats();
                }
            }
        }
        
        // Handle real-time task changes
        function handleTaskChange(payload) {
            console.log('Task change:', payload.eventType, payload);
            loadTasks(); // Reload tasks for simplicity
        }
        
        // Handle real-time calendar changes
        function handleCalendarChange(payload) {
            console.log('Calendar change:', payload.eventType, payload);
            loadCalendarEvents(); // Reload calendar for simplicity
        }
        
        // ============================================
        // LOAD TASKS FROM SUPABASE
        // ============================================
        async function loadTasks() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/tasks?order=due_date.asc&limit=20`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (response.ok) {
                    const tasks = await response.json();
                    renderTasks(tasks);
                } else {
                    console.log('Tasks table may not exist yet');
                }
            } catch (error) {
                console.log('Load tasks skipped:', error.message);
            }
        }
        
        function renderTasks(tasks) {
            // For now, just log - full task rendering in Phase 2
            console.log('Tasks loaded:', tasks.length);
            // The task widget currently has static content
            // Dynamic task rendering will be implemented in Phase 2
        }
        
        async function toggleTaskComplete(taskId) {
            try {
                // Get current task
                const task = await fetch(`${SUPABASE_URL}/rest/v1/tasks?id=eq.${taskId}`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                }).then(r => r.json()).then(arr => arr[0]);
                
                // Toggle status
                const newStatus = task.status === 'completed' ? 'pending' : 'completed';
                
                await fetch(`${SUPABASE_URL}/rest/v1/tasks?id=eq.${taskId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ status: newStatus, updated_at: new Date().toISOString() })
                });
                
                showToast(newStatus === 'completed' ? 'Task completed ✓' : 'Task reopened');
            } catch (error) {
                console.error('Toggle task error:', error);
            }
        }
        
        // ============================================
        // LOAD CALENDAR EVENTS FROM SUPABASE
        // ============================================
        async function loadCalendarEvents() {
            try {
                const today = new Date().toISOString().split('T')[0];
                const response = await fetch(`${SUPABASE_URL}/rest/v1/calendar_events?start_time=gte.${today}&order=start_time.asc&limit=10`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (response.ok) {
                    const events = await response.json();
                    renderCalendarEvents(events);
                } else {
                    console.log('Calendar events table may not exist yet');
                }
            } catch (error) {
                console.log('Load calendar skipped:', error.message);
            }
        }
        
        function renderCalendarEvents(events) {
            // For now, just log - full calendar rendering in Phase 2
            console.log('Calendar events loaded:', events.length);
            // The calendar widget currently has static content
            // Dynamic event rendering will be implemented in Phase 2
        }
        
        function formatDate(dateStr) {
            const date = new Date(dateStr);
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            if (date.toDateString() === today.toDateString()) return 'Today';
            if (date.toDateString() === tomorrow.toDateString()) return 'Tomorrow';
            return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
        }

        let draggedWidget = null, widgetStartX, widgetStartY, widgetOffsetX, widgetOffsetY, hasDragged = false;

        function startWidgetDrag(e, widgetId) {
            e.stopPropagation();
            draggedWidget = document.getElementById(widgetId);
            bringToFront(widgetId);
            draggedWidget.classList.add('dragging');
            hasDragged = false;
            widgetStartX = e.clientX; widgetStartY = e.clientY;
            widgetOffsetX = draggedWidget.offsetLeft; widgetOffsetY = draggedWidget.offsetTop;
            document.addEventListener('mousemove', onWidgetDrag);
            document.addEventListener('mouseup', stopWidgetDrag);
        }

        function onWidgetDrag(e) {
            if (!draggedWidget) return;
            const dx = (e.clientX - widgetStartX) / state.zoom;
            const dy = (e.clientY - widgetStartY) / state.zoom;
            if (Math.abs(dx) > 5 || Math.abs(dy) > 5) hasDragged = true;
            draggedWidget.style.left = (widgetOffsetX + dx) + 'px';
            draggedWidget.style.top = (widgetOffsetY + dy) + 'px';
            showMiniMap();
        }

        function stopWidgetDrag() {
            if (draggedWidget) draggedWidget.classList.remove('dragging');
            draggedWidget = null;
            document.removeEventListener('mousemove', onWidgetDrag);
            document.removeEventListener('mouseup', stopWidgetDrag);
        }

        function initDraggable() {
            state.voiceNotes.forEach(id => makeDraggable(document.getElementById(id)));

            const bar = document.getElementById('adminBar');
            let isDraggingBar = false, bsx, bsy, box, boy;
            let elementOffsets = []; // Store ALL element positions relative to bar
            
            bar.addEventListener('mousedown', e => {
                if (e.target.closest('.admin-sphere') || e.target.closest('button')) return;
                isDraggingBar = true; 
                bsx = e.clientX; 
                bsy = e.clientY;
                box = bar.offsetLeft; 
                boy = bar.offsetTop;
                
                // Store relative positions of ALL elements in workspace
                elementOffsets = [];
                
                // Get all widgets (including browser widgets using widget class)
                document.querySelectorAll('.widget').forEach(w => {
                    // Skip fullscreen widgets (they're attached to body)
                    if (!w.classList.contains('fullscreen')) {
                        elementOffsets.push({
                            el: w,
                            offsetX: w.offsetLeft - bar.offsetLeft,
                            offsetY: w.offsetTop - bar.offsetTop
                        });
                    }
                });
                
                // Get all voice notes
                document.querySelectorAll('.voice-note').forEach(w => {
                    elementOffsets.push({
                        el: w,
                        offsetX: w.offsetLeft - bar.offsetLeft,
                        offsetY: w.offsetTop - bar.offsetTop
                    });
                });
                
                // Get all sticky notes
                document.querySelectorAll('.sticky-note').forEach(w => {
                    elementOffsets.push({
                        el: w,
                        offsetX: w.offsetLeft - bar.offsetLeft,
                        offsetY: w.offsetTop - bar.offsetTop
                    });
                });
                
                // Get old-style browser widgets (if any)
                document.querySelectorAll('.browser-widget:not(.widget)').forEach(w => {
                    if (!w.classList.contains('fullscreen')) {
                        elementOffsets.push({
                            el: w,
                            offsetX: w.offsetLeft - bar.offsetLeft,
                            offsetY: w.offsetTop - bar.offsetTop
                        });
                    }
                });
            });
            
            document.addEventListener('mousemove', e => {
                if (!isDraggingBar) return;
                const deltaX = (e.clientX - bsx) / state.zoom;
                const deltaY = (e.clientY - bsy) / state.zoom;
                const newLeft = box + deltaX;
                const newTop = boy + deltaY;
                
                // Move bar
                bar.style.left = newLeft + 'px';
                bar.style.top = newTop + 'px';
                state.adminBarLeft = newLeft;
                state.adminBarTop = newTop;
                
                // Move ALL elements maintaining their relative positions
                elementOffsets.forEach(item => {
                    item.el.style.left = (newLeft + item.offsetX) + 'px';
                    item.el.style.top = (newTop + item.offsetY) + 'px';
                });
                
                showMiniMap();
                expandWorkspaceIfNeeded(newLeft, newTop, BAR_WIDTH, 48);
            });
            
            document.addEventListener('mouseup', () => {
                if (isDraggingBar) {
                    isDraggingBar = false;
                    elementOffsets = [];
                    // Update positions in database for browser widgets
                    document.querySelectorAll('.browser-widget-instance').forEach(w => {
                        updateBrowserWidgetPos(w.id, w.offsetLeft, w.offsetTop);
                    });
                }
            });
        }

        function makeDraggable(el) {
            let isDragging = false, sx, sy, ox, oy;
            el.addEventListener('mousedown', e => {
                if (e.target.closest('button') || e.button === 2) return;
                isDragging = true; sx = e.clientX; sy = e.clientY;
                ox = el.offsetLeft; oy = el.offsetTop;
            });
            document.addEventListener('mousemove', e => {
                if (!isDragging) return;
                el.style.left = (ox + (e.clientX - sx) / state.zoom) + 'px';
                el.style.top = (oy + (e.clientY - sy) / state.zoom) + 'px';
            });
            document.addEventListener('mouseup', () => isDragging = false);
        }

        // Track double-click timing for widgets
        let widgetClickTimeout = null;
        let widgetClickCount = 0;
        let lastClickedWidget = null;
        
        function handleWidgetClick(e, widgetId) {
            if (e.target.closest('button, input, textarea, .task-card, .task-mini, .calendar-tab, .calendar-nav-btn, .calendar-event, .email-item, .email-tab, .filter-option, .quick-action-chip, .email-drawer, .ai-reply-section, .email-search-row, .email-list, .email-header, .email-summary')) return;
            if (hasDragged) { hasDragged = false; return; }
            
            // Always bring to front on any click
            bringToFront(widgetId);
        }
        
        // Handle drag zone clicks - double click to expand OR collapse
        function handleDragZoneClick(e, widgetId) {
            e.stopPropagation();
            
            // Always bring to front
            bringToFront(widgetId);
            
            const widget = document.getElementById(widgetId);
            const isExpanded = widget.classList.contains('expanded') || widget.classList.contains('fullscreen');
            
            // Track clicks for double-click detection
            if (lastClickedWidget !== widgetId) {
                widgetClickCount = 0;
                lastClickedWidget = widgetId;
            }
            
            widgetClickCount++;
            
            if (widgetClickCount === 1) {
                // Wait to see if it's a double click
                widgetClickTimeout = setTimeout(() => {
                    // Single click - do nothing, just bring to front (already done)
                    widgetClickCount = 0;
                }, 250);
            } else if (widgetClickCount === 2) {
                // Double click - toggle expand/collapse
                clearTimeout(widgetClickTimeout);
                if (isExpanded) {
                    collapseWidgetById(widgetId);
                } else {
                    expandWidget(widgetId);
                }
                widgetClickCount = 0;
            }
        }

        function toggleWidgetExpand(widgetId) {
            const widget = document.getElementById(widgetId);
            if (widget.classList.contains('expanded')) {
                collapseWidgetById(widgetId);
            } else {
                expandWidget(widgetId);
            }
        }

        function expandWidget(widgetId) {
            const widget = document.getElementById(widgetId);
            
            // Save current position/size before expanding
            widget.dataset.originalLeft = widget.style.left;
            widget.dataset.originalTop = widget.style.top;
            widget.dataset.originalWidth = widget.style.width;
            widget.dataset.originalHeight = widget.style.height;
            
            // Expand IN PLACE - keep same position, just grow
            widget.style.width = '1200px';
            widget.style.height = '850px';
            // Don't change position - expand from current location
            widget.classList.add('expanded');
            bringToFront(widgetId);
        }

        function collapseWidget(e, widgetId) {
            e.stopPropagation();
            collapseWidgetById(widgetId);
        }

        function collapseWidgetById(widgetId) {
            const widget = document.getElementById(widgetId);
            
            // Collapse IN PLACE - keep current position, just shrink
            // Get default size for this widget type
            const defaultSize = widgetSizes[widgetId] || { width: 450, height: 520 };
            widget.style.width = defaultSize.width + 'px';
            widget.style.height = defaultSize.height + 'px';
            // Don't change position - collapse at current location
            
            widget.classList.remove('expanded');
            widget.classList.remove('fullscreen');
            closeEmailDrawer();
        }

        function toggleFullscreen(e, widgetId) {
            e.stopPropagation();
            const widget = document.getElementById(widgetId);
            const controls = document.getElementById('workspaceControls');
            const workspaceContent = document.getElementById('workspaceContent');
            
            if (widget.classList.contains('fullscreen')) {
                // Exit fullscreen - move back to workspace content
                workspaceContent.appendChild(widget);
                widget.classList.remove('fullscreen');
                controls.style.display = 'flex';
                widget.style.position = 'absolute';
                widget.style.transform = '';
                
                // Restore to SAVED position (where widget was before fullscreen)
                if (widget.dataset.preFullscreenLeft) {
                    widget.style.left = widget.dataset.preFullscreenLeft;
                    widget.style.top = widget.dataset.preFullscreenTop;
                    widget.style.width = widget.dataset.preFullscreenWidth;
                    widget.style.height = widget.dataset.preFullscreenHeight;
                    if (widget.dataset.preFullscreenExpanded === 'true') {
                        widget.classList.add('expanded');
                    }
                }
            } else {
                // Save current state before going fullscreen
                widget.dataset.preFullscreenLeft = widget.style.left;
                widget.dataset.preFullscreenTop = widget.style.top;
                widget.dataset.preFullscreenWidth = widget.style.width;
                widget.dataset.preFullscreenHeight = widget.style.height;
                widget.dataset.preFullscreenExpanded = widget.classList.contains('expanded') ? 'true' : 'false';
                
                // Enter fullscreen - move to body to escape transform scale
                document.body.appendChild(widget);
                widget.classList.remove('expanded');
                widget.classList.add('fullscreen');
                widget.style.transform = 'none';
                controls.style.display = 'none';
            }
        }

        // Email options dropdown functions
        function toggleEmailOptions() {
            const menu = document.getElementById('emailOptionsMenu');
            menu.classList.toggle('active');
            
            const closeMenu = (e) => {
                if (!e.target.closest('.email-options-dropdown')) {
                    menu.classList.remove('active');
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 10);
        }
        
        function closeEmailOptions() {
            document.getElementById('emailOptionsMenu').classList.remove('active');
        }
        
        function createMeeting() {
            showToast('Create meeting feature coming soon');
        }

        // Email functions
        function switchEmailTab(tab, buttonElement = null) {
            document.querySelectorAll('.email-tab').forEach(t => t.classList.remove('active'));
            
            // Find the correct button to highlight
            if (buttonElement) {
                buttonElement.classList.add('active');
            } else if (event && event.target) {
                event.target.closest('.email-tab')?.classList.add('active');
            } else {
                // Find by tab name
                const buttons = document.querySelectorAll('.email-tab');
                const tabIndex = tab === 'inbox' ? 0 : (tab === 'sent' ? 1 : 2);
                buttons[tabIndex]?.classList.add('active');
            }
            
            const toggle = document.getElementById('emailFilterToggle');
            toggle.style.display = tab === 'inbox' ? 'flex' : 'none';
            state.currentTab = tab;
            
            // For archive/sent tabs, always do a fresh fetch
            loadEmails(false);
        }

        function switchFilter(filter) {
            document.querySelectorAll('.filter-option').forEach(o => o.classList.remove('active'));
            event.target.classList.add('active');
            state.currentFilter = filter;
            renderEmails();
        }

        // Load emails from Supabase
        // Store global unread count (not affected by tab switches)
        let globalUnreadCount = 0;
        
        async function loadEmails(triggerSync = false) {
            const list = document.getElementById('emailList');
            
            // Show loading state
            list.innerHTML = '<div class="email-loading"><div class="email-loading-spinner"></div><span>Loading emails...</span></div>';
            state.isLoadingEmails = true;
            
            try {
                // Trigger N8N webhook to sync emails from Gmail (fire and forget)
                if (triggerSync && N8N_WEBHOOK_URL) {
                    list.innerHTML = '<div class="email-loading"><div class="email-loading-spinner"></div><span>Syncing with Gmail...</span></div>';
                    
                    // Fire and forget - don't wait for sync to complete
                    fetch(N8N_WEBHOOK_URL, { 
                        method: 'POST',
                        mode: 'no-cors',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ action: 'sync', timestamp: Date.now() })
                    }).catch(err => console.log('Sync triggered (background)', err));
                    
                    // Wait a bit for sync to start processing
                    await new Promise(resolve => setTimeout(resolve, 2000));
                }
                
                list.innerHTML = '<div class="email-loading"><div class="email-loading-spinner"></div><span>Loading emails...</span></div>';
                
                // Fetch all emails from Supabase
                const response = await fetch(`${SUPABASE_URL}/rest/v1/emails?select=*&order=received_at.desc`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Cache-Control': 'no-cache'
                    }
                });
                
                if (!response.ok) throw new Error('Failed to fetch emails');
                
                const allEmails = await response.json();
                console.log(`Loaded ${allEmails.length} emails from Supabase`);
                
                // Filter based on current tab
                const tab = state.currentTab || 'inbox';
                if (tab === 'archive') {
                    state.emails = allEmails.filter(e => e.status === 'archived');
                } else if (tab === 'sent') {
                    state.emails = allEmails.filter(e => e.status === 'sent');
                } else {
                    // Inbox: show all non-archived, non-sent emails
                    state.emails = allEmails.filter(e => e.status !== 'archived' && e.status !== 'sent');
                }
                
                console.log(`Showing ${state.emails.length} emails in ${tab} tab`);
                
                // Update global unread count (only count inbox unread)
                if (tab === 'inbox') {
                    globalUnreadCount = state.emails.filter(e => !e.is_read).length;
                }
                
                // Load drafts to mark emails with pending drafts
                await loadDrafts();
                
                renderEmails();
                updateStats();
                
            } catch (error) {
                console.error('Error loading emails:', error);
                list.innerHTML = `<div class="email-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
                    <span>Could not load emails<br><small style="opacity:0.5">Check Supabase config</small></span>
                </div>`;
            } finally {
                state.isLoadingEmails = false;
            }
        }

        // Load drafts to mark emails with pending drafts
        async function loadDrafts() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/drafts?status=eq.draft&select=reply_to_id`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                const drafts = await response.json();
                
                // Create a set of email IDs that have drafts
                state.emailsWithDrafts = new Set(drafts.map(d => d.reply_to_id).filter(id => id));
                console.log('Emails with drafts:', state.emailsWithDrafts.size);
            } catch (error) {
                console.error('Error loading drafts:', error);
                state.emailsWithDrafts = new Set();
            }
        }

        // Render email list (matching Supabase table structure)
        function renderEmails() {
            const list = document.getElementById('emailList');
            
            // For archive tab, show ALL archived emails (no sub-filter)
            // For inbox tab, apply focused/reply/others filter
            let filtered;
            if (state.currentTab === 'archive' || state.currentTab === 'sent') {
                // No filtering for archive/sent - show all
                filtered = state.emails;
            } else {
                // Apply focused/reply/others filter for inbox
                // P3 emails ALWAYS go to Others, never in Focused or Needs Reply
                // P1/P2 can be in Focused or Needs Reply
                filtered = state.emails.filter(e => {
                    const priority = e.priority || 3;
                    if (state.currentFilter === 'focused') {
                        // Focused = P1 or P2 only (never P3)
                        return priority === 1 || priority === 2;
                    }
                    if (state.currentFilter === 'reply') {
                        // Needs Reply = unread P1/P2 emails
                        return !e.is_read && (priority === 1 || priority === 2);
                    }
                    // Others = P3 or anything not fitting above criteria
                    return priority === 3 || priority > 3;
                });
            }
            
            if (filtered.length === 0) {
                list.innerHTML = `<div class="email-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"/></svg>
                    <span>No ${state.currentFilter} emails</span>
                </div>`;
                return;
            }
            
            // Group emails by date: Today, Yesterday, Earlier
            const now = new Date();
            const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
            
            const groups = { today: [], yesterday: [], earlier: [] };
            filtered.forEach(email => {
                const emailDate = new Date(email.received_at);
                const emailDay = new Date(emailDate.getFullYear(), emailDate.getMonth(), emailDate.getDate());
                if (emailDay.getTime() >= today.getTime()) {
                    groups.today.push(email);
                } else if (emailDay.getTime() >= yesterday.getTime()) {
                    groups.yesterday.push(email);
                } else {
                    groups.earlier.push(email);
                }
            });
            
            // Render email row
            const renderEmailRow = (email) => {
                const emailIndex = state.emails.indexOf(email);
                const priorityClass = email.priority === 1 ? 'p1' : (email.priority === 2 ? 'p2' : 'p3');
                const categoryName = (email.category || 'fyi').toLowerCase().replace(/\s+/g, '');
                const hasDraft = state.emailsWithDrafts && state.emailsWithDrafts.has(email.gmail_id);
                
                // Check for actual attachments - handle both array and JSON string
                let attachmentsArray = email.attachments || [];
                if (typeof attachmentsArray === 'string') {
                    try {
                        attachmentsArray = JSON.parse(attachmentsArray);
                    } catch (e) {
                        attachmentsArray = [];
                    }
                }
                // Only show attachment icon if there are actual attachment items
                const hasAttachment = Array.isArray(attachmentsArray) && attachmentsArray.length > 0;
                
                let timeDisplay = '';
                if (email.received_at) {
                    const emailDate = new Date(email.received_at);
                    const diffHours = (now - emailDate) / (1000 * 60 * 60);
                    if (diffHours < 24) {
                        timeDisplay = emailDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                    } else if (diffHours < 48) {
                        timeDisplay = 'Yesterday';
                    } else {
                        timeDisplay = emailDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                    }
                }
                
                const attachmentIcon = hasAttachment ? '<span class="email-attachment-icon" title="Has attachment"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:12px;height:12px;vertical-align:middle;margin-left:4px;opacity:0.5;"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg></span>' : '';
                
                return `
                <div class="email-item ${priorityClass} ${email.is_read ? 'read' : 'unread'}" onclick="event.stopPropagation(); openEmailByIndex(${emailIndex})" data-email-id="${email.gmail_id}" data-email-index="${emailIndex}">
                    <div class="email-checkbox" onclick="event.stopPropagation(); toggleEmailSelect(${emailIndex})">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><polyline points="20 6 9 17 4 12"/></svg>
                    </div>
                    <div class="email-content">
                        <span class="email-sender">${escapeHtml(email.sender_name || 'Unknown')}</span>
                        <span class="email-tags-group">
                            <span class="email-tag category ${categoryName}">${(email.category || 'fyi').toLowerCase()}</span>
                            ${hasDraft ? '<span class="email-tag draft-tag">DRAFT</span>' : ''}
                            ${attachmentIcon}
                        </span>
                        <span class="email-subject">${escapeHtml(email.subject || 'No Subject')}</span>
                        <span class="email-preview">${escapeHtml(getCleanPreview(email))}</span>
                    </div>
                    <span class="email-time">${timeDisplay}</span>
                    <div class="email-hover-actions"><button class="email-action-btn archive" onclick="event.stopPropagation(); quickArchive(${emailIndex})" title="Archive"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="20 6 9 17 4 12"/></svg></button><button class="email-action-btn snooze" onclick="event.stopPropagation(); quickSnooze(${emailIndex})" title="Snooze"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg></button><button class="email-action-btn delete" onclick="event.stopPropagation(); quickDelete(${emailIndex})" title="Delete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="3 6 5 6 21 6"/><path d="M19 6v14a2 2 0 0 1-2 2H7a2 2 0 0 1-2-2V6m3 0V4a2 2 0 0 1 2-2h4a2 2 0 0 1 2 2v2"/></svg></button></div>
                </div>`;
            };
            
            // Build HTML with date groups
            let html = '';
            if (groups.today.length > 0) {
                html += '<div class="email-date-group">Today</div>';
                html += groups.today.map(renderEmailRow).join('');
            }
            if (groups.yesterday.length > 0) {
                html += '<div class="email-date-group">Yesterday</div>';
                html += groups.yesterday.map(renderEmailRow).join('');
            }
            if (groups.earlier.length > 0) {
                html += '<div class="email-date-group">Earlier</div>';
                html += groups.earlier.map(renderEmailRow).join('');
            }
            
            list.innerHTML = html;
        }

        // Open email by index (safer than JSON parsing)
        function openEmailByIndex(index) {
            if (index >= 0 && index < state.emails.length) {
                openEmailDrawerData(state.emails[index]);
            }
        }

        // Update stats display
        function updateStats() {
            const allEmails = state.emails;
            const totalEmails = allEmails.length;
            const processedByAI = allEmails.filter(e => e.category && e.category !== 'fyi').length;
            const totalMinutes = allEmails.reduce((sum, e) => sum + (e.estimated_response_time || 5), 0);
            const savedCost = (totalMinutes * (100/60)).toFixed(0);
            
            // Use globalUnreadCount for inbox badge (preserved across tab switches)
            document.getElementById('inboxCount').textContent = globalUnreadCount > 0 ? globalUnreadCount : '';
            
            // Update new stats
            const totalEl = document.getElementById('statTotal');
            const processedEl = document.getElementById('statProcessed');
            const savedEl = document.getElementById('statSaved');
            
            if (totalEl) totalEl.textContent = totalEmails;
            if (processedEl) processedEl.textContent = processedByAI;
            if (savedEl) savedEl.textContent = `~${totalMinutes}m ($${savedCost})`;
        }

        // Helper function to escape HTML
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text || '';
            return div.innerHTML;
        }
        
        // Strip HTML tags for clean preview text
        function stripHtml(html) {
            if (!html) return '';
            return html
                .replace(/<style[^>]*>[\s\S]*?<\/style>/gi, '')
                .replace(/<script[^>]*>[\s\S]*?<\/script>/gi, '')
                .replace(/<[^>]+>/g, ' ')
                .replace(/&nbsp;/g, ' ')
                .replace(/&amp;/g, '&')
                .replace(/&lt;/g, '<')
                .replace(/&gt;/g, '>')
                .replace(/&quot;/g, '"')
                .replace(/\s+/g, ' ')
                .trim();
        }
        
        // Get clean preview text (handles both old HTML and new clean data)
        function getCleanPreview(email) {
            const preview = email.body_preview || '';
            // If it contains HTML tags, strip them
            if (preview.includes('<') && preview.includes('>')) {
                return stripHtml(preview).substring(0, 150);
            }
            return preview.substring(0, 150);
        }

        // Open drawer with email data (matching Supabase structure)
        function openEmailDrawerData(email) {
            const drawer = document.getElementById('emailDrawer');
            const widget = document.getElementById('widgetEmail');
            const isExpanded = widget.classList.contains('expanded') || widget.classList.contains('fullscreen');

            drawer.classList.toggle('full-width', !isExpanded);
            drawer.classList.add('open');
            state.emailDrawerOpen = true;
            state.currentEmail = email; // Store for archive/delete actions

            // Mark email as read in Supabase and update UI
            if (!email.is_read) {
                markEmailAsRead(email.gmail_id);
                email.is_read = true;
                // Update the email item in the list
                const emailItem = document.querySelector(`[data-email-id="${email.gmail_id}"]`);
                if (emailItem) {
                    emailItem.classList.remove('unread');
                    emailItem.classList.add('read');
                }
            }

            // Generate initials
            const nameParts = (email.sender_name || 'NA').split(' ');
            const initials = nameParts.length > 1 
                ? (nameParts[0][0] + nameParts[nameParts.length-1][0]).toUpperCase()
                : (email.sender_name || 'NA').slice(0, 2).toUpperCase();

            // Priority mapping
            const priorityMap = { 1: 'P1', 2: 'P2', 3: 'P3', 4: 'P3', 5: 'P3' };
            const priorityLabel = priorityMap[email.priority] || 'P3';

            document.getElementById('drawerSubject').textContent = email.subject || 'No Subject';
            document.getElementById('drawerSender').textContent = email.sender_name || 'Unknown';
            document.getElementById('drawerSenderEmail').textContent = email.sender_email || '';
            document.getElementById('drawerAvatar').textContent = initials;
            
            // Format and display date
            const dateEl = document.getElementById('drawerDate');
            if (dateEl && email.received_at) {
                const date = new Date(email.received_at);
                const today = new Date();
                const isToday = date.toDateString() === today.toDateString();
                const timeStr = date.toLocaleTimeString([], { hour: 'numeric', minute: '2-digit' });
                dateEl.textContent = isToday ? `Today at ${timeStr}` : date.toLocaleDateString() + ' ' + timeStr;
            }
            
            // Render email body - HTML in iframe for safety
            const bodyContent = email.body_full || email.body_preview || '';
            const isHtml = bodyContent.includes('<') && bodyContent.includes('>');
            const iframe = document.getElementById('drawerBody');
            
            if (isHtml) {
                // Wrap HTML with styling for dark theme compatibility
                const htmlWrapper = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <base target="_blank">
                        <style>
                            html, body {
                                background: #1e202c !important;
                                color: #e0e0e0 !important;
                            }
                            body {
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                font-size: 13px;
                                line-height: 1.6;
                                margin: 0;
                                padding: 12px;
                            }
                            /* Force dark backgrounds on containers */
                            div, td, th, table, tr, section, article, header, footer, main {
                                background-color: #1e202c !important;
                                color: #e0e0e0 !important;
                            }
                            /* Keep images visible */
                            img { max-width: 100%; height: auto; }
                            /* Style links */
                            a { color: #4EB4F9 !important; }
                            /* Style solid buttons/CTAs */
                            a[style*="background"], a[class*="btn"], a[class*="button"], 
                            a[class*="cta"], td[style*="background"] a,
                            a[style*="padding"] {
                                background: linear-gradient(135deg, #4EB4F9, #2892d7) !important;
                                color: white !important;
                                border-radius: 6px;
                                display: inline-block;
                            }
                            /* Style bordered/outline buttons */
                            a[style*="border"], a[class*="outline"], a[class*="secondary"],
                            a[class*="ghost"], td[style*="border"] a {
                                background: transparent !important;
                                color: #4EB4F9 !important;
                                border: 1px solid #4EB4F9 !important;
                                border-radius: 6px;
                                display: inline-block;
                                padding: 8px 16px;
                            }
                            /* General text */
                            p, span, li, h1, h2, h3, h4, h5, h6, strong, b, em, i {
                                color: #e0e0e0 !important;
                            }
                            /* Muted/secondary text */
                            small, .muted, .secondary, [style*="color: #666"], [style*="color: #999"], [style*="color: gray"] {
                                color: #999 !important;
                            }
                            /* Horizontal rules */
                            hr { border-color: #3a3d4d !important; }
                            * { box-sizing: border-box; }
                        </style>
                    </head>
                    <body>${bodyContent}</body>
                    </html>
                `;
                iframe.srcdoc = htmlWrapper;
            } else {
                // Plain text - wrap in pre for formatting
                const textWrapper = `
                    <!DOCTYPE html>
                    <html>
                    <head>
                        <base target="_blank">
                        <style>
                            body {
                                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                                font-size: 13px;
                                line-height: 1.7;
                                color: #e0e0e0;
                                background: #1a1a2e;
                                margin: 0;
                                padding: 12px;
                                white-space: pre-wrap;
                            }
                            a { color: #4EB4F9; }
                        </style>
                    </head>
                    <body>${bodyContent.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</body>
                    </html>
                `;
                iframe.srcdoc = textWrapper;
            }
            
            // Auto-resize iframe to fit content
            iframe.onload = function() {
                try {
                    const body = iframe.contentDocument.body;
                    const height = body.scrollHeight + 40;
                    iframe.style.height = Math.max(300, Math.min(height, 800)) + 'px';
                } catch(e) {
                    iframe.style.height = '400px';
                }
            };
            
            // Update tags in drawer - make them clickable
            const tagsContainer = document.querySelector('.drawer-tags');
            if (tagsContainer) {
                tagsContainer.innerHTML = `
                    <span class="email-tag ${priorityLabel.toLowerCase()} clickable" onclick="event.stopPropagation(); showPriorityPicker('${email.gmail_id}', ${email.priority || 3})">${priorityLabel}</span>
                    <span class="email-tag ${(email.category || 'fyi').toLowerCase()} clickable" onclick="event.stopPropagation(); showCategoryPicker('${email.gmail_id}', '${email.category || 'fyi'}')">${(email.category || 'FYI').toUpperCase()}</span>
                `;
            }
            
            // Always show reply fields with sender info
            document.getElementById('replyFields').style.display = 'flex';
            document.getElementById('replyTo').value = email.sender_email || '';
            document.getElementById('replyToText').textContent = email.sender_email || 'recipient@email.com';
            document.getElementById('replyToText').style.display = 'inline';
            document.getElementById('replyTo').style.display = 'none';
            document.getElementById('ccFieldRow').style.display = 'flex';  // Always show CC
            document.getElementById('bccFieldRow').style.display = 'none';
            document.getElementById('addCcLink').style.display = 'none';
            document.getElementById('addBccLink').style.display = 'inline';
            document.getElementById('subjectFieldRow').style.display = 'none';
            document.getElementById('replyModeLabel').textContent = 'Reply';
            document.getElementById('replyModeDesc').textContent = 'To: ' + (email.sender_name || email.sender_email);
            state.composeMode = 'reply';
            
            // Load any saved draft for this email
            loadDraftForEmail(email.gmail_id);
            
            // Display attachments if any
            displayEmailAttachments(email);
        }

        function openEmailDrawer(emailItem) {
            const drawer = document.getElementById('emailDrawer');
            const widget = document.getElementById('widgetEmail');
            const isExpanded = widget.classList.contains('expanded') || widget.classList.contains('fullscreen');

            drawer.classList.toggle('full-width', !isExpanded);
            drawer.classList.add('open');
            state.emailDrawerOpen = true;

            const sender = emailItem.querySelector('.email-sender').textContent;
            const subject = emailItem.querySelector('.email-subject').textContent;
            const avatar = emailItem.querySelector('.email-avatar').textContent;
            document.getElementById('drawerSubject').textContent = subject;
            document.getElementById('drawerSender').textContent = sender;
            document.getElementById('drawerAvatar').textContent = avatar;
        }

        function closeEmailDrawer() {
            document.getElementById('emailDrawer').classList.remove('open');
            state.emailDrawerOpen = false;
            
            // Reset reply section
            document.getElementById('replyFields').style.display = 'none';
            document.getElementById('replyTo').value = '';
            document.getElementById('replyTo').style.display = 'none';
            document.getElementById('replyToText').textContent = 'recipient@email.com';
            document.getElementById('replyToText').style.display = 'inline';
            document.getElementById('replyCc').value = '';
            document.getElementById('ccFieldRow').style.display = 'none';
            document.getElementById('bccFieldRow').style.display = 'none';
            document.getElementById('subjectFieldRow').style.display = 'none';
            document.getElementById('addCcLink').style.display = 'inline';
            document.getElementById('addBccLink').style.display = 'inline';
            document.getElementById('aiReplyText').value = '';
            document.getElementById('aiReplyText').placeholder = "Write your message or describe what you want and click Generate...";
            document.getElementById('replyModeLabel').textContent = 'AI Draft';
            document.getElementById('replyModeDesc').textContent = 'Generated reply';
            
            // Restore drawer elements
            document.querySelector('.drawer-sender-row').style.display = 'flex';
            document.querySelector('.drawer-tags').style.display = 'flex';
            document.getElementById('drawerBody').style.display = 'block';
            document.getElementById('emailAttachmentsSection').style.display = 'none';
            
            // Restore drawer actions (Reply/Forward/Done/More)
            document.querySelector('.drawer-actions').style.display = '';
            
            // Restore reply thread toggle
            document.querySelector('.reply-thread-toggle').style.display = '';
            document.getElementById('replyThreadCard').classList.remove('visible');
            
            state.composeMode = null;
        }

        // ============================================
        // ATTACHMENT DISPLAY & PREVIEW
        // ============================================
        let currentPreviewAttachment = null;
        
        function displayEmailAttachments(email) {
            const section = document.getElementById('emailAttachmentsSection');
            const grid = document.getElementById('attachmentsGrid');
            const countEl = document.getElementById('attachmentsCount');
            
            // Get attachments from email data - handle JSONB which might be string
            let attachments = email.attachments || [];
            if (typeof attachments === 'string') {
                try {
                    attachments = JSON.parse(attachments);
                } catch (e) {
                    attachments = [];
                }
            }
            
            // Ensure it's an array and filter out any invalid entries
            if (!Array.isArray(attachments)) {
                attachments = [];
            }
            attachments = attachments.filter(att => att && (att.name || att.filename));
            
            // Only show section if there are actual valid attachments
            if (attachments.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            countEl.textContent = `${attachments.length} Attachment${attachments.length > 1 ? 's' : ''}`;
            
            grid.innerHTML = attachments.map((att, idx) => {
                const ext = getFileExtension(att.name || att.filename || 'file');
                const iconType = getAttachmentIconType(ext);
                const size = formatFileSize(att.size || 0);
                const isImage = ['jpg', 'jpeg', 'png', 'gif', 'webp'].includes(ext.toLowerCase());
                
                // Check for valid base64 data (not placeholder strings)
                const isValidBase64 = (data) => {
                    if (!data || typeof data !== 'string' || data.length < 100) return false;
                    if (data.includes('filesystem') || data.includes('undefined') || data.includes('null')) return false;
                    return /^[A-Za-z0-9+/=]+$/.test(data.substring(0, 100));
                };
                const hasData = isValidBase64(att.data);
                
                // For images with data, show thumbnail
                let iconContent = '';
                if (isImage && hasData) {
                    iconContent = `<img src="data:${att.type || att.mimeType || 'image/jpeg'};base64,${att.data}" alt="${att.name}">`;
                } else {
                    iconContent = ext.toUpperCase().slice(0, 4);
                }
                
                return `
                    <div class="attachment-card ${!hasData ? 'no-preview' : ''}" onclick="previewAttachment(${idx})" data-attachment-idx="${idx}">
                        <div class="attachment-icon ${iconType}">${iconContent}</div>
                        <div class="attachment-name" title="${escapeHtml(att.name || att.filename || 'Attachment')}">${escapeHtml(att.name || att.filename || 'Attachment')}</div>
                        ${size ? `<div class="attachment-size">${size}</div>` : ''}
                    </div>
                `;
            }).join('');
            
            // Store parsed attachments back for preview function
            email.attachments = attachments;
        }
        
        function getFileExtension(filename) {
            return filename.split('.').pop() || '';
        }
        
        function getAttachmentIconType(ext) {
            ext = ext.toLowerCase();
            if (ext === 'pdf') return 'pdf';
            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg', 'bmp'].includes(ext)) return 'image';
            if (['doc', 'docx', 'txt', 'rtf', 'odt'].includes(ext)) return 'doc';
            if (['xls', 'xlsx', 'csv'].includes(ext)) return 'xls';
            if (['zip', 'rar', '7z', 'tar', 'gz'].includes(ext)) return 'zip';
            return 'other';
        }
        
        function formatFileSize(size) {
            // Handle null/undefined
            if (!size) return '';
            
            // Handle string sizes like "201 kB", "324 kB", "1.5 MB"
            if (typeof size === 'string') {
                // If it already looks like a formatted size, return as-is
                if (size.match(/\d+(\.\d+)?\s*[KMGT]?B/i)) {
                    return size;
                }
                // Try to parse as number
                size = parseInt(size);
            }
            
            // Handle non-numeric or zero
            if (!size || size === 0 || isNaN(size)) return '';
            
            // Format bytes
            const units = ['B', 'KB', 'MB', 'GB'];
            let i = 0;
            while (size >= 1024 && i < units.length - 1) {
                size /= 1024;
                i++;
            }
            return size.toFixed(i > 0 ? 1 : 0) + ' ' + units[i];
        }
        
        async function previewAttachment(idx) {
            const email = state.currentEmail;
            if (!email || !email.attachments || !email.attachments[idx]) return;
            
            const att = email.attachments[idx];
            currentPreviewAttachment = att;
            currentPreviewAttachment._idx = idx;
            
            const modal = document.getElementById('attachmentPreviewModal');
            const title = document.getElementById('attachmentPreviewTitle');
            const content = document.getElementById('attachmentPreviewContent');
            
            title.textContent = att.name || att.filename || 'Attachment';
            
            const ext = getFileExtension(att.name || att.filename || '').toLowerCase();
            const mimeType = att.type || att.mimeType || 'application/octet-stream';
            
            // Check if we have valid base64 data (not placeholder strings like "filesystem-v2")
            const isValidBase64 = (data) => {
                if (!data || typeof data !== 'string' || data.length < 100) return false;
                if (data.includes('filesystem') || data.includes('undefined') || data.includes('null')) return false;
                return /^[A-Za-z0-9+/=]+$/.test(data.substring(0, 100));
            };
            const hasData = isValidBase64(att.data);
            
            // If no data, AUTO-FETCH immediately (no popup)
            if (!hasData) {
                // Show loading state in modal
                content.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: white;">
                        <div class="email-loading-spinner" style="margin: 0 auto 20px;"></div>
                        <div style="font-size:14px;opacity:0.8;">Loading attachment...</div>
                        <div style="font-size:12px;opacity:0.5;margin-top:8px;">${escapeHtml(att.name || 'Attachment')}</div>
                    </div>
                `;
                modal.classList.add('active');
                // Auto-fetch the attachment
                await fetchAndPreviewAttachment(idx);
                return;
            }
            
            // Generate preview based on file type
            showAttachmentPreview(att, ext, mimeType, content);
            modal.classList.add('active');
        }
        
        function showAttachmentPreview(att, ext, mimeType, content) {
            if (['jpg', 'jpeg', 'png', 'gif', 'webp', 'svg'].includes(ext)) {
                content.innerHTML = `<img src="data:${mimeType};base64,${att.data}" alt="${escapeHtml(att.name)}" style="max-width:100%;max-height:80vh;">`;
            } else if (ext === 'pdf') {
                content.innerHTML = `<iframe src="data:application/pdf;base64,${att.data}" style="width:100%;height:80vh;border:none;"></iframe>`;
            } else {
                // Show download prompt for other types
                content.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: white;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width:64px;height:64px;margin-bottom:20px;opacity:0.5;"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/></svg>
                        <div style="font-size:16px;margin-bottom:8px;">${escapeHtml(att.name || 'File')}</div>
                        <div style="font-size:12px;opacity:0.6;margin-bottom:20px;">${ext.toUpperCase()} file - ${formatFileSize(att.size)}</div>
                        <button class="attachment-preview-btn" onclick="downloadAttachment()" style="font-size:14px;padding:12px 24px;">
                            Download File
                        </button>
                    </div>
                `;
            }
        }
        
        async function fetchAndPreviewAttachment(idx) {
            const email = state.currentEmail;
            if (!email || !email.attachments || !email.attachments[idx]) return;
            
            const att = email.attachments[idx];
            const content = document.getElementById('attachmentPreviewContent');
            
            // Show loading state
            content.innerHTML = `
                <div style="text-align: center; padding: 60px; color: white;">
                    <div class="email-loading-spinner" style="margin: 0 auto 20px;"></div>
                    <div style="font-size:14px;opacity:0.8;">Fetching attachment from Gmail...</div>
                    <div style="font-size:12px;opacity:0.5;margin-top:8px;">${escapeHtml(att.name || 'Attachment')}</div>
                </div>
            `;
            
            try {
                console.log('Fetching attachment:', {
                    webhook: FETCH_ATTACHMENT_WEBHOOK,
                    messageId: email.gmail_id,
                    attachmentName: att.name || att.filename,
                    attachmentIndex: idx
                });
                
                const response = await fetch(FETCH_ATTACHMENT_WEBHOOK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        messageId: email.gmail_id,
                        attachmentName: att.name || att.filename,
                        attachmentIndex: idx
                    })
                });
                
                console.log('Fetch response status:', response.status, response.statusText);
                
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                
                const responseText = await response.text();
                console.log('Response length:', responseText.length, 'chars');
                
                let result;
                try {
                    result = JSON.parse(responseText);
                } catch (parseError) {
                    console.error('JSON parse error:', parseError, 'Response preview:', responseText.substring(0, 200));
                    throw new Error('Invalid response from server');
                }
                
                console.log('Fetch result:', { success: result.success, hasAttachment: !!result.attachment, error: result.error });
                
                if (result.success && result.attachment && result.attachment.data) {
                    // Validate the data is proper base64
                    const isValidBase64 = (data) => {
                        if (!data || typeof data !== 'string' || data.length < 100) return false;
                        if (data.includes('filesystem') || data.includes('undefined') || data.includes('null')) return false;
                        return /^[A-Za-z0-9+/=]+$/.test(data.substring(0, 100));
                    };
                    
                    if (!isValidBase64(result.attachment.data)) {
                        console.error('Invalid base64 data received:', result.attachment.data.substring(0, 100));
                        throw new Error('Received invalid attachment data');
                    }
                    
                    // Update the attachment with fetched data
                    att.data = result.attachment.data;
                    currentPreviewAttachment = att;
                    
                    // Also update in the email's attachments array
                    if (email.attachments[idx]) {
                        email.attachments[idx].data = result.attachment.data;
                    }
                    
                    const ext = getFileExtension(att.name || att.filename || '').toLowerCase();
                    const mimeType = att.type || att.mimeType || result.attachment.mimeType || 'application/octet-stream';
                    
                    showAttachmentPreview(att, ext, mimeType, content);
                    showToast('Attachment loaded successfully');
                } else {
                    throw new Error(result.error || 'Failed to fetch attachment');
                }
            } catch (error) {
                console.error('Fetch attachment error:', error);
                content.innerHTML = `
                    <div style="text-align: center; padding: 60px; color: white;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="#ef4444" stroke-width="2" style="width:64px;height:64px;margin-bottom:20px;"><circle cx="12" cy="12" r="10"/><path d="M12 8v4M12 16h.01"/></svg>
                        <div style="font-size:16px;margin-bottom:8px;color:#ef4444;">Failed to load attachment</div>
                        <div style="font-size:12px;opacity:0.6;margin-bottom:20px;">${escapeHtml(error.message)}</div>
                        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
                            <button onclick="fetchAndPreviewAttachment(${idx})" style="background:#4eb4f9;color:#000;border:none;padding:10px 20px;border-radius:8px;font-weight:600;font-size:13px;cursor:pointer;">
                                Try Again
                            </button>
                            <a href="https://mail.google.com" target="_blank" style="background:rgba(255,255,255,0.1);color:#fff;padding:10px 20px;border-radius:8px;text-decoration:none;font-weight:500;font-size:13px;">
                                Open Gmail
                            </a>
                        </div>
                    </div>
                `;
            }
        }
        
        function closeAttachmentPreview() {
            document.getElementById('attachmentPreviewModal').classList.remove('active');
            currentPreviewAttachment = null;
        }
        
        async function downloadAttachment() {
            if (!currentPreviewAttachment) return;
            
            const att = currentPreviewAttachment;
            
            // Check if we have valid base64 data
            const isValidBase64 = (data) => {
                if (!data || typeof data !== 'string' || data.length < 100) return false;
                if (data.includes('filesystem') || data.includes('undefined') || data.includes('null')) return false;
                return /^[A-Za-z0-9+/=]+$/.test(data.substring(0, 100));
            };
            
            // Check if we have actual file data, if not fetch it first
            if (!isValidBase64(att.data)) {
                // Try to fetch if we have the index
                if (currentPreviewAttachment._idx !== undefined) {
                    showToast('Fetching attachment...');
                    await fetchAndPreviewAttachment(currentPreviewAttachment._idx);
                    // Re-check after fetch
                    if (!currentPreviewAttachment?.data || !isValidBase64(currentPreviewAttachment.data)) {
                        showToast('Failed to fetch - try opening in Gmail');
                        return;
                    }
                } else {
                    showToast('Cannot download - click "Download & Preview" first');
                    return;
                }
            }
            
            const mimeType = att.type || att.mimeType || 'application/octet-stream';
            const link = document.createElement('a');
            link.href = `data:${mimeType};base64,${att.data}`;
            link.download = att.name || att.filename || 'download';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showToast(`Downloaded: ${att.name || 'file'}`);
        }

        // Mark email as read in Supabase
        function markEmailAsRead(gmailId) {
            fetch(`${SUPABASE_URL}/rest/v1/emails?gmail_id=eq.${gmailId}`, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({ is_read: true })
            }).catch(err => console.log('Mark read error:', err));
            
            // Update stats
            updateStats();
        }

        // Email Actions - Archive/Delete in Supabase (not Gmail)
        async function archiveCurrentEmail() {
            if (!state.currentEmail) return;
            
            const emailSubject = state.currentEmail.subject || 'No Subject';
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/emails?gmail_id=eq.${state.currentEmail.gmail_id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ 
                        status: 'archived',
                        suggested_action: 'archive',
                        is_read: true 
                    })
                });
                
                if (response.ok) {
                    closeEmailDrawer();
                    loadEmails(); // Refresh list
                    showToast('Email archived');
                    logToChat('action', `📁 Archived: "${emailSubject.substring(0, 40)}${emailSubject.length > 40 ? '...' : ''}"`);
                }
            } catch (error) {
                console.error('Archive error:', error);
                showToast('Failed to archive');
            }
        }

        async function deleteCurrentEmail() {
            if (!state.currentEmail) return;
            
            if (!confirm('Delete this email from PULSE? (This won\'t delete from Gmail)')) return;
            
            const emailSubject = state.currentEmail.subject || 'No Subject';
            
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/emails?gmail_id=eq.${state.currentEmail.gmail_id}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (response.ok) {
                    closeEmailDrawer();
                    loadEmails(); // Refresh list
                    showToast('Email deleted');
                    logToChat('action', `🗑️ Deleted: "${emailSubject.substring(0, 40)}${emailSubject.length > 40 ? '...' : ''}"`);
                }
            } catch (error) {
                console.error('Delete error:', error);
                showToast('Failed to delete');
            }
        }

        function toggleMoreMenu() {
            const menu = document.getElementById('moreMenu');
            menu.classList.toggle('active');
            
            // Close when clicking outside
            const closeMenu = (e) => {
                if (!e.target.closest('.more-dropdown')) {
                    menu.classList.remove('active');
                    document.removeEventListener('click', closeMenu);
                }
            };
            setTimeout(() => document.addEventListener('click', closeMenu), 10);
        }

        function replyToEmail() {
            document.getElementById('moreMenu').classList.remove('active');
            if (!state.currentEmail) return;
            
            // Fields are already visible, just scroll to compose area and focus
            state.composeMode = 'reply';
            document.getElementById('aiReplyText').focus();
            document.querySelector('.ai-reply-section').scrollIntoView({ behavior: 'smooth' });
        }

        function forwardEmail() {
            document.getElementById('moreMenu').classList.remove('active');
            if (!state.currentEmail) return;
            
            // Set up forward mode - need to enter recipient
            document.getElementById('replyFields').style.display = 'flex';
            document.getElementById('replyTo').value = '';
            document.getElementById('replyToText').style.display = 'none';
            document.getElementById('replyTo').style.display = 'block';
            document.getElementById('replyTo').classList.add('active');
            document.getElementById('replyTo').placeholder = 'Enter recipient email...';
            document.getElementById('replyModeLabel').textContent = 'Forward';
            document.getElementById('replyModeDesc').textContent = 'Forwarding email';
            document.getElementById('aiReplyText').placeholder = 'Add a message (optional)...';
            document.getElementById('aiReplyText').value = `\n\n---------- Forwarded message ----------\nFrom: ${state.currentEmail.sender_name} <${state.currentEmail.sender_email}>\nSubject: ${state.currentEmail.subject}\n\n${state.currentEmail.body_preview || ''}`;
            
            // Show CC, hide subject for forwards
            document.getElementById('subjectFieldRow').style.display = 'none';
            document.getElementById('ccFieldRow').style.display = 'flex';
            document.getElementById('bccFieldRow').style.display = 'none';
            document.getElementById('addCcLink').style.display = 'none';
            document.getElementById('addBccLink').style.display = 'inline';
            
            document.getElementById('replyTo').focus();
            state.composeMode = 'forward';
            document.querySelector('.ai-reply-section').scrollIntoView({ behavior: 'smooth' });
        }

        function generateAIReply() {
            // For new emails, don't require currentEmail
            if (!state.currentEmail && state.composeMode !== 'new') {
                showToast('Select an email first');
                return;
            }
            
            // Show loading state
            const textarea = document.getElementById('aiReplyText');
            textarea.placeholder = 'Generating AI draft...';
            textarea.value = '';
            
            // TODO: Call AI API to generate reply based on email content
            setTimeout(() => {
                // For now, just show a placeholder - AI integration will replace this
                textarea.value = '';
                textarea.placeholder = 'Write your message or describe what you want and click Generate...';
                showToast('AI draft generation - coming soon');
            }, 500);
        }

        // Apply AI transformation to reply text
        function applyAITool(tool) {
            const textarea = document.getElementById('aiReplyText');
            const text = textarea.value.trim();
            
            if (!text) {
                showToast('Write some text first');
                return;
            }
            
            // Show loading
            const originalText = text;
            textarea.value = 'Applying AI...';
            
            // TODO: Call AI API with the transformation type
            // For now, simulate the transformation
            setTimeout(() => {
                let result = originalText;
                switch(tool) {
                    case 'grammar':
                        showToast('Grammar fixed');
                        break;
                    case 'professional':
                        result = originalText.replace(/Hi /g, 'Dear ').replace(/Thanks/g, 'Thank you');
                        showToast('Made professional');
                        break;
                    case 'casual':
                        result = originalText.replace(/Dear /g, 'Hey ').replace(/Thank you/g, 'Thanks');
                        showToast('Made casual');
                        break;
                    case 'shorter':
                        showToast('Made shorter');
                        break;
                    case 'longer':
                        showToast('Made longer');
                        break;
                }
                textarea.value = result;
            }, 300);
        }

        // Email selection state
        let selectedEmails = new Set();
        
        function toggleEmailSelect(emailIndex) {
            const email = state.emails[emailIndex];
            if (!email) return;
            
            const emailItem = document.querySelector(`[data-email-index="${emailIndex}"]`);
            const checkbox = emailItem?.querySelector('.email-checkbox');
            
            if (selectedEmails.has(emailIndex)) {
                selectedEmails.delete(emailIndex);
                emailItem?.classList.remove('selected');
                checkbox?.classList.remove('checked');
            } else {
                selectedEmails.add(emailIndex);
                emailItem?.classList.add('selected');
                checkbox?.classList.add('checked');
            }
            
            updateSelectionBar();
        }
        
        function updateSelectionBar() {
            const bar = document.getElementById('emailSelectionBar');
            const count1 = document.getElementById('selectionCount');
            const count2 = document.getElementById('selectionCount2');
            const readUnreadText = document.getElementById('readUnreadText');
            const readUnreadIcon = document.getElementById('readUnreadIcon');
            
            if (selectedEmails.size > 0) {
                bar.classList.add('visible');
                count1.textContent = selectedEmails.size;
                count2.textContent = selectedEmails.size;
                
                // Check if all selected emails are read
                let allRead = true;
                for (const index of selectedEmails) {
                    const email = state.emails[index];
                    if (email && !email.is_read) {
                        allRead = false;
                        break;
                    }
                }
                
                // Update button text and icon based on read status
                if (allRead) {
                    readUnreadText.innerHTML = `Mark <span id="selectionCount2">${selectedEmails.size}</span> Emails as Unread`;
                    readUnreadIcon.innerHTML = '<path d="M17.94 17.94A10.07 10.07 0 0 1 12 20c-7 0-11-8-11-8a18.45 18.45 0 0 1 5.06-5.94M9.9 4.24A9.12 9.12 0 0 1 12 4c7 0 11 8 11 8a18.5 18.5 0 0 1-2.16 3.19m-6.72-1.07a3 3 0 1 1-4.24-4.24"/><line x1="1" y1="1" x2="23" y2="23"/>';
                } else {
                    readUnreadText.innerHTML = `Mark <span id="selectionCount2">${selectedEmails.size}</span> Emails as Read`;
                    readUnreadIcon.innerHTML = '<path d="M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z"/><circle cx="12" cy="12" r="3"/>';
                }
            } else {
                bar.classList.remove('visible');
            }
        }
        
        function clearSelection() {
            selectedEmails.forEach(index => {
                const emailItem = document.querySelector(`[data-email-index="${index}"]`);
                emailItem?.classList.remove('selected');
                emailItem?.querySelector('.email-checkbox')?.classList.remove('checked');
            });
            selectedEmails.clear();
            updateSelectionBar();
        }
        
        async function markSelectedAsDone() {
            for (const index of selectedEmails) {
                await quickArchive(index, false);
            }
            clearSelection();
            showToast(`${selectedEmails.size} emails archived`);
            loadEmails();
        }
        
        // Toggle read/unread for selected emails
        async function toggleSelectedReadStatus() {
            // Check if all selected emails are read
            let allRead = true;
            for (const index of selectedEmails) {
                const email = state.emails[index];
                if (email && !email.is_read) {
                    allRead = false;
                    break;
                }
            }
            
            const newStatus = !allRead; // If all read, mark unread; otherwise mark read
            
            for (const index of selectedEmails) {
                const email = state.emails[index];
                if (email) {
                    email.is_read = newStatus;
                    await fetch(`${SUPABASE_URL}/rest/v1/emails?gmail_id=eq.${email.gmail_id}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify({ is_read: newStatus })
                    }).catch(err => console.log('Mark read/unread error:', err));
                }
            }
            
            clearSelection();
            showToast(newStatus ? 'Emails marked as read' : 'Emails marked as unread');
            renderEmails();
            updateStats();
        }
        
        async function markSelectedAsRead() {
            await toggleSelectedReadStatus();
        }
        
        async function quickArchive(emailIndex, showMessage = true) {
            const email = state.emails[emailIndex];
            if (!email) return;
            
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/emails?gmail_id=eq.${email.gmail_id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify({ 
                        status: 'archived',
                        suggested_action: 'archive', 
                        is_read: true 
                    })
                });
                state.emails.splice(emailIndex, 1);
                renderEmails();
                updateStats();
                if (showMessage) showToast('Email archived');
            } catch (err) {
                console.error('Archive error:', err);
            }
        }
        
        function quickSnooze(emailIndex) {
            // TODO: Implement snooze modal
            showToast('Snooze coming soon');
        }
        
        async function quickDelete(emailIndex) {
            const email = state.emails[emailIndex];
            if (!email) return;
            
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/emails?gmail_id=eq.${email.gmail_id}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                state.emails.splice(emailIndex, 1);
                renderEmails();
                updateStats();
                showToast('Email deleted');
            } catch (err) {
                console.error('Delete error:', err);
            }
        }
        
        // Toggle read/unread status
        async function toggleReadStatus(emailIndex) {
            const email = state.emails[emailIndex];
            if (!email) return;
            
            const newReadStatus = !email.is_read;
            
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/emails?gmail_id=eq.${email.gmail_id}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ is_read: newReadStatus })
                });
                
                email.is_read = newReadStatus;
                renderEmails();
                updateStats();
                showToast(newReadStatus ? 'Marked as read' : 'Marked as unread');
            } catch (err) {
                console.error('Toggle read error:', err);
            }
        }
        
        // Reply thread toggle
        function toggleReplyThread() {
            const card = document.getElementById('replyThreadCard');
            card.classList.toggle('visible');
            
            // Populate with current email data
            if (card.classList.contains('visible') && state.currentEmail) {
                const email = state.currentEmail;
                const date = new Date(email.received_at).toLocaleString('en-US', {
                    weekday: 'short',
                    month: 'short',
                    day: 'numeric',
                    year: 'numeric',
                    hour: 'numeric',
                    minute: '2-digit'
                });
                document.getElementById('replyThreadMeta').textContent = 
                    `On ${date}, ${email.sender_email || email.sender_name} wrote:`;
                document.getElementById('replyThreadContent').textContent = 
                    email.body_preview || email.subject || 'No content';
            }
        }
        
        // Draft actions
        function clearDraft() {
            document.getElementById('replyTo').value = '';
            document.getElementById('replyCc').value = '';
            document.getElementById('replySubject').value = '';
            document.getElementById('aiReplyText').value = '';
            currentDraftId = null;
            showToast('Draft cleared - start fresh');
        }
        
        // Attachment picker
        // Attachment handling
        let selectedAttachments = [];
        
        function openAttachmentPicker() {
            const input = document.createElement('input');
            input.type = 'file';
            input.multiple = true;
            input.onchange = (e) => {
                const files = Array.from(e.target.files);
                if (files.length > 0) {
                    files.forEach(file => {
                        // Read file as base64
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            selectedAttachments.push({
                                name: file.name,
                                type: file.type,
                                size: file.size,
                                data: event.target.result.split(',')[1] // Remove data:... prefix
                            });
                            updateAttachmentDisplay();
                        };
                        reader.readAsDataURL(file);
                    });
                    showToast(`${files.length} file(s) attached`);
                }
            };
            input.click();
        }
        
        function updateAttachmentDisplay() {
            // Find or create attachment display area
            let attachArea = document.getElementById('attachmentArea');
            if (!attachArea) {
                const aiReplySection = document.querySelector('.ai-reply-section');
                if (aiReplySection) {
                    attachArea = document.createElement('div');
                    attachArea.id = 'attachmentArea';
                    attachArea.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;';
                    const textarea = document.getElementById('aiReplyText');
                    textarea.parentNode.insertBefore(attachArea, textarea);
                }
            }
            
            if (attachArea) {
                attachArea.innerHTML = selectedAttachments.map((file, idx) => `
                    <div class="attachment-chip" style="display: flex; align-items: center; gap: 6px; background: rgba(78, 180, 249, 0.15); padding: 4px 10px; border-radius: 6px; font-size: 11px;">
                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="width: 14px; height: 14px;"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>
                        <span>${file.name}</span>
                        <button onclick="removeAttachment(${idx})" style="background: none; border: none; color: var(--red); cursor: pointer; padding: 0;">×</button>
                    </div>
                `).join('');
            }
        }
        
        function removeAttachment(idx) {
            selectedAttachments.splice(idx, 1);
            updateAttachmentDisplay();
        }
        
        function clearAttachments() {
            selectedAttachments = [];
            const attachArea = document.getElementById('attachmentArea');
            if (attachArea) attachArea.innerHTML = '';
        }

        // N8N Webhook URL for sending emails - UPDATE THIS after importing workflow
        const SEND_EMAIL_WEBHOOK = 'https://cherhabil.app.n8n.cloud/webhook/pulse-send-email';
        
        async function sendReply() {
            const to = document.getElementById('replyTo').value;
            const cc = document.getElementById('replyCc').value;
            const body = document.getElementById('aiReplyText').value;
            
            if ((state.composeMode === 'forward' || state.composeMode === 'new') && !to) {
                showToast('Please enter a recipient email');
                document.getElementById('replyTo').focus();
                return;
            }
            
            if (!body.trim()) {
                showToast('Please write a message');
                return;
            }
            
            // Prepare email data
            const subjectField = document.getElementById('replySubject');
            let subject = '';
            if (state.composeMode === 'new') {
                subject = subjectField?.value || 'No Subject';
            } else if (state.composeMode === 'forward') {
                subject = `Fwd: ${state.currentEmail?.subject || ''}`;
            } else if (state.composeMode === 'reply') {
                subject = `Re: ${state.currentEmail?.subject || ''}`;
            }
            
            const emailData = {
                to: to || (state.currentEmail ? state.currentEmail.sender_email : ''),
                cc: cc,
                subject: subject,
                body: body,
                mode: state.composeMode || 'new',
                replyToMessageId: state.currentEmail?.gmail_id || '',
                threadId: state.currentEmail?.thread_id || '',
                attachments: selectedAttachments.length > 0 ? selectedAttachments : []
            };
            
            console.log('Sending email:', emailData);
            const attachInfo = selectedAttachments.length > 0 ? ` (${selectedAttachments.length} attachment(s))` : '';
            logToChat('action', `📤 Sending email to ${emailData.to}...${attachInfo}`);
            
            // Note: Attachments require proper N8N workflow configuration
            if (selectedAttachments.length > 0) {
                console.log('Attachments to send:', selectedAttachments.map(a => a.name));
            }
            
            // Show sending state
            const sendBtn = document.querySelector('.btn-send-gradient');
            const originalText = sendBtn.innerHTML;
            sendBtn.innerHTML = '<span>Sending...</span>';
            sendBtn.disabled = true;
            
            try {
                const response = await fetch(SEND_EMAIL_WEBHOOK, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(emailData)
                });
                
                // Handle response - n8n might return empty body on success
                let result = { success: false };
                const responseText = await response.text();
                
                if (responseText) {
                    try {
                        result = JSON.parse(responseText);
                    } catch (parseError) {
                        // If response is not JSON but status is OK, assume success
                        if (response.ok) {
                            result = { success: true };
                        }
                    }
                } else if (response.ok) {
                    // Empty response with OK status = success
                    result = { success: true };
                }
                
                if (result.success || response.ok) {
                    showToast(`Email ${state.composeMode === 'forward' ? 'forwarded' : 'sent'} successfully! ✓`);
                    logToChat('system', `✅ Email sent to ${emailData.to}: "${subject}"`);
                    
                    // Save sent email to Supabase
                    await saveSentEmail(emailData, subject, result);
                    
                    // Delete the draft since email was sent
                    deleteDraft();
                    
                    // Reset fields
                    document.getElementById('replyFields').style.display = 'none';
                    document.getElementById('aiReplyText').value = '';
                    document.getElementById('replyModeLabel').textContent = 'AI Draft';
                    document.getElementById('replyModeDesc').textContent = 'Generated reply';
                    clearAttachments();
                    state.composeMode = null;
                    
                    // Close drawer first
                    closeEmailDrawer();
                    
                    // Switch to Sent tab to show the sent email
                    switchEmailTab('sent');
                } else {
                    throw new Error(result.error || 'Failed to send');
                }
            } catch (error) {
                console.error('Send error:', error);
                showToast('Failed to send email: ' + error.message);
                logToChat('system', `❌ Failed to send email: ${error.message}`);
            } finally {
                sendBtn.innerHTML = originalText;
                sendBtn.disabled = false;
            }
        }

        function resetReplySection() {
            document.getElementById('replyFields').style.display = 'none';
            document.getElementById('replyTo').value = '';
            document.getElementById('replyCc').value = '';
            document.getElementById('aiReplyText').value = '';
            document.getElementById('aiReplyText').placeholder = "AI will generate a draft reply when you click 'Regenerate'...";
            document.getElementById('replyModeLabel').textContent = 'AI Draft';
            document.getElementById('replyModeDesc').textContent = 'Generated reply';
            document.getElementById('aiTimeSaved').innerHTML = 'Time saved: <strong>~0 min ($0)</strong>';
            state.composeMode = null;
        }
        
        // Save sent email to Supabase emails table
        async function saveSentEmail(emailData, subject, result) {
            try {
                // Prepare attachment metadata with data for display
                const attachmentsMeta = emailData.attachments && emailData.attachments.length > 0 
                    ? emailData.attachments.map(a => ({ 
                        name: a.name, 
                        type: a.type, 
                        size: a.size,
                        data: a.data // Include base64 data for preview
                    }))
                    : [];
                
                const sentEmail = {
                    gmail_id: result.messageId || `sent_${Date.now()}`,
                    thread_id: emailData.threadId || result.threadId || null,
                    sender_name: 'Me',
                    sender_email: emailData.to,
                    subject: subject,
                    body_preview: emailData.body.substring(0, 200),
                    received_at: new Date().toISOString(),
                    is_read: true,
                    status: 'sent',
                    priority: 3,
                    category: 'sent',
                    has_attachments: attachmentsMeta.length > 0,
                    attachments: attachmentsMeta.length > 0 ? attachmentsMeta : null
                };
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/emails`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'return=minimal'
                    },
                    body: JSON.stringify(sentEmail)
                });
                
                if (response.ok) {
                    console.log('Sent email saved to Supabase with attachments:', attachmentsMeta.length);
                } else {
                    const errorText = await response.text();
                    console.error('Failed to save sent email:', response.status, errorText);
                }
            } catch (error) {
                console.error('Failed to save sent email:', error);
            }
        }

        function markAsUnread() {
            document.getElementById('moreMenu').classList.remove('active');
            if (!state.currentEmail) return;
            
            // Update in Supabase
            fetch(`${SUPABASE_URL}/rest/v1/emails?gmail_id=eq.${state.currentEmail.gmail_id}`, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ is_read: false })
            }).then(() => {
                loadEmails();
                showToast('Marked as unread');
            });
        }

        function snoozeEmail() {
            document.getElementById('moreMenu').classList.remove('active');
            showToast('Snooze feature coming soon');
        }
        
        // Send Later functionality
        function toggleSendLaterDropdown() {
            const dropdown = document.getElementById('sendLaterDropdown');
            dropdown.classList.toggle('active');
            if (dropdown.classList.contains('active')) {
                initSendLaterCalendar();
            }
        }
        
        function openSendLaterCalendar() {
            const calendar = document.getElementById('sendLaterCalendar');
            calendar.style.display = calendar.style.display === 'none' ? 'block' : 'none';
            if (calendar.style.display === 'block') {
                initSendLaterCalendar();
            }
        }
        
        let sendLaterDate = new Date();
        
        function initSendLaterCalendar() {
            const monthSelect = document.getElementById('sendLaterMonth');
            const yearSelect = document.getElementById('sendLaterYear');
            
            // Populate months
            const months = ['January', 'February', 'March', 'April', 'May', 'June', 
                           'July', 'August', 'September', 'October', 'November', 'December'];
            monthSelect.innerHTML = months.map((m, i) => 
                `<option value="${i}" ${i === sendLaterDate.getMonth() ? 'selected' : ''}>${m}</option>`
            ).join('');
            
            // Populate years
            const currentYear = new Date().getFullYear();
            yearSelect.innerHTML = [currentYear, currentYear + 1, currentYear + 2].map(y => 
                `<option value="${y}" ${y === sendLaterDate.getFullYear() ? 'selected' : ''}>${y}</option>`
            ).join('');
            
            renderSendLaterCalendar();
        }
        
        function renderSendLaterCalendar() {
            const grid = document.getElementById('sendLaterGrid');
            const month = parseInt(document.getElementById('sendLaterMonth').value);
            const year = parseInt(document.getElementById('sendLaterYear').value);
            
            const firstDay = new Date(year, month, 1);
            const lastDay = new Date(year, month + 1, 0);
            const startDay = firstDay.getDay();
            const daysInMonth = lastDay.getDate();
            
            const today = new Date();
            
            let html = ['Su', 'Mo', 'Tu', 'We', 'Th', 'Fr', 'Sa'].map(d => 
                `<div class="calendar-day-header">${d}</div>`
            ).join('');
            
            // Empty days before month starts
            for (let i = 0; i < startDay; i++) {
                html += '<div class="calendar-day other-month"></div>';
            }
            
            // Days of month
            for (let d = 1; d <= daysInMonth; d++) {
                const isToday = d === today.getDate() && month === today.getMonth() && year === today.getFullYear();
                const isSelected = d === sendLaterDate.getDate() && month === sendLaterDate.getMonth() && year === sendLaterDate.getFullYear();
                html += `<div class="calendar-day ${isToday ? 'today' : ''} ${isSelected ? 'selected' : ''}" 
                         onclick="selectSendLaterDay(${d})">${d}</div>`;
            }
            
            grid.innerHTML = html;
        }
        
        function selectSendLaterDay(day) {
            const month = parseInt(document.getElementById('sendLaterMonth').value);
            const year = parseInt(document.getElementById('sendLaterYear').value);
            sendLaterDate = new Date(year, month, day);
            renderSendLaterCalendar();
        }
        
        function prevMonth(type) {
            const monthSelect = document.getElementById(type + 'Month');
            const yearSelect = document.getElementById(type + 'Year');
            let month = parseInt(monthSelect.value);
            let year = parseInt(yearSelect.value);
            
            if (month === 0) {
                month = 11;
                year--;
            } else {
                month--;
            }
            
            monthSelect.value = month;
            yearSelect.value = year;
            renderSendLaterCalendar();
        }
        
        function nextMonth(type) {
            const monthSelect = document.getElementById(type + 'Month');
            const yearSelect = document.getElementById(type + 'Year');
            let month = parseInt(monthSelect.value);
            let year = parseInt(yearSelect.value);
            
            if (month === 11) {
                month = 0;
                year++;
            } else {
                month++;
            }
            
            monthSelect.value = month;
            yearSelect.value = year;
            renderSendLaterCalendar();
        }
        
        function updateCalendar(type) {
            renderSendLaterCalendar();
        }
        
        function confirmSendLater() {
            const hour = document.getElementById('sendLaterHour').value;
            const minute = document.getElementById('sendLaterMinute').value;
            sendLaterDate.setHours(parseInt(hour), parseInt(minute), 0, 0);
            
            const formatted = sendLaterDate.toLocaleString('en-US', {
                weekday: 'short',
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit'
            });
            
            showToast(`Email scheduled for ${formatted}`);
            document.getElementById('sendLaterDropdown').classList.remove('active');
            // TODO: Actually schedule the email via N8N
        }
        
        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.send-btn-wrapper')) {
                document.getElementById('sendLaterDropdown')?.classList.remove('active');
            }
        });

        // ============================================
        // AI DRAFT MODAL FUNCTIONS
        // ============================================
        function openAiDraftModal() {
            document.getElementById('aiDraftModal').classList.add('active');
            const input = document.getElementById('aiDraftPrompt');
            input.value = '';
            input.style.height = 'auto';
            setTimeout(() => input.focus(), 100);
        }
        
        function closeAiDraftModal() {
            document.getElementById('aiDraftModal').classList.remove('active');
        }
        
        function autoResizeTextarea(el) {
            el.style.height = 'auto';
            el.style.height = Math.min(el.scrollHeight, 120) + 'px';
        }
        
        function skipAiDraft() {
            closeAiDraftModal();
            openComposeNew();
            logToChat('action', '📝 Starting new email (manual compose)');
        }
        
        function startVoiceDraft() {
            showToast('Voice input coming soon');
        }
        
        async function generateAiDraft() {
            const prompt = document.getElementById('aiDraftPrompt').value.trim();
            if (!prompt) {
                showToast('Please describe what you want to draft');
                return;
            }
            
            closeAiDraftModal();
            openComposeNew();
            
            // Show generating state
            const textarea = document.getElementById('aiReplyText');
            textarea.value = 'Generating your draft...';
            textarea.disabled = true;
            
            logToChat('action', `🤖 Generating: "${prompt.substring(0, 40)}${prompt.length > 40 ? '...' : ''}"`);
            
            try {
                // Call AI generation via N8N webhook
                const response = await fetch(N8N_WEBHOOK_URL.replace('6b9fd857-4434-45d4-9dc9-759ac4732278', 'ai-draft'), {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        action: 'generate_draft',
                        prompt: prompt,
                        timestamp: Date.now()
                    })
                });
                
                if (response.ok) {
                    const data = await response.json();
                    textarea.value = data.draft || generateLocalDraft(prompt);
                } else {
                    textarea.value = generateLocalDraft(prompt);
                }
            } catch (error) {
                console.log('AI draft via webhook failed, using local generation');
                textarea.value = generateLocalDraft(prompt);
            }
            
            textarea.disabled = false;
            logToChat('system', '✅ Draft generated');
            
            // Auto-save the draft
            saveDraft();
        }
        
        function generateLocalDraft(prompt) {
            const lowerPrompt = prompt.toLowerCase();
            let draft = '';
            
            if (lowerPrompt.includes('follow up') || lowerPrompt.includes('meeting')) {
                draft = `Hi,\n\nI wanted to follow up on our recent conversation. I hope this message finds you well.\n\nI'm reaching out to discuss the next steps and see how we can move forward together.\n\nPlease let me know your availability for a quick call this week.\n\nBest regards`;
            } else if (lowerPrompt.includes('schedule') || lowerPrompt.includes('call')) {
                draft = `Hi,\n\nI hope you're doing well. I'd love to schedule a call to discuss this further.\n\nWould any of the following times work for you?\n• [Option 1]\n• [Option 2]\n• [Option 3]\n\nPlease let me know what works best, or feel free to suggest an alternative.\n\nLooking forward to connecting!\n\nBest regards`;
            } else if (lowerPrompt.includes('thank')) {
                draft = `Hi,\n\nThank you so much for taking the time to meet with me today. I really appreciated the opportunity to discuss this with you.\n\nI'm excited about the possibilities we explored and look forward to our next conversation.\n\nPlease don't hesitate to reach out if you have any questions.\n\nWarm regards`;
            } else if (lowerPrompt.includes('reschedule') || lowerPrompt.includes('next week')) {
                draft = `Hi,\n\nI hope you're doing well. I wanted to reach out about rescheduling our meeting.\n\nWould next week work better for you? I'm flexible and can adjust to your schedule.\n\nLet me know what times work best.\n\nBest regards`;
            } else if (lowerPrompt.includes('request') || lowerPrompt.includes('information')) {
                draft = `Hi,\n\nI hope this email finds you well. I'm reaching out to request some information regarding the matter we discussed.\n\nSpecifically, I would appreciate if you could provide:\n• [Point 1]\n• [Point 2]\n\nPlease let me know if you need any additional context from my end.\n\nThank you in advance for your assistance.\n\nBest regards`;
            } else {
                draft = `Hi,\n\n${prompt}\n\nPlease let me know if you have any questions or need additional information.\n\nBest regards`;
            }
            
            return draft;
        }
        
        // ============================================
        // DRAFT SAVING FUNCTIONS
        // ============================================
        let currentDraftId = null;
        let draftSaveTimeout = null;
        
        async function saveDraft() {
            const to = document.getElementById('replyTo')?.value || '';
            const cc = document.getElementById('replyCc')?.value || '';
            const subject = document.getElementById('replySubject')?.value || '';
            const body = document.getElementById('aiReplyText')?.value || '';
            
            // Don't save empty drafts
            if (!to && !subject && !body.trim()) return;
            
            const draftData = {
                to_email: to,
                cc_email: cc,
                subject: subject || 'Draft',
                body: body,
                status: 'draft',
                compose_mode: state.composeMode || 'new',
                reply_to_id: state.currentEmail?.gmail_id || null
            };
            
            try {
                if (currentDraftId) {
                    // Update existing draft
                    await fetch(`${SUPABASE_URL}/rest/v1/drafts?id=eq.${currentDraftId}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=minimal'
                        },
                        body: JSON.stringify(draftData)
                    });
                } else {
                    // Create new draft
                    const response = await fetch(`${SUPABASE_URL}/rest/v1/drafts`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json',
                            'Prefer': 'return=representation'
                        },
                        body: JSON.stringify(draftData)
                    });
                    
                    if (response.ok) {
                        const data = await response.json();
                        if (data && data[0]) {
                            currentDraftId = data[0].id;
                        }
                    }
                }
                
                // Add to emailsWithDrafts set and update UI
                if (state.currentEmail && state.currentEmail.gmail_id) {
                    state.emailsWithDrafts.add(state.currentEmail.gmail_id);
                    
                    // Add DRAFT tag to email list item
                    const emailItem = document.querySelector(`[data-email-id="${state.currentEmail.gmail_id}"] .email-tags-group`);
                    if (emailItem && !emailItem.querySelector('.draft-tag')) {
                        emailItem.insertAdjacentHTML('beforeend', '<span class="email-tag draft-tag">DRAFT</span>');
                    }
                    
                    // Add DRAFT tag to drawer
                    const tagsContainer = document.querySelector('.drawer-tags');
                    if (tagsContainer && !tagsContainer.querySelector('.draft-tag')) {
                        const draftTag = document.createElement('span');
                        draftTag.className = 'email-tag draft-tag';
                        draftTag.textContent = 'DRAFT';
                        tagsContainer.appendChild(draftTag);
                    }
                }
                
                console.log('Draft saved');
            } catch (error) {
                console.error('Draft save error:', error);
            }
        }
        
        function scheduleDraftSave() {
            // Debounce draft saving - save 2 seconds after user stops typing
            if (draftSaveTimeout) clearTimeout(draftSaveTimeout);
            draftSaveTimeout = setTimeout(saveDraft, 2000);
        }
        
        // Load saved draft for an email
        async function loadDraftForEmail(emailGmailId) {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/drafts?reply_to_id=eq.${emailGmailId}&status=eq.draft&order=created_at.desc&limit=1`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                const drafts = await response.json();
                
                if (drafts && drafts.length > 0) {
                    const draft = drafts[0];
                    currentDraftId = draft.id;
                    
                    // Populate fields with saved draft
                    if (draft.body) {
                        document.getElementById('aiReplyText').value = draft.body;
                        document.getElementById('aiReplyText').placeholder = 'Continue your draft...';
                    }
                    if (draft.cc_email) {
                        document.getElementById('replyCc').value = draft.cc_email;
                    }
                    if (draft.to_email) {
                        document.getElementById('replyTo').value = draft.to_email;
                        document.getElementById('replyToText').textContent = draft.to_email;
                    }
                    
                    console.log('Draft loaded for email:', emailGmailId);
                    
                    // Add DRAFT tag to drawer
                    const tagsContainer = document.querySelector('.drawer-tags');
                    if (tagsContainer && !tagsContainer.querySelector('.draft-tag')) {
                        const draftTag = document.createElement('span');
                        draftTag.className = 'email-tag draft-tag';
                        draftTag.textContent = 'DRAFT';
                        tagsContainer.appendChild(draftTag);
                    }
                } else {
                    // No draft - clear fields
                    currentDraftId = null;
                    document.getElementById('aiReplyText').value = '';
                    document.getElementById('aiReplyText').placeholder = 'Write your reply or click Generate for AI draft...';
                    document.getElementById('replyCc').value = '';
                }
            } catch (error) {
                console.error('Error loading draft:', error);
                currentDraftId = null;
            }
        }
        
        async function deleteDraft() {
            // Clear UI first
            document.getElementById('replyTo').value = '';
            document.getElementById('replyCc').value = '';
            document.getElementById('replySubject').value = '';
            document.getElementById('aiReplyText').value = '';
            
            // Delete from database if exists
            if (currentDraftId) {
                try {
                    await fetch(`${SUPABASE_URL}/rest/v1/drafts?id=eq.${currentDraftId}`, {
                        method: 'DELETE',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                        }
                    });
                    console.log('Draft deleted from database');
                } catch (error) {
                    console.error('Draft delete error:', error);
                }
            }
            
            currentDraftId = null;
            
            // Remove from emailsWithDrafts set
            if (state.currentEmail && state.currentEmail.gmail_id) {
                state.emailsWithDrafts.delete(state.currentEmail.gmail_id);
                
                // Remove DRAFT tag from email list item
                const emailItemTag = document.querySelector(`[data-email-id="${state.currentEmail.gmail_id}"] .draft-tag`);
                if (emailItemTag) emailItemTag.remove();
            }
            
            // Remove DRAFT tag from drawer
            const draftTag = document.querySelector('.drawer-tags .draft-tag');
            if (draftTag) draftTag.remove();
            
            closeEmailDrawer();
            showToast('Draft deleted');
            logToChat('action', '🗑️ Draft deleted');
        }
        
        // Log actions to chat widget
        function logToChat(type, message) {
            const container = document.getElementById('chatMessages');
            if (!container) return;
            
            const time = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const msg = document.createElement('div');
            msg.className = `chat-msg ${type === 'action' ? 'user' : 'assistant'}`;
            
            let icon = '';
            if (type === 'system') icon = '<span style="opacity:0.7">🔹</span> ';
            
            msg.innerHTML = `<div class="chat-bubble">${icon}${message}</div><div class="chat-time">${time}</div>`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }

        // Compose new email
        function openComposeNew() {
            const drawer = document.getElementById('emailDrawer');
            const widget = document.getElementById('widgetEmail');
            const isExpanded = widget.classList.contains('expanded') || widget.classList.contains('fullscreen');
            
            drawer.classList.toggle('full-width', !isExpanded);
            drawer.classList.add('open');
            state.emailDrawerOpen = true;
            state.currentEmail = null;
            
            // Reset draft ID for new email
            currentDraftId = null;
            
            // Hide email preview section completely for new emails
            document.getElementById('drawerSubject').textContent = 'New Email';
            document.querySelector('.drawer-sender-row').style.display = 'none';
            document.querySelector('.drawer-tags').style.display = 'none';
            document.getElementById('drawerBody').style.display = 'none';
            
            // Hide ALL drawer action buttons for new email (Reply/Forward/Done/More - not relevant)
            document.querySelector('.drawer-actions').style.display = 'none';
            
            // Hide reply thread toggle for new emails (not relevant)
            document.querySelector('.reply-thread-toggle').style.display = 'none';
            document.getElementById('replyThreadCard').classList.remove('visible');
            
            // Show reply fields for composing
            document.getElementById('replyFields').style.display = 'flex';
            document.getElementById('replyTo').value = '';
            document.getElementById('replyToText').textContent = 'Add recipient...';
            document.getElementById('replyToText').style.display = 'none';
            document.getElementById('replyTo').style.display = 'block';
            document.getElementById('replyTo').classList.add('active');
            document.getElementById('replyCc').value = '';
            document.getElementById('replyModeLabel').textContent = 'New Email';
            document.getElementById('replyModeDesc').textContent = 'Compose';
            document.getElementById('aiReplyText').placeholder = 'Write your message or describe what you want and click Generate...';
            document.getElementById('aiReplyText').value = '';
            
            // Show subject field for new emails
            document.getElementById('subjectFieldRow').style.display = 'flex';
            document.getElementById('replySubject').value = '';
            
            // Reset Cc/Bcc
            document.getElementById('ccFieldRow').style.display = 'none';
            document.getElementById('bccFieldRow').style.display = 'none';
            document.getElementById('addCcLink').style.display = 'inline';
            document.getElementById('addBccLink').style.display = 'inline';
            
            state.composeMode = 'new';
            document.getElementById('replyTo').focus();
        }

        // Inline editing functions
        function makeEditable(fieldId) {
            const textEl = document.getElementById(fieldId + 'Text');
            const inputEl = document.getElementById(fieldId);
            if (textEl) textEl.style.display = 'none';
            inputEl.classList.add('active');
            inputEl.style.display = 'block';
            inputEl.focus();
        }
        
        function hideEditable(fieldId) {
            const textEl = document.getElementById(fieldId + 'Text');
            const inputEl = document.getElementById(fieldId);
            if (inputEl.value) {
                if (textEl) {
                    textEl.textContent = inputEl.value;
                    textEl.style.display = 'inline';
                }
            } else {
                if (textEl) textEl.style.display = 'inline';
            }
            inputEl.classList.remove('active');
            inputEl.style.display = 'none';
        }
        
        // Show/hide Cc/Bcc fields
        function showCcField() {
            document.getElementById('ccFieldRow').style.display = 'flex';
            document.getElementById('addCcLink').style.display = 'none';
            document.getElementById('replyCc').focus();
        }
        
        function hideCcField() {
            document.getElementById('ccFieldRow').style.display = 'none';
            document.getElementById('replyCc').value = '';
            document.getElementById('addCcLink').style.display = 'inline';
        }
        
        function showBccField() {
            document.getElementById('bccFieldRow').style.display = 'flex';
            document.getElementById('addBccLink').style.display = 'none';
            document.getElementById('replyBcc').focus();
        }
        
        function hideBccField() {
            document.getElementById('bccFieldRow').style.display = 'none';
            document.getElementById('replyBcc').value = '';
            document.getElementById('addBccLink').style.display = 'inline';
        }

        // ==================== SCHEDULE & REMIND ====================
        
        function openScheduleMenu(event) {
            event.stopPropagation();
            event.preventDefault();
            
            const btn = event.currentTarget;
            const dropdown = document.getElementById('scheduleDropdown');
            
            // Move dropdown to body for proper fixed positioning
            if (dropdown.parentElement !== document.body) {
                document.body.appendChild(dropdown);
            }
            
            // Remove any existing active state first
            dropdown.classList.remove('active');
            
            // Get button dimensions
            const rect = btn.getBoundingClientRect();
            
            // Temporarily show to calculate height
            dropdown.style.visibility = 'hidden';
            dropdown.style.display = 'block';
            
            const dropdownHeight = dropdown.offsetHeight;
            const dropdownWidth = dropdown.offsetWidth;
            
            // Position dropdown above button
            let top = rect.top - dropdownHeight - 8;
            let left = rect.left - (dropdownWidth / 2) + (rect.width / 2);
            
            // Keep in viewport
            if (top < 10) top = rect.bottom + 8; // Show below if not enough space above
            if (left < 10) left = 10;
            if (left + dropdownWidth > window.innerWidth - 10) {
                left = window.innerWidth - dropdownWidth - 10;
            }
            
            dropdown.style.left = left + 'px';
            dropdown.style.top = top + 'px';
            dropdown.style.bottom = 'auto';
            dropdown.style.visibility = 'visible';
            dropdown.classList.add('active');
            
            // Close on outside click
            const closeDropdown = (e) => {
                if (!e.target.closest('.schedule-dropdown') && !e.target.closest('.btn-schedule')) {
                    dropdown.classList.remove('active');
                    dropdown.style.display = '';
                    document.removeEventListener('click', closeDropdown);
                }
            };
            setTimeout(() => document.addEventListener('click', closeDropdown), 10);
        }
        
        function scheduleSend(when) {
            document.getElementById('scheduleDropdown').classList.remove('active');
            const times = {
                '1h': 'in 1 hour',
                'tomorrow_morning': 'Tomorrow at 8:00 AM',
                'tomorrow_afternoon': 'Tomorrow at 1:00 PM'
            };
            showToastWithUndo(`Email scheduled: ${times[when] || when}`, () => {
                showToast('Schedule cancelled');
            });
        }
        
        function openCustomSchedule() {
            document.getElementById('scheduleDropdown').classList.remove('active');
            showToast('Custom scheduling coming soon');
        }
        
        function setReminder(when) {
            document.getElementById('scheduleDropdown').classList.remove('active');
            const times = {
                'tomorrow_morning': 'Tomorrow morning',
                'tomorrow_afternoon': 'Tomorrow afternoon',
                'monday_morning': 'Monday morning',
                'next_week': 'Next week'
            };
            const condition = state.remindCondition || 'if no reply';
            showToastWithUndo(`Reminder set: ${times[when]} ${condition}`, () => {
                showToast('Reminder cancelled');
            });
            
            // Create task for reminder
            if (state.currentEmail) {
                // TODO: Create task linked to email
                console.log('Creating reminder task for email:', state.currentEmail.subject);
            }
        }
        
        function openRemindMeModal() {
            document.getElementById('scheduleDropdown').classList.remove('active');
            document.getElementById('remindModal').classList.add('active');
            document.getElementById('remindInput').focus();
            updateRemindSuggestionTimes();
        }
        
        function closeRemindModal() {
            document.getElementById('remindModal').classList.remove('active');
            document.getElementById('remindInput').value = '';
        }
        
        function handleRemindInput(value) {
            // Smart autocomplete for remind input
            const suggestions = document.getElementById('remindSuggestions');
            const input = value.toLowerCase().trim();
            
            if (!input) {
                updateRemindSuggestionTimes();
                return;
            }
            
            // Parse natural language input
            let html = '';
            
            if (input.match(/^\d+$/)) {
                // Just a number - suggest AM/PM times
                const num = parseInt(input);
                if (num >= 1 && num <= 12) {
                    html += `<div class="remind-suggestion" onclick="selectCustomTime('${num}:00 AM')">
                        <span class="remind-suggestion-label">${num}:00 AM</span>
                        <span class="remind-suggestion-time">Today</span>
                    </div>`;
                    html += `<div class="remind-suggestion" onclick="selectCustomTime('${num}:00 PM')">
                        <span class="remind-suggestion-label">${num}:00 PM</span>
                        <span class="remind-suggestion-time">Today</span>
                    </div>`;
                }
            } else if (input.match(/\d+\s*(day|days)/)) {
                const days = parseInt(input.match(/(\d+)/)[1]);
                const date = new Date();
                date.setDate(date.getDate() + days);
                html += `<div class="remind-suggestion selected" onclick="selectCustomTime('${days} days')">
                    <span class="remind-suggestion-label">${days} day${days > 1 ? 's' : ''} from now</span>
                    <span class="remind-suggestion-time">${date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric' })}, 8:00 AM</span>
                </div>`;
            } else if (input.includes('tom')) {
                html += `<div class="remind-suggestion selected" onclick="selectReminder('tomorrow_morning')">
                    <span class="remind-suggestion-label">tomorrow morning</span>
                    <span class="remind-suggestion-time" id="tomorrowMorningTime">8:00 AM</span>
                </div>`;
                html += `<div class="remind-suggestion" onclick="selectReminder('tomorrow_afternoon')">
                    <span class="remind-suggestion-label">tomorrow afternoon</span>
                    <span class="remind-suggestion-time">1:00 PM</span>
                </div>`;
            } else if (input.includes('mon')) {
                html += `<div class="remind-suggestion selected" onclick="selectReminder('monday_morning')">
                    <span class="remind-suggestion-label">Monday morning</span>
                    <span class="remind-suggestion-time">8:00 AM</span>
                </div>`;
            } else if (input.includes('next')) {
                html += `<div class="remind-suggestion selected" onclick="selectReminder('next_week')">
                    <span class="remind-suggestion-label">next week</span>
                    <span class="remind-suggestion-time">Monday, 8:00 AM</span>
                </div>`;
            }
            
            if (html) {
                suggestions.innerHTML = html;
            }
        }
        
        function updateRemindSuggestionTimes() {
            const now = new Date();
            const tomorrow = new Date(now);
            tomorrow.setDate(tomorrow.getDate() + 1);
            
            // Find next Monday
            const nextMonday = new Date(now);
            nextMonday.setDate(nextMonday.getDate() + ((1 + 7 - nextMonday.getDay()) % 7 || 7));
            
            const nextWeek = new Date(now);
            nextWeek.setDate(nextWeek.getDate() + 7);
            
            const formatDay = (d) => d.toLocaleDateString('en-US', { weekday: 'short' }).toUpperCase();
            
            document.getElementById('tomorrowMorningTime').textContent = `${formatDay(tomorrow)}, 8:00 AM`;
            document.getElementById('tomorrowAfternoonTime').textContent = `${formatDay(tomorrow)}, 1:00 PM`;
            document.getElementById('mondayMorningTime').textContent = `${formatDay(nextMonday)}, 8:00 AM`;
            document.getElementById('nextWeekTime').textContent = `${formatDay(nextWeek)}, ${nextWeek.toLocaleDateString('en-US', { month: 'short', day: 'numeric' })}, 8:00 AM`;
        }
        
        function selectCustomTime(time) {
            closeRemindModal();
            const condition = state.remindCondition || 'if no reply';
            showToastWithUndo(`Reminder set: ${time} ${condition}`, () => {
                showToast('Reminder cancelled');
            });
        }
        
        function selectReminder(when) {
            closeRemindModal();
            setReminder(when);
        }
        
        function toggleRemindCondition() {
            const conditions = ['if no reply', 'always', 'if not opened'];
            const current = state.remindCondition || 'if no reply';
            const idx = conditions.indexOf(current);
            state.remindCondition = conditions[(idx + 1) % conditions.length];
            document.getElementById('remindCondition').textContent = state.remindCondition + ' ▾';
        }
        
        function confirmReminder() {
            const input = document.getElementById('remindInput').value;
            if (input) {
                selectCustomTime(input);
            } else {
                selectReminder('tomorrow_morning');
            }
        }
        
        // ==================== EMAIL SEARCH ====================
        
        let searchTimeout = null;
        
        function searchEmails(query) {
            const clearBtn = document.getElementById('searchClear');
            clearBtn.style.display = query ? 'flex' : 'none';
            
            // Debounce search
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                performSearch(query);
            }, 300);
        }
        
        function performSearch(query) {
            if (!query.trim()) {
                renderEmails();
                return;
            }
            
            const q = query.toLowerCase();
            const list = document.getElementById('emailList');
            
            const filtered = state.emails.filter(email => {
                return (
                    (email.sender_name || '').toLowerCase().includes(q) ||
                    (email.sender_email || '').toLowerCase().includes(q) ||
                    (email.subject || '').toLowerCase().includes(q) ||
                    (email.body_preview || '').toLowerCase().includes(q) ||
                    (email.category || '').toLowerCase().includes(q)
                );
            });
            
            if (filtered.length === 0) {
                list.innerHTML = `<div class="email-empty">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="11" cy="11" r="8"/><path d="m21 21-4.35-4.35"/></svg>
                    <span>No emails found for "${escapeHtml(query)}"</span>
                </div>`;
                return;
            }
            
            // Render filtered emails
            list.innerHTML = filtered.map(email => {
                const emailIndex = state.emails.indexOf(email);
                const priorityMap = { 1: 'P1', 2: 'P2', 3: 'P3', 4: 'P3', 5: 'P3' };
                const priorityLabel = priorityMap[email.priority] || 'P3';
                const priorityClass = priorityLabel.toLowerCase();
                const categoryName = (email.category || 'fyi').toLowerCase().replace(/\s+/g, '');
                const initials = (email.sender_name || 'U').split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
                const accountColor = email.account_color || '#4EB4F9';
                const accountName = email.account_name || 'Primary';
                
                const emailDate = new Date(email.received_at);
                const now = new Date();
                const diffHours = (now - emailDate) / (1000 * 60 * 60);
                let timeDisplay = '';
                if (diffHours < 24) {
                    timeDisplay = emailDate.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
                } else if (diffHours < 48) {
                    timeDisplay = 'Yesterday';
                } else {
                    timeDisplay = emailDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
                }
                
                return `
                <div class="email-item ${priorityClass} ${email.is_read ? 'read' : 'unread'}" onclick="event.stopPropagation(); openEmailByIndex(${emailIndex})" data-email-id="${email.gmail_id}">
                    <div class="email-avatar">${initials}</div>
                    <div class="email-account-dot" style="background: ${accountColor}" title="${accountName}"></div>
                    <div class="email-content">
                        <span class="email-sender">${escapeHtml(email.sender_name || 'Unknown')}</span>
                        <span class="email-tags-group">
                            <span class="email-tag ${priorityClass}">${priorityLabel}</span>
                            <span class="email-tag category ${categoryName}">${(email.category || 'FYI').toUpperCase()}</span>
                        </span>
                        <span class="email-subject">${escapeHtml(email.subject || 'No Subject')}</span>
                        <span class="email-preview">${escapeHtml(getCleanPreview(email))}</span>
                    </div>
                    <span class="email-time">${timeDisplay}</span>
                </div>`;
            }).join('');
        }
        
        function clearSearch() {
            document.getElementById('emailSearchInput').value = '';
            document.getElementById('searchClear').style.display = 'none';
            renderEmails();
        }
        
        // Toast with UNDO option
        function showToastWithUndo(message, undoCallback) {
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(23, 23, 37, 0.95);
                color: white;
                padding: 12px 20px;
                border-radius: 10px;
                font-size: 12px;
                z-index: 99999;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.1);
                display: flex;
                align-items: center;
                gap: 16px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.3);
            `;
            toast.innerHTML = `
                <span style="border-left: 3px solid var(--admin-color); padding-left: 10px;">${message}</span>
                <button onclick="this.parentElement.undoAction(); this.parentElement.remove();" style="background: none; border: none; color: #4EB4F9; font-weight: 600; cursor: pointer; font-size: 12px;">UNDO</button>
                <button onclick="this.parentElement.remove();" style="background: none; border: none; color: rgba(255,255,255,0.4); cursor: pointer; font-size: 16px;">×</button>
            `;
            toast.undoAction = undoCallback;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 8000);
        }

        function showToast(message) {
            // Simple toast notification
            const toast = document.createElement('div');
            toast.style.cssText = `
                position: fixed;
                bottom: 80px;
                left: 50%;
                transform: translateX(-50%);
                background: rgba(23, 23, 37, 0.95);
                color: white;
                padding: 10px 20px;
                border-radius: 8px;
                font-size: 12px;
                z-index: 99999;
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255,255,255,0.1);
                animation: fadeInUp 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 2500);
        }

        // Chat & Voice
        // ═══════════════════════════════════════════════════════════════
        // CHAT INPUT & VOICE RECORDING - ELEVENLABS IMPLEMENTATION
        // ═══════════════════════════════════════════════════════════════
        
        // Recording state and audio analysis
        const MAX_BARS = 400;
        const MIN_HEIGHT = 3;
        const MAX_HEIGHT = 28;
        const SILENCE_THRESHOLD = 0.08;
        
        let recording = null;
        let audioContext = null;
        let analyser = null;
        let waveformInterval = null;
        let voiceTimerInterval = null;
        let simulatedIntensityTarget = 0;
        let simulatedIntensityCurrent = 0;
        let simulatedSpeaking = false;
        
        // ElevenLabs API Key
        const ELEVENLABS_API_KEY = 'sk_22d550a1aecd2627750e50b5cf337ef5372bbbbcd35c8b71';
        
        // Handle chat input - auto-resize textarea
        function handleChatInput() {
            const input = document.getElementById('chatInput');
            const inputRow = document.getElementById('chatInputRow');
            const btn = document.getElementById('actionBtn');
            const hasText = input.value.trim().length > 0;
            
            // Auto-resize textarea
            const maxHeight = Math.floor(window.innerHeight * 0.25); // 25% of viewport
            input.style.height = 'auto';
            const scrollHeight = input.scrollHeight;
            
            if (scrollHeight <= maxHeight) {
                input.style.height = scrollHeight + 'px';
                input.classList.remove('scrollable');
                input.style.overflowY = 'hidden';
            } else {
                input.style.height = maxHeight + 'px';
                input.classList.add('scrollable');
                input.style.overflowY = 'auto';
            }
            
            // Update border radius based on height
            if (scrollHeight > 50) {
                inputRow.classList.add('expanded');
            } else {
                inputRow.classList.remove('expanded');
            }
            
            // Toggle mic/send icon
            if (hasText) {
                btn.classList.add('has-text');
                btn.classList.remove('recording');
            } else {
                btn.classList.remove('has-text');
            }
        }
        
        // Handle keydown for Enter/Shift+Enter behavior
        function handleChatKeydown(event) {
            if (event.key === 'Enter') {
                if (event.shiftKey) {
                    // Shift+Enter: allow new line (default behavior)
                    return;
                } else {
                    // Enter alone: send message
                    event.preventDefault();
                    handleChatSend();
                }
            }
        }
        
        // Reset textarea after sending
        function resetTextarea() {
            const input = document.getElementById('chatInput');
            const inputRow = document.getElementById('chatInputRow');
            input.style.height = '36px';
            input.classList.remove('scrollable');
            input.style.overflowY = 'hidden';
            inputRow.classList.remove('expanded');
        }
        
        // Handle send (Enter key)
        function handleChatSend() {
            const input = document.getElementById('chatInput');
            if (input.value.trim()) {
                addChatMessage('user', input.value);
                input.value = '';
                resetTextarea();
                handleChatInput();
                // TODO: Send to AI backend
                simulateAIResponse();
            }
        }
        
        // Handle action button click (mic/send/stop)
        function handleAction() {
            const input = document.getElementById('chatInput');
            const btn = document.getElementById('actionBtn');
            const hasText = input.value.trim().length > 0;
            
            if (btn.classList.contains('recording')) {
                stopRecording();
            } else if (hasText) {
                addChatMessage('user', input.value);
                input.value = '';
                resetTextarea();
                handleChatInput();
                btn.classList.remove('has-text');
                simulateAIResponse();
            } else {
                startRecording();
            }
        }
        
        // Get voice intensity from analyser
        function getVoiceIntensity() {
            if (!analyser) return 0;
            
            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);
            
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length / 255;
            
            if (average < SILENCE_THRESHOLD) return 0;
            return Math.min(1, (average - SILENCE_THRESHOLD) / (1 - SILENCE_THRESHOLD) * 2.0);
        }
        
        // Simulated intensity when no mic
        function getSimulatedIntensity() {
            const diff = simulatedIntensityTarget - simulatedIntensityCurrent;
            simulatedIntensityCurrent += diff * 0.3;
            
            if (simulatedSpeaking && simulatedIntensityCurrent > 0.1) {
                return simulatedIntensityCurrent + (Math.random() - 0.5) * 0.3;
            }
            return Math.max(0, simulatedIntensityCurrent);
        }
        
        // Update waveform - add bar and scroll left
        function updateWaveform() {
            const barsContainer = document.getElementById('waveBars');
            if (!barsContainer) return;
            
            const intensity = recording?.simulated 
                ? getSimulatedIntensity() 
                : getVoiceIntensity();
            
            const height = MIN_HEIGHT + (intensity * (MAX_HEIGHT - MIN_HEIGHT));
            
            const bar = document.createElement('div');
            bar.className = 'wave-bar';
            bar.style.height = height + 'px';
            barsContainer.appendChild(bar);
            
            while (barsContainer.children.length > MAX_BARS) {
                barsContainer.removeChild(barsContainer.firstChild);
            }
        }
        
        // Update voice timer
        function updateVoiceTimer() {
            const timerEl = document.getElementById('voiceTimer');
            if (!recording || !timerEl) return;
            
            const elapsed = (Date.now() - recording.startTime) / 1000;
            const minutes = Math.floor(elapsed / 60);
            const seconds = Math.floor(elapsed % 60);
            timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        // Start recording with real microphone
        async function startRecording() {
            const inputRow = document.getElementById('chatInputRow');
            const btn = document.getElementById('actionBtn');
            const barsContainer = document.getElementById('waveBars');
            const input = document.getElementById('chatInput');
            
            barsContainer.innerHTML = '';
            simulatedIntensityCurrent = 0;
            simulatedIntensityTarget = 0;
            simulatedSpeaking = false;
            
            // Clear input
            input.value = '';
            
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 256;
                analyser.smoothingTimeConstant = 0.4;
                source.connect(analyser);
                
                // Setup MediaRecorder for actual audio capture
                const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                const audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await transcribeWithElevenLabs(audioBlob);
                };
                
                mediaRecorder.start();
                
                recording = { stream, startTime: Date.now(), mediaRecorder };
                
            } catch (err) {
                console.log('Mic access denied, using simulation');
                recording = { startTime: Date.now(), simulated: true };
                
                // Simulate speaking patterns
                const simInterval = setInterval(() => {
                    if (!recording) { clearInterval(simInterval); return; }
                    if (Math.random() < 0.15) {
                        simulatedSpeaking = !simulatedSpeaking;
                    }
                    simulatedIntensityTarget = simulatedSpeaking ? 0.4 + Math.random() * 0.6 : 0;
                }, 250);
            }
            
            inputRow.classList.add('recording');
            btn.classList.add('recording');
            btn.classList.remove('has-text');
            
            waveformInterval = setInterval(updateWaveform, 80);
            
            updateVoiceTimer();
            voiceTimerInterval = setInterval(updateVoiceTimer, 100);
        }
        
        // ElevenLabs Speech-to-Text
        async function transcribeWithElevenLabs(audioBlob) {
            const input = document.getElementById('chatInput');
            const btn = document.getElementById('actionBtn');
            const sphere = document.getElementById('transcriptionSphere');
            
            // Show glass sphere, hide button
            btn.style.display = 'none';
            sphere.classList.add('active');
            input.placeholder = '';
            
            try {
                const formData = new FormData();
                formData.append('file', audioBlob, 'recording.webm');
                formData.append('model_id', 'scribe_v1');
                formData.append('language_code', 'eng'); // English for PULSE Admin
                
                const response = await fetch('https://api.elevenlabs.io/v1/speech-to-text', {
                    method: 'POST',
                    headers: {
                        'xi-api-key': ELEVENLABS_API_KEY
                    },
                    body: formData
                });
                
                if (!response.ok) {
                    throw new Error(`ElevenLabs API error: ${response.status}`);
                }
                
                const result = await response.json();
                const transcription = result.text || '';
                
                // Hide sphere, show button
                sphere.classList.remove('active');
                btn.style.display = 'flex';
                
                if (transcription.trim()) {
                    input.value = transcription.trim();
                    input.placeholder = 'Ask anything...';
                    handleChatInput();
                    showToast('🎤 Transcription complete');
                    console.log('✅ ElevenLabs transcription:', transcription);
                } else {
                    input.placeholder = 'Ask anything...';
                    showToast('❌ No speech detected');
                }
                
            } catch (error) {
                console.error('❌ ElevenLabs STT error:', error);
                
                // Hide sphere, show button
                sphere.classList.remove('active');
                btn.style.display = 'flex';
                
                input.placeholder = 'Ask anything...';
                showToast('❌ Transcription error - please try again');
            }
        }
        
        // Stop recording
        function stopRecording() {
            const inputRow = document.getElementById('chatInputRow');
            const btn = document.getElementById('actionBtn');
            const barsContainer = document.getElementById('waveBars');
            const input = document.getElementById('chatInput');
            const sphere = document.getElementById('transcriptionSphere');
            
            const isSimulated = recording?.simulated;
            const hasRealRecording = recording?.mediaRecorder;
            
            // Show sphere immediately when stopping (for real recordings)
            if (hasRealRecording) {
                btn.style.display = 'none';
                sphere.classList.add('active');
            }
            
            // Stop MediaRecorder (triggers ondataavailable and onstop)
            if (recording?.mediaRecorder && recording.mediaRecorder.state === 'recording') {
                recording.mediaRecorder.stop();
            }
            
            if (recording?.stream) {
                recording.stream.getTracks().forEach(track => track.stop());
            }
            if (audioContext) {
                audioContext.close();
            }
            if (waveformInterval) {
                clearInterval(waveformInterval);
            }
            if (voiceTimerInterval) {
                clearInterval(voiceTimerInterval);
            }
            
            if (barsContainer) barsContainer.innerHTML = '';
            
            inputRow.classList.remove('recording');
            btn.classList.remove('recording');
            
            // Handle simulated mode (no mic permission)
            if (isSimulated) {
                btn.style.display = 'none';
                sphere.classList.add('active');
                
                setTimeout(() => {
                    sphere.classList.remove('active');
                    btn.style.display = 'flex';
                    input.placeholder = 'Ask anything...';
                    showToast('⚠️ Microphone access required for voice input');
                }, 1500);
            }
            
            recording = null;
            audioContext = null;
            analyser = null;
            
            const timerEl = document.getElementById('voiceTimer');
            if (timerEl) timerEl.textContent = '0:00';
        }
        
        // Simulate AI response (placeholder for Master Mind integration)
        function simulateAIResponse() {
            setTimeout(() => {
                const responses = [
                    "I've analyzed your inbox. You have 3 high-priority emails that need attention.",
                    "I'm drafting a response based on your previous communication style...",
                    "Your tasks for today are organized by priority. Would you like me to walk you through them?"
                ];
                addChatMessage('ai', responses[Math.floor(Math.random() * responses.length)]);
            }, 1500);
        }

        function addChatMessage(type, content) {
            const container = document.getElementById('chatMessages');
            const time = new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' });
            const msg = document.createElement('div');
            msg.className = `chat-msg ${type}`;
            msg.innerHTML = `<div class="chat-bubble">${escapeHtml(content)}</div><div class="chat-time">${time}</div>`;
            container.appendChild(msg);
            container.scrollTop = container.scrollHeight;
        }
        
        // ═══════════════════════════════════════════════════════════════
        // CHAT ATTACHMENT MENU
        // ═══════════════════════════════════════════════════════════════
        
        function toggleChatAttach() {
            const menu = document.getElementById('chatAttachMenu');
            menu.classList.toggle('show');
        }
        
        function closeChatAttach() {
            document.getElementById('chatAttachMenu').classList.remove('show');
        }
        
        function chatAttachAction(type) {
            closeChatAttach();
            if (type === 'photo') {
                document.getElementById('chatCameraInput').click();
            } else if (type === 'file') {
                document.getElementById('chatFileInput').click();
            }
        }
        
        function handleChatFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            // For now, just show a toast - will integrate with chat later
            showToast(`📎 ${file.name} selected`);
            addChatMessage('user', `[Attached: ${file.name}]`);
            
            // Reset input
            event.target.value = '';
        }

        function toggleTask(el) {
            event.stopPropagation();
            el.querySelector('.task-checkbox').classList.toggle('checked');
            el.classList.toggle('completed');
        }

        function closeVoiceOverlay() {
            document.getElementById('voiceOverlay').classList.remove('active');
        }

        // Context menu
        document.getElementById('workspace').addEventListener('contextmenu', e => {
            if (e.target.closest('.widget, .admin-bar, .voice-note')) return;
            e.preventDefault();
            const menu = document.getElementById('contextMenu');
            menu.style.left = e.clientX + 'px';
            menu.style.top = e.clientY + 'px';
            menu.classList.add('active');
        });

        document.addEventListener('click', e => {
            if (!e.target.closest('.context-menu')) {
                document.getElementById('contextMenu').classList.remove('active');
            }
            
            // Close chat attach menu when clicking outside
            if (!e.target.closest('.chat-attach-menu') && !e.target.closest('.plus-btn')) {
                closeChatAttach();
            }
            
            // REMOVED: Click outside email widget no longer collapses it
            // User must click the X button to close the email widget
        });

        // ============================================
        // TAG PICKER FUNCTIONS
        // ============================================
        let currentPickerGmailId = null;
        
        function showPriorityPicker(gmailId, currentPriority) {
            currentPickerGmailId = gmailId;
            const picker = document.getElementById('priorityPicker');
            const categoryPicker = document.getElementById('categoryPicker');
            categoryPicker.classList.remove('active');
            
            // Position near the clicked tag
            const tag = document.querySelector('.drawer-tags .p1, .drawer-tags .p2, .drawer-tags .p3');
            if (tag) {
                const rect = tag.getBoundingClientRect();
                picker.style.left = rect.left + 'px';
                picker.style.top = (rect.bottom + 8) + 'px';
            }
            
            // Mark current selection
            picker.querySelectorAll('.tag-picker-option').forEach(opt => {
                opt.classList.toggle('selected', parseInt(opt.dataset.value) === currentPriority);
            });
            
            picker.classList.add('active');
            
            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closePickers, { once: true });
            }, 10);
        }
        
        function showCategoryPicker(gmailId, currentCategory) {
            currentPickerGmailId = gmailId;
            const picker = document.getElementById('categoryPicker');
            const priorityPicker = document.getElementById('priorityPicker');
            priorityPicker.classList.remove('active');
            
            // Position near the clicked tag
            const tag = document.querySelector('.drawer-tags .email-tag:last-child');
            if (tag) {
                const rect = tag.getBoundingClientRect();
                picker.style.left = rect.left + 'px';
                picker.style.top = (rect.bottom + 8) + 'px';
            }
            
            // Mark current selection
            picker.querySelectorAll('.tag-picker-option').forEach(opt => {
                opt.classList.toggle('selected', opt.dataset.value === currentCategory.toLowerCase());
            });
            
            picker.classList.add('active');
            
            // Close when clicking outside
            setTimeout(() => {
                document.addEventListener('click', closePickers, { once: true });
            }, 10);
        }
        
        function closePickers() {
            document.getElementById('priorityPicker').classList.remove('active');
            document.getElementById('categoryPicker').classList.remove('active');
        }
        
        async function setPriority(priority) {
            if (!currentPickerGmailId) return;
            closePickers();
            
            try {
                // Update in Supabase
                await fetch(`${SUPABASE_URL}/rest/v1/emails?gmail_id=eq.${currentPickerGmailId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ priority: priority })
                });
                
                // Update local state
                const email = state.emails.find(e => e.gmail_id === currentPickerGmailId);
                if (email) email.priority = priority;
                if (state.currentEmail && state.currentEmail.gmail_id === currentPickerGmailId) {
                    state.currentEmail.priority = priority;
                }
                
                // Learn from this: save sender preference
                if (state.currentEmail) {
                    saveSenderPreference(state.currentEmail.sender_email, 'priority', priority);
                }
                
                // Auto-switch filter based on priority
                // P1/P2 = Focused, P3 = Others (always)
                if (priority === 1 || priority === 2) {
                    switchFilter('focused');
                } else {
                    // P3 always goes to Others
                    switchFilter('others');
                }
                
                // Update UI
                renderEmails();
                const priorityMap = { 1: 'P1', 2: 'P2', 3: 'P3' };
                const tagsContainer = document.querySelector('.drawer-tags');
                if (tagsContainer) {
                    const priorityTag = tagsContainer.querySelector('.p1, .p2, .p3');
                    if (priorityTag) {
                        priorityTag.className = `email-tag ${priorityMap[priority].toLowerCase()} clickable`;
                        priorityTag.textContent = priorityMap[priority];
                        priorityTag.onclick = () => showPriorityPicker(currentPickerGmailId, priority);
                    }
                }
                
                showToast(`Priority set to ${priorityMap[priority]}`);
            } catch (error) {
                console.error('Error setting priority:', error);
                showToast('Failed to update priority');
            }
        }
        
        async function setCategory(category) {
            if (!currentPickerGmailId) return;
            closePickers();
            
            try {
                // Update in Supabase
                await fetch(`${SUPABASE_URL}/rest/v1/emails?gmail_id=eq.${currentPickerGmailId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ category: category })
                });
                
                // Update local state
                const email = state.emails.find(e => e.gmail_id === currentPickerGmailId);
                if (email) email.category = category;
                if (state.currentEmail && state.currentEmail.gmail_id === currentPickerGmailId) {
                    state.currentEmail.category = category;
                }
                
                // Learn from this: save sender preference
                if (state.currentEmail) {
                    saveSenderPreference(state.currentEmail.sender_email, 'category', category);
                }
                
                // Update UI
                renderEmails();
                const tagsContainer = document.querySelector('.drawer-tags');
                if (tagsContainer) {
                    const categoryTag = tagsContainer.querySelector('.email-tag:last-child:not(.draft-tag)');
                    if (categoryTag) {
                        categoryTag.className = `email-tag ${category.toLowerCase()} clickable`;
                        categoryTag.textContent = category.toUpperCase();
                        categoryTag.onclick = () => showCategoryPicker(currentPickerGmailId, category);
                    }
                }
                
                showToast(`Category set to ${category}`);
            } catch (error) {
                console.error('Error setting category:', error);
                showToast('Failed to update category');
            }
        }
        
        // Save sender preference for learning
        async function saveSenderPreference(senderEmail, preferenceType, value) {
            if (!senderEmail) return;
            
            try {
                // Check if preference exists
                const response = await fetch(`${SUPABASE_URL}/rest/v1/sender_preferences?sender_email=eq.${encodeURIComponent(senderEmail)}`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                const existing = await response.json();
                const prefData = {
                    sender_email: senderEmail,
                    [preferenceType === 'priority' ? 'default_priority' : 'default_category']: value,
                    updated_at: new Date().toISOString()
                };
                
                if (existing && existing.length > 0) {
                    // Update existing
                    await fetch(`${SUPABASE_URL}/rest/v1/sender_preferences?sender_email=eq.${encodeURIComponent(senderEmail)}`, {
                        method: 'PATCH',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(prefData)
                    });
                } else {
                    // Create new
                    await fetch(`${SUPABASE_URL}/rest/v1/sender_preferences`, {
                        method: 'POST',
                        headers: {
                            'apikey': SUPABASE_ANON_KEY,
                            'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(prefData)
                    });
                }
                
                console.log(`Saved preference for ${senderEmail}: ${preferenceType} = ${value}`);
            } catch (error) {
                console.error('Error saving sender preference:', error);
            }
        }

        // ═══════════════════════════════════════════════════════════════
        // STICKY NOTES - With Supabase persistence
        // ═══════════════════════════════════════════════════════════════
        
        const STICKY_COLORS = ['yellow', 'pink', 'blue', 'green', 'purple', 'orange'];
        let stickyNoteCounter = 0;
        let contextMenuPosition = { x: 0, y: 0 };
        
        // Store context menu position for note placement
        document.getElementById('workspace').addEventListener('contextmenu', (e) => {
            contextMenuPosition.x = e.clientX;
            contextMenuPosition.y = e.clientY;
        });
        
        async function addStickyNote() {
            document.getElementById('contextMenu').classList.remove('active');
            
            const workspace = document.getElementById('workspace');
            const content = document.getElementById('workspaceContent');
            
            // Calculate position in content space
            const scrollLeft = workspace.scrollLeft;
            const scrollTop = workspace.scrollTop;
            const noteX = (contextMenuPosition.x + scrollLeft) / state.zoom;
            const noteY = (contextMenuPosition.y + scrollTop) / state.zoom;
            
            // Random color
            const color = STICKY_COLORS[Math.floor(Math.random() * STICKY_COLORS.length)];
            
            // Generate unique ID
            stickyNoteCounter++;
            const noteId = 'sticky-' + Date.now() + '-' + stickyNoteCounter;
            
            // Create sticky note HTML
            const note = document.createElement('div');
            note.className = `sticky-note ${color} visible`;
            note.id = noteId;
            note.style.left = noteX + 'px';
            note.style.top = noteY + 'px';
            note.innerHTML = `
                <div class="sticky-note-header">
                    <input type="text" class="sticky-note-title" placeholder="Title..." value="" onblur="saveStickyNote('${noteId}')" onkeydown="if(event.key==='Enter'){this.blur();}">
                    <button class="sticky-note-delete" onclick="deleteStickyNote('${noteId}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                </div>
                <div class="sticky-note-content">
                    <textarea class="sticky-note-text" placeholder="Write something..." onblur="saveStickyNote('${noteId}')"></textarea>
                </div>
                <div class="sticky-note-footer">${new Date().toLocaleDateString()}</div>
            `;
            
            content.appendChild(note);
            
            // Make it draggable
            makeStickyDraggable(note);
            
            // Focus title
            note.querySelector('.sticky-note-title').focus();
            
            // Save to Supabase
            await saveStickyNoteToSupabase(noteId, '', '', noteX, noteY, color);
            
            showToast('📝 Sticky note created');
            showMiniMap();
        }
        
        function makeStickyDraggable(note) {
            let isDragging = false;
            let startX, startY, origX, origY;
            
            note.addEventListener('mousedown', (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.closest('.sticky-note-delete')) return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                origX = parseInt(note.style.left) || 0;
                origY = parseInt(note.style.top) || 0;
                
                note.style.zIndex = ++state.highestZIndex;
                note.style.cursor = 'grabbing';
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const dx = (e.clientX - startX) / state.zoom;
                const dy = (e.clientY - startY) / state.zoom;
                
                note.style.left = (origX + dx) + 'px';
                note.style.top = (origY + dy) + 'px';
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    note.style.cursor = 'grab';
                    saveStickyNote(note.id);
                    showMiniMap();
                }
            });
        }
        
        async function saveStickyNote(noteId) {
            const note = document.getElementById(noteId);
            if (!note) return;
            
            const title = note.querySelector('.sticky-note-title').value;
            const content = note.querySelector('.sticky-note-text').value;
            const x = parseInt(note.style.left) || 0;
            const y = parseInt(note.style.top) || 0;
            const color = STICKY_COLORS.find(c => note.classList.contains(c)) || 'yellow';
            
            await saveStickyNoteToSupabase(noteId, title, content, x, y, color);
        }
        
        async function saveStickyNoteToSupabase(noteId, title, content, x, y, color) {
            try {
                const { data, error } = await fetch(`${SUPABASE_URL}/rest/v1/sticky_notes?id=eq.${noteId}`, {
                    method: 'GET',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                }).then(r => r.json());
                
                const noteData = {
                    id: noteId,
                    title: title,
                    content: content,
                    position_x: x,
                    position_y: y,
                    color: color,
                    updated_at: new Date().toISOString()
                };
                
                // Upsert
                await fetch(`${SUPABASE_URL}/rest/v1/sticky_notes`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'resolution=merge-duplicates'
                    },
                    body: JSON.stringify(noteData)
                });
            } catch (error) {
                console.error('Error saving sticky note:', error);
            }
        }
        
        async function deleteStickyNote(noteId) {
            const note = document.getElementById(noteId);
            if (note) {
                note.remove();
                showMiniMap();
            }
            
            // Delete from Supabase
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/sticky_notes?id=eq.${noteId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                showToast('🗑️ Sticky note deleted');
            } catch (error) {
                console.error('Error deleting sticky note:', error);
            }
        }
        
        async function loadStickyNotes() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/sticky_notes?order=created_at.asc`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                const notes = await response.json();
                
                const content = document.getElementById('workspaceContent');
                
                notes.forEach(noteData => {
                    const note = document.createElement('div');
                    note.className = `sticky-note ${noteData.color || 'yellow'} visible`;
                    note.id = noteData.id;
                    note.style.left = noteData.position_x + 'px';
                    note.style.top = noteData.position_y + 'px';
                    note.innerHTML = `
                        <div class="sticky-note-header">
                            <input type="text" class="sticky-note-title" placeholder="Title..." value="${escapeHtml(noteData.title || '')}" onblur="saveStickyNote('${noteData.id}')" onkeydown="if(event.key==='Enter'){this.blur();}">
                            <button class="sticky-note-delete" onclick="deleteStickyNote('${noteData.id}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                        </div>
                        <div class="sticky-note-content">
                            <textarea class="sticky-note-text" placeholder="Write something..." onblur="saveStickyNote('${noteData.id}')">${escapeHtml(noteData.content || '')}</textarea>
                        </div>
                        <div class="sticky-note-footer">${new Date(noteData.created_at || Date.now()).toLocaleDateString()}</div>
                    `;
                    
                    content.appendChild(note);
                    makeStickyDraggable(note);
                });
                
                console.log(`Loaded ${notes.length} sticky notes`);
            } catch (error) {
                console.error('Error loading sticky notes:', error);
            }
        }
        
        // ═══════════════════════════════════════════════════════════════
        // VOICE NOTES - Recording with waveform UI and Supabase persistence
        // ═══════════════════════════════════════════════════════════════
        
        let activeVoiceNoteId = null;
        let voiceNoteRecording = null;
        let voiceNoteAudioContext = null;
        let voiceNoteAnalyser = null;
        let voiceNoteWaveformInterval = null;
        let voiceNoteTimerInterval = null;
        let voiceNoteAudioUrls = {}; // Store audio URLs by note ID
        
        async function addVoiceNote() {
            document.getElementById('contextMenu').classList.remove('active');
            
            const workspace = document.getElementById('workspace');
            const content = document.getElementById('workspaceContent');
            
            // Calculate position
            const noteX = (contextMenuPosition.x + workspace.scrollLeft) / state.zoom;
            const noteY = (contextMenuPosition.y + workspace.scrollTop) / state.zoom;
            
            // Generate unique ID
            const noteId = 'voice-' + Date.now();
            activeVoiceNoteId = noteId;
            
            // Create voice note card in recording mode
            const note = document.createElement('div');
            note.className = 'voice-note visible recording';
            note.id = noteId;
            note.style.left = noteX + 'px';
            note.style.top = noteY + 'px';
            note.innerHTML = `
                <button class="voice-note-delete" onclick="deleteVoiceNote('${noteId}')"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                <div class="voice-note-header">
                    <button class="voice-note-play" id="${noteId}-btn" onclick="event.stopPropagation(); toggleVoiceNoteRecording('${noteId}')">
                        <svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg>
                    </button>
                    <div class="voice-note-transcription-sphere">
                        <div class="sphere-fog-wrap">
                            <div class="sphere-fog-transcribe"></div>
                            <div class="sphere-fog-transcribe-2"></div>
                        </div>
                        <div class="sphere-highlight"></div>
                    </div>
                    <div class="voice-note-info">
                        <div class="voice-note-title">Recording...</div>
                        <div class="voice-note-duration" id="${noteId}-timer">0:00 • ${new Date().toLocaleDateString()}</div>
                    </div>
                </div>
                <div class="voice-note-summary">
                    <div class="voice-note-waveform" id="${noteId}-waveform"></div>
                </div>
            `;
            
            content.appendChild(note);
            makeVoiceNoteDraggable(note);
            showMiniMap();
            
            // Start recording
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                
                voiceNoteAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = voiceNoteAudioContext.createMediaStreamSource(stream);
                voiceNoteAnalyser = voiceNoteAudioContext.createAnalyser();
                voiceNoteAnalyser.fftSize = 256;
                voiceNoteAnalyser.smoothingTimeConstant = 0.4;
                source.connect(voiceNoteAnalyser);
                
                const mediaRecorder = new MediaRecorder(stream, { mimeType: 'audio/webm' });
                const audioChunks = [];
                
                mediaRecorder.ondataavailable = (event) => {
                    if (event.data.size > 0) {
                        audioChunks.push(event.data);
                    }
                };
                
                mediaRecorder.onstop = async () => {
                    const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
                    await processVoiceNoteRecording(noteId, audioBlob);
                };
                
                mediaRecorder.start();
                voiceNoteRecording = { stream, mediaRecorder, startTime: Date.now(), noteId };
                
                // Start waveform animation
                voiceNoteWaveformInterval = setInterval(() => updateVoiceNoteWaveform(noteId), 80);
                
                // Start timer
                voiceNoteTimerInterval = setInterval(() => updateVoiceNoteTimer(noteId), 100);
                
                showToast('🎤 Recording... Click stop to finish');
                
            } catch (error) {
                console.error('Microphone access denied:', error);
                note.remove();
                showToast('⚠️ Microphone access required for voice notes');
            }
        }
        
        function getVoiceNoteIntensity() {
            if (!voiceNoteAnalyser) return 0;
            
            const dataArray = new Uint8Array(voiceNoteAnalyser.frequencyBinCount);
            voiceNoteAnalyser.getByteFrequencyData(dataArray);
            
            let sum = 0;
            for (let i = 0; i < dataArray.length; i++) {
                sum += dataArray[i];
            }
            const average = sum / dataArray.length / 255;
            
            if (average < 0.08) return 0;
            return Math.min(1, (average - 0.08) / (1 - 0.08) * 2.0);
        }
        
        function updateVoiceNoteWaveform(noteId) {
            const waveform = document.getElementById(`${noteId}-waveform`);
            if (!waveform) return;
            
            const intensity = getVoiceNoteIntensity();
            const height = 3 + (intensity * 21);
            
            const bar = document.createElement('div');
            bar.className = 'wave-bar';
            bar.style.height = height + 'px';
            
            // Prepend to make waves flow right to left
            waveform.insertBefore(bar, waveform.firstChild);
            
            // Keep max 60 bars (fits in the width)
            while (waveform.children.length > 60) {
                waveform.removeChild(waveform.lastChild);
            }
        }
        
        function updateVoiceNoteTimer(noteId) {
            const timerEl = document.getElementById(`${noteId}-timer`);
            if (!voiceNoteRecording || !timerEl) return;
            
            const elapsed = (Date.now() - voiceNoteRecording.startTime) / 1000;
            const minutes = Math.floor(elapsed / 60);
            const seconds = Math.floor(elapsed % 60);
            timerEl.textContent = `${minutes}:${seconds.toString().padStart(2, '0')} • ${new Date().toLocaleDateString()}`;
        }
        
        function toggleVoiceNoteRecording(noteId) {
            if (voiceNoteRecording && voiceNoteRecording.noteId === noteId) {
                // Stop recording
                stopVoiceNoteRecording();
            }
        }
        
        function stopVoiceNoteRecording() {
            if (voiceNoteRecording) {
                const noteId = voiceNoteRecording.noteId;
                const note = document.getElementById(noteId);
                
                // Stop intervals
                if (voiceNoteWaveformInterval) clearInterval(voiceNoteWaveformInterval);
                if (voiceNoteTimerInterval) clearInterval(voiceNoteTimerInterval);
                
                // Update UI to transcribing state
                if (note) {
                    note.classList.remove('recording');
                    note.classList.add('transcribing');
                    note.querySelector('.voice-note-title').textContent = 'Transcribing...';
                }
                
                // Stop media recorder (triggers onstop which calls processVoiceNoteRecording)
                voiceNoteRecording.mediaRecorder.stop();
                voiceNoteRecording.stream.getTracks().forEach(track => track.stop());
                if (voiceNoteAudioContext) voiceNoteAudioContext.close();
                
                voiceNoteRecording = null;
                voiceNoteAudioContext = null;
                voiceNoteAnalyser = null;
            }
        }
        
        async function processVoiceNoteRecording(noteId, audioBlob) {
            const note = document.getElementById(noteId);
            if (!note) return;
            
            // Store audio URL
            const audioUrl = URL.createObjectURL(audioBlob);
            voiceNoteAudioUrls[noteId] = audioUrl;
            
            // Get duration
            const audio = new Audio(audioUrl);
            
            audio.addEventListener('loadedmetadata', async () => {
                const duration = Math.round(audio.duration);
                const minutes = Math.floor(duration / 60);
                const seconds = duration % 60;
                const durationStr = `${minutes}:${seconds.toString().padStart(2, '0')}`;
                
                // Transcribe with ElevenLabs
                let transcript = '';
                try {
                    const formData = new FormData();
                    formData.append('file', audioBlob, 'recording.webm');
                    formData.append('model_id', 'scribe_v1');
                    formData.append('language_code', 'eng');
                    
                    const response = await fetch('https://api.elevenlabs.io/v1/speech-to-text', {
                        method: 'POST',
                        headers: {
                            'xi-api-key': ELEVENLABS_API_KEY
                        },
                        body: formData
                    });
                    
                    if (response.ok) {
                        const result = await response.json();
                        transcript = result.text || 'No speech detected';
                    } else {
                        transcript = 'Transcription failed';
                    }
                } catch (error) {
                    console.error('Transcription error:', error);
                    transcript = 'Transcription error';
                }
                
                // Update note UI with final state
                note.classList.remove('transcribing');
                note.innerHTML = `
                    <div class="voice-note-actions">
                        <button class="voice-note-copy" onclick="copyVoiceNoteText('${noteId}')" title="Copy text"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                        <button class="voice-note-delete" onclick="deleteVoiceNote('${noteId}')" title="Delete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                    </div>
                    <div class="voice-note-header">
                        <button class="voice-note-play" onclick="event.stopPropagation(); playVoiceNote('${noteId}')">
                            <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                        </button>
                        <div class="voice-note-info">
                            <div class="voice-note-title">Voice Note</div>
                            <div class="voice-note-duration" id="${noteId}-duration">${durationStr} • ${new Date().toLocaleDateString()}</div>
                        </div>
                    </div>
                    <div class="voice-note-summary" id="${noteId}-text">${escapeHtml(transcript)}</div>
                    <div class="voice-note-progress" id="${noteId}-progress" onclick="seekVoiceNote(event, '${noteId}')">
                        <div class="voice-note-progress-bar" id="${noteId}-progress-bar"></div>
                        <div class="voice-note-progress-handle" id="${noteId}-progress-handle"></div>
                    </div>
                `;
                
                // Save to Supabase
                const saved = await saveVoiceNoteToSupabase(noteId, transcript, durationStr, 
                    parseInt(note.style.left), parseInt(note.style.top), audioBlob);
                
                if (saved) {
                    showToast('🎤 Voice note saved');
                }
            });
        }
        
        // Copy voice note transcription text to clipboard
        function copyVoiceNoteText(noteId) {
            const textEl = document.getElementById(noteId + '-text');
            if (!textEl) {
                showToast('❌ No text to copy');
                return;
            }
            
            const text = textEl.textContent;
            if (!text || text === 'No speech detected' || text === 'Transcription failed' || text === 'Transcription error') {
                showToast('❌ No text to copy');
                return;
            }
            
            navigator.clipboard.writeText(text).then(() => {
                showToast('📋 Text copied!');
            }).catch(err => {
                console.error('Copy failed:', err);
                showToast('❌ Copy failed');
            });
        }
        
        // Active audio players by note ID
        let activeAudioPlayers = {};
        
        function playVoiceNote(noteId) {
            const audioUrl = voiceNoteAudioUrls[noteId];
            if (!audioUrl) {
                showToast('❌ Audio not available');
                return;
            }
            
            const note = document.getElementById(noteId);
            const playBtn = note.querySelector('.voice-note-play');
            
            // If already playing, pause it
            if (activeAudioPlayers[noteId]) {
                const audio = activeAudioPlayers[noteId];
                if (audio.paused) {
                    audio.play();
                    note.classList.add('playing');
                    playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
                } else {
                    audio.pause();
                    note.classList.remove('playing');
                    playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
                }
                return;
            }
            
            // Create new audio player
            const audio = new Audio(audioUrl);
            activeAudioPlayers[noteId] = audio;
            
            // Update UI to playing state
            note.classList.add('playing');
            playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="4" width="4" height="16"/><rect x="14" y="4" width="4" height="16"/></svg>';
            
            // Progress bar elements
            const progressBar = document.getElementById(`${noteId}-progress-bar`);
            const progressHandle = document.getElementById(`${noteId}-progress-handle`);
            
            // Update progress during playback
            audio.addEventListener('timeupdate', () => {
                if (audio.duration) {
                    const percent = (audio.currentTime / audio.duration) * 100;
                    if (progressBar) progressBar.style.width = percent + '%';
                    if (progressHandle) progressHandle.style.left = percent + '%';
                }
            });
            
            // Handle playback end
            audio.addEventListener('ended', () => {
                note.classList.remove('playing');
                playBtn.innerHTML = '<svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>';
                if (progressBar) progressBar.style.width = '0%';
                if (progressHandle) progressHandle.style.left = '0%';
                delete activeAudioPlayers[noteId];
            });
            
            audio.play();
        }
        
        function seekVoiceNote(event, noteId) {
            const audio = activeAudioPlayers[noteId];
            if (!audio) return;
            
            const progressEl = event.currentTarget;
            const rect = progressEl.getBoundingClientRect();
            const percent = (event.clientX - rect.left) / rect.width;
            
            audio.currentTime = percent * audio.duration;
        }
        
        async function saveVoiceNoteToSupabase(noteId, transcript, duration, x, y, audioBlob) {
            try {
                // Convert blob to base64 for storage
                const base64Audio = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onloadend = () => resolve(reader.result);
                    reader.onerror = reject;
                    reader.readAsDataURL(audioBlob);
                });
                
                const noteData = {
                    id: noteId,
                    transcript: transcript,
                    duration: duration,
                    position_x: x,
                    position_y: y,
                    audio_data: base64Audio,
                    created_at: new Date().toISOString()
                };
                
                console.log('Saving voice note to Supabase:', noteId, 'Size:', Math.round(base64Audio.length / 1024) + 'KB');
                
                const response = await fetch(`${SUPABASE_URL}/rest/v1/voice_notes`, {
                    method: 'POST',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json',
                        'Prefer': 'resolution=merge-duplicates'
                    },
                    body: JSON.stringify(noteData)
                });
                
                if (!response.ok) {
                    const errorText = await response.text();
                    console.error('Supabase save error:', response.status, errorText);
                    showToast('⚠️ Failed to save voice note');
                    return false;
                }
                
                console.log('Voice note saved successfully:', noteId);
                return true;
            } catch (error) {
                console.error('Error saving voice note:', error);
                showToast('⚠️ Error saving voice note');
                return false;
            }
        }
        
        async function deleteVoiceNote(noteId) {
            const note = document.getElementById(noteId);
            if (note) {
                // If recording, stop it first
                if (voiceNoteRecording && voiceNoteRecording.noteId === noteId) {
                    stopVoiceNoteRecording();
                }
                note.remove();
                delete voiceNoteAudioUrls[noteId];
                showMiniMap();
            }
            
            // Delete from Supabase
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/voice_notes?id=eq.${noteId}`, {
                    method: 'DELETE',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                showToast('🗑️ Voice note deleted');
            } catch (error) {
                console.error('Error deleting voice note:', error);
            }
        }
        
        async function loadVoiceNotes() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/voice_notes?order=created_at.asc`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                
                if (!response.ok) {
                    console.error('Failed to load voice notes:', response.status);
                    return;
                }
                
                const notes = await response.json();
                console.log('Fetched voice notes from Supabase:', notes.length);
                
                if (!Array.isArray(notes) || notes.length === 0) {
                    console.log('No voice notes found in Supabase');
                    return;
                }
                
                const content = document.getElementById('workspaceContent');
                
                for (const noteData of notes) {
                    // Skip if already exists in DOM
                    if (document.getElementById(noteData.id)) {
                        console.log('Voice note already exists:', noteData.id);
                        continue;
                    }
                    
                    // Convert base64 back to blob and create URL
                    if (noteData.audio_data) {
                        try {
                            // Parse data URL
                            const [header, base64Data] = noteData.audio_data.split(',');
                            const mimeType = header.match(/:(.*?);/)?.[1] || 'audio/webm';
                            const binary = atob(base64Data);
                            const bytes = new Uint8Array(binary.length);
                            for (let i = 0; i < binary.length; i++) {
                                bytes[i] = binary.charCodeAt(i);
                            }
                            const blob = new Blob([bytes], { type: mimeType });
                            voiceNoteAudioUrls[noteData.id] = URL.createObjectURL(blob);
                            console.log('Audio loaded for:', noteData.id);
                        } catch (e) {
                            console.error('Error parsing audio data for:', noteData.id, e);
                        }
                    }
                    
                    const note = document.createElement('div');
                    note.className = 'voice-note visible';
                    note.id = noteData.id;
                    note.style.left = (noteData.position_x || 100) + 'px';
                    note.style.top = (noteData.position_y || 100) + 'px';
                    note.innerHTML = `
                        <div class="voice-note-actions">
                            <button class="voice-note-copy" onclick="copyVoiceNoteText('${noteData.id}')" title="Copy text"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></button>
                            <button class="voice-note-delete" onclick="deleteVoiceNote('${noteData.id}')" title="Delete"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
                        </div>
                        <div class="voice-note-header">
                            <button class="voice-note-play" onclick="event.stopPropagation(); playVoiceNote('${noteData.id}')">
                                <svg viewBox="0 0 24 24" fill="currentColor"><polygon points="5 3 19 12 5 21 5 3"/></svg>
                            </button>
                            <div class="voice-note-info">
                                <div class="voice-note-title">Voice Note</div>
                                <div class="voice-note-duration" id="${noteData.id}-duration">${noteData.duration || '0:00'} • ${new Date(noteData.created_at).toLocaleDateString()}</div>
                            </div>
                        </div>
                        <div class="voice-note-summary" id="${noteData.id}-text">${escapeHtml(noteData.transcript || '')}</div>
                        <div class="voice-note-progress" id="${noteData.id}-progress" onclick="seekVoiceNote(event, '${noteData.id}')">
                            <div class="voice-note-progress-bar" id="${noteData.id}-progress-bar"></div>
                            <div class="voice-note-progress-handle" id="${noteData.id}-progress-handle"></div>
                        </div>
                    `;
                    
                    content.appendChild(note);
                    makeVoiceNoteDraggable(note);
                }
                
                console.log(`Loaded ${notes.length} voice notes`);
            } catch (error) {
                console.error('Error loading voice notes:', error);
            }
        }
        
        function makeVoiceNoteDraggable(note) {
            let isDragging = false;
            let startX, startY, origX, origY;
            
            note.addEventListener('mousedown', (e) => {
                if (e.target.closest('.voice-note-play, .voice-note-delete')) return;
                
                isDragging = true;
                startX = e.clientX;
                startY = e.clientY;
                origX = parseInt(note.style.left) || 0;
                origY = parseInt(note.style.top) || 0;
                
                note.style.zIndex = ++state.highestZIndex;
                note.style.cursor = 'grabbing';
                
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                
                const dx = (e.clientX - startX) / state.zoom;
                const dy = (e.clientY - startY) / state.zoom;
                
                note.style.left = (origX + dx) + 'px';
                note.style.top = (origY + dy) + 'px';
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    note.style.cursor = 'grab';
                    showMiniMap();
                    // Update position in Supabase
                    updateVoiceNotePosition(note.id, parseInt(note.style.left), parseInt(note.style.top));
                }
            });
        }
        
        async function updateVoiceNotePosition(noteId, x, y) {
            try {
                await fetch(`${SUPABASE_URL}/rest/v1/voice_notes?id=eq.${noteId}`, {
                    method: 'PATCH',
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ position_x: x, position_y: y })
                });
            } catch (error) {
                console.error('Error updating voice note position:', error);
            }
        }

        // ============================================
        // BROWSER WIDGETS - Uses same structure as email widget
        // ============================================
        
        function initPasteHandler() {
            document.addEventListener('paste', async (e) => {
                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.isContentEditable) return;
                const pastedText = (e.clipboardData || window.clipboardData).getData('text').trim();
                if (isValidUrl(pastedText)) {
                    e.preventDefault();
                    createBrowserWidget(pastedText);
                }
            });
        }
        
        async function pasteUrlFromClipboard() {
            document.getElementById('contextMenu').classList.remove('active');
            try {
                const text = await navigator.clipboard.readText();
                if (isValidUrl(text.trim())) {
                    const workspace = document.getElementById('workspace');
                    const x = (contextMenuPosition.x + workspace.scrollLeft) / state.zoom;
                    const y = (contextMenuPosition.y + workspace.scrollTop) / state.zoom;
                    createBrowserWidget(text.trim(), null, x, y);
                } else {
                    showToast('Clipboard does not contain a valid URL');
                }
            } catch (error) {
                showToast('Unable to read clipboard. Try Ctrl+V instead.');
            }
        }
        
        function isValidUrl(string) {
            try {
                const url = new URL(string);
                return url.protocol === 'http:' || url.protocol === 'https:';
            } catch (_) {
                return false;
            }
        }
        
        // Store popup window references
        const browserPopups = {};
        
        function createBrowserWidget(url, savedData = null, customX = null, customY = null) {
            const widgetId = savedData?.id || 'browser-' + Date.now();
            const workspace = document.getElementById('workspace');
            const x = customX || savedData?.position_x || (workspace.scrollLeft + window.innerWidth / 2 - 175) / state.zoom;
            const y = customY || savedData?.position_y || (workspace.scrollTop + window.innerHeight / 2 - 100) / state.zoom;
            
            const urlObj = new URL(url);
            const faviconUrl = `https://www.google.com/s2/favicons?domain=${urlObj.hostname}&sz=32`;
            
            // Check if running in Electron
            const isElectron = window.electronAPI && window.electronAPI.isElectron;
            
            // Use saved size or default
            const savedWidth = savedData?.width || 450;
            const savedHeight = savedData?.height || 520;
            const isExpanded = savedWidth > 600;
            
            // Create widget (same for both Electron and HTML)
            const widget = document.createElement('div');
            widget.className = 'widget browser-widget-instance';
            widget.id = widgetId;
            widget.dataset.url = url;
            widget.dataset.isBrowser = 'true';
            widget.style.cssText = `left: ${x}px; top: ${y}px; width: ${savedWidth}px; height: ${savedHeight}px; display: ${state.isActive ? 'flex' : 'none'};`;
            if (isExpanded) widget.classList.add('expanded');
            
            widget.dataset.originalWidth = '450px';
            widget.dataset.originalHeight = '520px';
            widget.dataset.originalLeft = x + 'px';
            widget.dataset.originalTop = y + 'px';
            
            // Store popup reference
            let popupWindow = null;
            
            // Use webview for Electron, iframe for HTML
            const browserElement = isElectron 
                ? `<webview id="${widgetId}-browser" src="${url}" partition="persist:browser" allowpopups useragent="Mozilla/5.0 (Macintosh; Intel Mac OS X 10_15_7) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/120.0.0.0 Safari/537.36" style="width: 100%; height: 100%; border: none;"></webview>`
                : `<iframe id="${widgetId}-browser" src="${url}" style="width: 100%; height: 100%; border: none;" sandbox="allow-scripts allow-same-origin allow-forms allow-popups allow-popups-to-escape-sandbox" allow="microphone; camera; geolocation"></iframe>`;
            
            widget.innerHTML = `
                <div class="widget-body" style="padding: 0; display: flex; flex-direction: column; height: 100%;">
                    <div class="browser-drag-header" id="${widgetId}-header" style="display: flex; align-items: center; padding: 10px 12px; gap: 8px; background: rgba(0,0,0,0.35); border-bottom: 1px solid rgba(255,255,255,0.08); cursor: grab; user-select: none;">
                        <img id="${widgetId}-favicon" src="${faviconUrl}" style="width: 16px; height: 16px; border-radius: 3px; flex-shrink: 0;" onerror="this.style.display='none'">
                        <div id="${widgetId}-url-container" style="flex: 1; min-width: 0; position: relative;">
                            <span id="${widgetId}-title" style="display: block; font-size: 11px; color: var(--text-dim); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; cursor: text; padding: 2px 0;" title="Click to edit URL">${url}</span>
                            <input id="${widgetId}-url-input" type="text" value="${url}" style="display: none; position: absolute; inset: 0; font-size: 11px; color: var(--text); background: transparent; border: none; padding: 2px 0; outline: none; font-family: inherit;">
                        </div>
                        <button id="${widgetId}-back" class="browser-header-btn browser-nav-btn" title="Back" disabled>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="15 18 9 12 15 6"/></svg>
                        </button>
                        <button id="${widgetId}-forward" class="browser-header-btn browser-nav-btn" title="Forward" disabled>
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="9 18 15 12 9 6"/></svg>
                        </button>
                        <button id="${widgetId}-refresh" class="browser-header-btn" title="Refresh">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><polyline points="23 4 23 10 17 10"/><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/></svg>
                        </button>
                        <button id="${widgetId}-popup" class="browser-header-btn" title="Open as Side Popup">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="3" y="3" width="18" height="18" rx="2" ry="2"/><line x1="9" y1="3" x2="9" y2="21"/></svg>
                        </button>
                        <button id="${widgetId}-external" class="browser-header-btn" title="Open in Browser">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 13v6a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V8a2 2 0 0 1 2-2h6"/><polyline points="15 3 21 3 21 9"/><line x1="10" y1="14" x2="21" y2="3"/></svg>
                        </button>
                        <button id="${widgetId}-fullscreen" class="browser-header-btn" title="Fullscreen">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M15 3h6v6M9 21H3v-6M21 3l-7 7M3 21l7-7"/></svg>
                        </button>
                        <button id="${widgetId}-close" class="browser-header-btn browser-close-btn" title="Close">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg>
                        </button>
                    </div>
                    <div style="flex: 1; position: relative; background: #fff; border-radius: 0 0 20px 20px; overflow: hidden;">
                        <div id="${widgetId}-loading" style="position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; background: rgba(23,23,37,0.95); color: var(--text-dim); font-size: 12px; z-index: 1;">Loading...</div>
                        <div id="${widgetId}-blocked" style="position: absolute; inset: 0; display: none; flex-direction: column; align-items: center; justify-content: center; background: rgba(23,23,37,0.98); color: var(--text-dim); font-size: 13px; z-index: 2; text-align: center; padding: 20px;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" style="width: 48px; height: 48px; margin-bottom: 16px; opacity: 0.5;"><circle cx="12" cy="12" r="10"/><line x1="4.93" y1="4.93" x2="19.07" y2="19.07"/></svg>
                            <div style="font-weight: 500; margin-bottom: 8px;">Site cannot be embedded</div>
                            <div style="font-size: 11px; opacity: 0.7; max-width: 280px;">${urlObj.hostname} blocks embedding. Use the popup or external browser button.</div>
                        </div>
                        ${browserElement}
                    </div>
                </div>
            `;
            
            document.getElementById('workspaceContent').appendChild(widget);
            
            // Get elements
            const header = document.getElementById(widgetId + '-header');
            const fullscreenBtn = document.getElementById(widgetId + '-fullscreen');
            const closeBtn = document.getElementById(widgetId + '-close');
            const refreshBtn = document.getElementById(widgetId + '-refresh');
            const backBtn = document.getElementById(widgetId + '-back');
            const forwardBtn = document.getElementById(widgetId + '-forward');
            const externalBtn = document.getElementById(widgetId + '-external');
            const popupBtn = document.getElementById(widgetId + '-popup');
            const titleEl = document.getElementById(widgetId + '-title');
            const urlInput = document.getElementById(widgetId + '-url-input');
            const faviconEl = document.getElementById(widgetId + '-favicon');
            const loading = document.getElementById(widgetId + '-loading');
            const blocked = document.getElementById(widgetId + '-blocked');
            const browser = document.getElementById(widgetId + '-browser');
            
            let initialLoadDone = false;
            let currentUrl = url;
            
            // URL BAR - Click to edit
            titleEl.addEventListener('click', (e) => {
                e.stopPropagation();
                urlInput.value = currentUrl;
                titleEl.style.display = 'none';
                urlInput.style.display = 'block';
                urlInput.focus();
                urlInput.select();
            });
            
            // URL BAR - Enter to navigate, Escape to cancel
            urlInput.addEventListener('keydown', (e) => {
                e.stopPropagation();
                if (e.key === 'Enter') {
                    let newUrl = urlInput.value.trim();
                    if (newUrl && !newUrl.startsWith('http://') && !newUrl.startsWith('https://')) {
                        newUrl = 'https://' + newUrl;
                    }
                    if (newUrl) {
                        currentUrl = newUrl;
                        if (isElectron) {
                            browser.loadURL(newUrl);
                        } else {
                            browser.src = newUrl;
                        }
                        titleEl.textContent = newUrl;
                        loading.style.display = 'flex';
                        blocked.style.display = 'none';
                        try {
                            const newUrlObj = new URL(newUrl);
                            faviconEl.src = `https://www.google.com/s2/favicons?domain=${newUrlObj.hostname}&sz=32`;
                            faviconEl.style.display = 'block';
                        } catch (err) {}
                    }
                    urlInput.style.display = 'none';
                    titleEl.style.display = 'block';
                } else if (e.key === 'Escape') {
                    urlInput.style.display = 'none';
                    titleEl.style.display = 'block';
                }
            });
            
            urlInput.addEventListener('blur', () => {
                urlInput.style.display = 'none';
                titleEl.style.display = 'block';
            });
            
            urlInput.addEventListener('mousedown', (e) => e.stopPropagation());
            titleEl.addEventListener('mousedown', (e) => e.stopPropagation());
            
            // POPUP BUTTON
            popupBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (popupWindow && !popupWindow.closed) {
                    popupWindow.focus();
                    showToast('Popup focused');
                    return;
                }
                const popupWidth = 500;
                const popupHeight = window.innerHeight - 100;
                const popupLeft = window.screenX + window.innerWidth - popupWidth - 20;
                const popupTop = window.screenY + 50;
                popupWindow = window.open(currentUrl, widgetId + '-popup', `width=${popupWidth},height=${popupHeight},left=${popupLeft},top=${popupTop},menubar=no,toolbar=no,location=yes,status=no,resizable=yes,scrollbars=yes`);
                if (popupWindow) {
                    showToast('Opened as side popup');
                } else {
                    showToast('Popup blocked - check browser settings');
                }
            });
            
            // EXTERNAL BUTTON
            externalBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (isElectron && window.electronAPI && window.electronAPI.openInBrowser) {
                    window.electronAPI.openInBrowser(currentUrl);
                } else {
                    window.open(currentUrl, '_blank');
                }
            });
            
            // REFRESH BUTTON
            refreshBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                loading.style.display = 'flex';
                blocked.style.display = 'none';
                initialLoadDone = false;
                if (isElectron) {
                    browser.reload();
                } else {
                    browser.src = browser.src;
                }
            });
            
            // WEBVIEW events (Electron)
            if (isElectron) {
                browser.addEventListener('did-start-loading', () => {
                    if (!initialLoadDone) loading.style.display = 'flex';
                });
                
                browser.addEventListener('did-finish-load', () => {
                    loading.style.display = 'none';
                    initialLoadDone = true;
                    backBtn.disabled = !browser.canGoBack();
                    forwardBtn.disabled = !browser.canGoForward();
                });
                
                browser.addEventListener('did-stop-loading', () => {
                    loading.style.display = 'none';
                    initialLoadDone = true;
                });
                
                browser.addEventListener('dom-ready', () => {
                    loading.style.display = 'none';
                    initialLoadDone = true;
                });
                
                browser.addEventListener('page-title-updated', (e) => {
                    currentUrl = browser.getURL() || url;
                    titleEl.textContent = currentUrl;
                    try {
                        const u = new URL(currentUrl);
                        faviconEl.src = `https://www.google.com/s2/favicons?domain=${u.hostname}&sz=32`;
                    } catch (err) {}
                    loading.style.display = 'none';
                });
                
                browser.addEventListener('did-navigate', () => {
                    loading.style.display = 'none';
                    currentUrl = browser.getURL() || url;
                    titleEl.textContent = currentUrl;
                    backBtn.disabled = !browser.canGoBack();
                    forwardBtn.disabled = !browser.canGoForward();
                });
                
                browser.addEventListener('did-navigate-in-page', () => {
                    backBtn.disabled = !browser.canGoBack();
                    forwardBtn.disabled = !browser.canGoForward();
                });
                
                backBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (browser.canGoBack()) browser.goBack();
                });
                
                forwardBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    if (browser.canGoForward()) browser.goForward();
                });
            } else {
                // IFRAME events (HTML)
                browser.addEventListener('load', () => {
                    loading.style.display = 'none';
                    initialLoadDone = true;
                });
                
                // Hide back/forward for iframe (not supported)
                backBtn.style.display = 'none';
                forwardBtn.style.display = 'none';
                
                // Just hide loading after timeout - let iframe try to load
                setTimeout(() => {
                    loading.style.display = 'none';
                    initialLoadDone = true;
                }, 2000);
            }
            
            // Fallback hide loading
            setTimeout(() => { loading.style.display = 'none'; initialLoadDone = true; }, 2000);
            
            // DRAG
            let isDragging = false;
            let dragStartX, dragStartY, widgetStartX, widgetStartY;
            
            header.addEventListener('mousedown', (e) => {
                if (e.target.closest('button')) return;
                if (widget.classList.contains('fullscreen')) return;
                isDragging = true;
                dragStartX = e.clientX;
                dragStartY = e.clientY;
                widgetStartX = widget.offsetLeft;
                widgetStartY = widget.offsetTop;
                header.style.cursor = 'grabbing';
                bringToFront(widgetId);
                e.preventDefault();
            });
            
            document.addEventListener('mousemove', (e) => {
                if (!isDragging) return;
                const dx = (e.clientX - dragStartX) / state.zoom;
                const dy = (e.clientY - dragStartY) / state.zoom;
                widget.style.left = (widgetStartX + dx) + 'px';
                widget.style.top = (widgetStartY + dy) + 'px';
                expandWorkspaceIfNeeded(widgetStartX + dx, widgetStartY + dy, widget.offsetWidth, widget.offsetHeight);
            });
            
            document.addEventListener('mouseup', () => {
                if (isDragging) {
                    isDragging = false;
                    header.style.cursor = 'grab';
                    updateBrowserWidgetPos(widgetId, widget.offsetLeft, widget.offsetTop);
                }
            });
            
            // DOUBLE-CLICK to expand/collapse
            header.addEventListener('dblclick', (e) => {
                if (e.target.closest('button')) return;
                e.stopPropagation();
                if (widget.classList.contains('fullscreen')) return;
                if (widget.classList.contains('expanded')) {
                    widget.classList.remove('expanded');
                    widget.style.width = '450px';
                    widget.style.height = '520px';
                    updateBrowserWidgetSize(widgetId, 450, 520);
                } else {
                    widget.classList.add('expanded');
                    widget.style.width = '1200px';
                    widget.style.height = '850px';
                    updateBrowserWidgetSize(widgetId, 1200, 850);
                }
                bringToFront(widgetId);
            });
            
            // FULLSCREEN
            fullscreenBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                const controls = document.getElementById('workspaceControls');
                const workspaceContent = document.getElementById('workspaceContent');
                
                if (widget.classList.contains('fullscreen')) {
                    workspaceContent.appendChild(widget);
                    widget.classList.remove('fullscreen');
                    controls.style.display = 'flex';
                    widget.style.position = 'absolute';
                    widget.style.transform = '';
                    widget.style.left = widget.dataset.preFullscreenLeft;
                    widget.style.top = widget.dataset.preFullscreenTop;
                    widget.style.width = widget.dataset.preFullscreenWidth;
                    widget.style.height = widget.dataset.preFullscreenHeight;
                    if (widget.dataset.preFullscreenExpanded === 'true') widget.classList.add('expanded');
                } else {
                    widget.dataset.preFullscreenLeft = widget.style.left;
                    widget.dataset.preFullscreenTop = widget.style.top;
                    widget.dataset.preFullscreenWidth = widget.style.width;
                    widget.dataset.preFullscreenHeight = widget.style.height;
                    widget.dataset.preFullscreenExpanded = widget.classList.contains('expanded') ? 'true' : 'false';
                    document.body.appendChild(widget);
                    widget.classList.remove('expanded');
                    widget.classList.add('fullscreen');
                    widget.style.transform = 'none';
                    controls.style.display = 'none';
                }
                bringToFront(widgetId);
            });
            
            // CLOSE
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                if (popupWindow && !popupWindow.closed) popupWindow.close();
                if (widget.classList.contains('fullscreen')) {
                    document.getElementById('workspaceControls').style.display = 'flex';
                }
                widget.remove();
                browserWidgets = browserWidgets.filter(w => w.id !== widgetId);
                fetch(`${SUPABASE_URL}/rest/v1/browser_widgets?id=eq.${widgetId}`, {
                    method: 'DELETE',
                    headers: { 'apikey': SUPABASE_ANON_KEY, 'Authorization': `Bearer ${SUPABASE_ANON_KEY}` }
                });
                showToast('Browser closed');
            });
            
            widget.addEventListener('mousedown', () => bringToFront(widgetId));
            
            browserWidgets.push({ id: widgetId, url: url, position_x: x, position_y: y });
            
            if (!savedData) {
                saveBrowserWidgetToDB(widgetId, url, x, y, savedWidth, savedHeight);
                showToast('Browser created');
            }
            
            bringToFront(widgetId);
            expandWorkspaceIfNeeded(x, y, savedWidth, savedHeight);
        }
        
        // Electron-specific browser widget (with webview)
        
        function saveBrowserWidgetToDB(widgetId, url, x, y, width = 450, height = 520) {
            fetch(`${SUPABASE_URL}/rest/v1/browser_widgets`, {
                method: 'POST',
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json',
                    'Prefer': 'return=minimal'
                },
                body: JSON.stringify({ id: widgetId, url: url, position_x: x, position_y: y, width: width, height: height })
            }).catch(err => console.error('Save error:', err));
        }
        
        async function loadBrowserWidgets() {
            try {
                const response = await fetch(`${SUPABASE_URL}/rest/v1/browser_widgets?select=*`, {
                    headers: {
                        'apikey': SUPABASE_ANON_KEY,
                        'Authorization': `Bearer ${SUPABASE_ANON_KEY}`
                    }
                });
                if (response.ok) {
                    const widgets = await response.json();
                    console.log('Loaded browser widgets:', widgets.length);
                    widgets.forEach(w => createBrowserWidget(w.url, w));
                }
            } catch (error) {
                // Silently ignore - table might not exist
            }
        }
        
        function updateBrowserWidgetPos(widgetId, x, y) {
            fetch(`${SUPABASE_URL}/rest/v1/browser_widgets?id=eq.${widgetId}`, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ position_x: x, position_y: y })
            }).catch(err => console.error('Position update error:', err));
        }
        
        function updateBrowserWidgetSize(widgetId, width, height) {
            fetch(`${SUPABASE_URL}/rest/v1/browser_widgets?id=eq.${widgetId}`, {
                method: 'PATCH',
                headers: {
                    'apikey': SUPABASE_ANON_KEY,
                    'Authorization': `Bearer ${SUPABASE_ANON_KEY}`,
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ width: width, height: height })
            }).catch(err => console.error('Size update error:', err));
        }

        // ESC key to exit fullscreen
        document.addEventListener('keydown', e => {
            if (e.key === 'Escape') {
                // Close attachment preview if open
                const attachmentModal = document.getElementById('attachmentPreviewModal');
                if (attachmentModal && attachmentModal.classList.contains('active')) {
                    closeAttachmentPreview();
                    return;
                }
                // Close AI draft modal if open
                const aiDraftModal = document.getElementById('aiDraftModal');
                if (aiDraftModal && aiDraftModal.classList.contains('active')) {
                    closeAiDraftModal();
                    return;
                }
                
                // Handle browser widgets specially (they have custom fullscreen)
                const fullscreenBrowser = document.querySelector('.browser-widget-instance.fullscreen');
                if (fullscreenBrowser) {
                    const controls = document.getElementById('workspaceControls');
                    const workspaceContent = document.getElementById('workspaceContent');
                    workspaceContent.appendChild(fullscreenBrowser);
                    fullscreenBrowser.classList.remove('fullscreen');
                    controls.style.display = 'flex';
                    fullscreenBrowser.style.position = 'absolute';
                    fullscreenBrowser.style.transform = '';
                    
                    // Restore to state before fullscreen
                    fullscreenBrowser.style.left = fullscreenBrowser.dataset.preFullscreenLeft;
                    fullscreenBrowser.style.top = fullscreenBrowser.dataset.preFullscreenTop;
                    fullscreenBrowser.style.width = fullscreenBrowser.dataset.preFullscreenWidth;
                    fullscreenBrowser.style.height = fullscreenBrowser.dataset.preFullscreenHeight;
                    if (fullscreenBrowser.dataset.preFullscreenExpanded === 'true') {
                        fullscreenBrowser.classList.add('expanded');
                    }
                    return;
                }
                
                // Handle expanded browser widgets - collapse IN PLACE
                const expandedBrowser = document.querySelector('.browser-widget-instance.expanded');
                if (expandedBrowser) {
                    expandedBrowser.classList.remove('expanded');
                    // Collapse at current position, just shrink
                    expandedBrowser.style.width = '450px';
                    expandedBrowser.style.height = '520px';
                    // Don't change position - stay where it is
                    return;
                }
                
                // Handle expanded regular widgets - collapse IN PLACE
                const expandedWidget = document.querySelector('.widget.expanded:not(.browser-widget-instance)');
                if (expandedWidget) {
                    expandedWidget.classList.remove('expanded');
                    // Get default size for this widget type
                    const defaultSize = widgetSizes[expandedWidget.id] || { width: 450, height: 520 };
                    expandedWidget.style.width = defaultSize.width + 'px';
                    expandedWidget.style.height = defaultSize.height + 'px';
                    // Don't change position - stay where it is
                    return;
                }
                
                // Close fullscreen regular widgets
                document.querySelectorAll('.widget.fullscreen:not(.browser-widget-instance)').forEach(widget => {
                    toggleFullscreen({ stopPropagation: () => {} }, widget.id);
                });
            }
        });
        
        // ==================== STT QUICK TEXT FEATURE ====================
        // Chat Input Style - Same as chat widget mic/waveform
        
        (function initSTTQuickText() {
            // Create STT Controls (like workspace-controls)
            const sttControls = document.createElement('div');
            sttControls.className = 'stt-controls';
            sttControls.id = 'sttControls';
            sttControls.innerHTML = `
                <div class="stt-trigger" id="sttTrigger">
                    <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                        <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/>
                        <path d="M19 10v2a7 7 0 0 1-14 0v-2"/>
                        <line x1="12" y1="19" x2="12" y2="23"/>
                        <line x1="8" y1="23" x2="16" y2="23"/>
                    </svg>
                </div>
                <div class="stt-panel">
                    <div class="stt-panel-header">
                        <span class="stt-panel-title">Quick Speech-to-Text</span>
                        <button class="stt-panel-close" id="sttClose">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                <line x1="18" y1="6" x2="6" y2="18"/>
                                <line x1="6" y1="6" x2="18" y2="18"/>
                            </svg>
                        </button>
                    </div>
                    <div class="stt-input-area">
                        <div class="stt-input-row" id="sttInputRow">
                            <div class="stt-input-wrap">
                                <textarea class="stt-textarea" id="sttTextarea" placeholder="Tap mic to record..." rows="1" oninput="handleSttInput()"></textarea>
                                <div class="stt-waveform" id="sttWaveform">
                                    <div class="stt-wave-bars" id="sttWaveBars"></div>
                                    <div class="stt-timer" id="sttTimer">0:00</div>
                                </div>
                            </div>
                            <button class="stt-action-btn" id="sttActionBtn">
                                <div class="stt-icon-wrap">
                                    <span class="stt-btn-icon stt-mic-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z"/><path d="M19 10v2a7 7 0 0 1-14 0v-2"/><line x1="12" y1="19" x2="12" y2="23"/><line x1="8" y1="23" x2="16" y2="23"/></svg></span>
                                    <span class="stt-btn-icon stt-stop-icon"><svg viewBox="0 0 24 24" fill="currentColor"><rect x="6" y="6" width="12" height="12" rx="2"/></svg></span>
                                    <span class="stt-btn-icon stt-copy-icon"><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="9" y="9" width="13" height="13" rx="2" ry="2"/><path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1"/></svg></span>
                                </div>
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(sttControls);
            
            // State
            let sttRecording = false;
            let sttMediaRecorder = null;
            let sttAudioChunks = [];
            let sttStream = null;
            let sttAudioContext = null;
            let sttAnalyser = null;
            let sttWaveformInterval = null;
            let sttTimerInterval = null;
            let sttRecordingStart = 0;
            
            const STT_WEBHOOK_URL = 'https://n8n.mafatih.network/webhook/transcribe-audio';
            
            // Elements
            const trigger = document.getElementById('sttTrigger');
            const closeBtn = document.getElementById('sttClose');
            const inputRow = document.getElementById('sttInputRow');
            const textarea = document.getElementById('sttTextarea');
            const actionBtn = document.getElementById('sttActionBtn');
            const waveBars = document.getElementById('sttWaveBars');
            const timer = document.getElementById('sttTimer');
            
            // Click trigger to expand
            trigger.addEventListener('click', () => {
                sttControls.classList.add('expanded');
            });
            
            // Close panel
            closeBtn.addEventListener('click', (e) => {
                e.stopPropagation();
                sttControls.classList.remove('expanded');
                if (sttRecording) stopSttRecording();
            });
            
            // Click outside to close
            document.addEventListener('click', (e) => {
                if (sttControls.classList.contains('expanded') && !sttControls.contains(e.target)) {
                    sttControls.classList.remove('expanded');
                    if (sttRecording) stopSttRecording();
                }
            });
            
            // Handle textarea input - show copy button when has text
            window.handleSttInput = function() {
                if (textarea.value.trim()) {
                    actionBtn.classList.add('has-text');
                    actionBtn.classList.remove('recording');
                } else {
                    actionBtn.classList.remove('has-text');
                }
            };
            
            // Action button click
            actionBtn.addEventListener('click', async (e) => {
                e.stopPropagation();
                
                // If has text, copy it
                if (actionBtn.classList.contains('has-text')) {
                    navigator.clipboard.writeText(textarea.value).then(() => {
                        // Flash green confirmation
                        actionBtn.style.background = 'linear-gradient(135deg, #10B981, #059669)';
                        setTimeout(() => {
                            actionBtn.style.background = '';
                        }, 500);
                    });
                    return;
                }
                
                // Toggle recording
                if (sttRecording) {
                    stopSttRecording();
                } else {
                    startSttRecording();
                }
            });
            
            async function startSttRecording() {
                try {
                    sttStream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    
                    // Audio context for waveform
                    sttAudioContext = new (window.AudioContext || window.webkitAudioContext)();
                    sttAnalyser = sttAudioContext.createAnalyser();
                    const source = sttAudioContext.createMediaStreamSource(sttStream);
                    source.connect(sttAnalyser);
                    sttAnalyser.fftSize = 256;
                    
                    // Media recorder
                    sttMediaRecorder = new MediaRecorder(sttStream, { mimeType: 'audio/webm' });
                    sttAudioChunks = [];
                    
                    sttMediaRecorder.ondataavailable = (e) => {
                        if (e.data.size > 0) sttAudioChunks.push(e.data);
                    };
                    
                    sttMediaRecorder.onstop = async () => {
                        const audioBlob = new Blob(sttAudioChunks, { type: 'audio/webm' });
                        await transcribeSttAudio(audioBlob);
                    };
                    
                    sttMediaRecorder.start(100);
                    sttRecording = true;
                    sttRecordingStart = Date.now();
                    
                    // UI updates
                    inputRow.classList.add('recording');
                    actionBtn.classList.add('recording');
                    actionBtn.classList.remove('has-text');
                    waveBars.innerHTML = '';
                    
                    // Start waveform animation
                    sttWaveformInterval = setInterval(updateSttWaveform, 80);
                    
                    // Start timer
                    sttTimerInterval = setInterval(() => {
                        const elapsed = Math.floor((Date.now() - sttRecordingStart) / 1000);
                        const mins = Math.floor(elapsed / 60);
                        const secs = elapsed % 60;
                        timer.textContent = `${mins}:${secs.toString().padStart(2, '0')}`;
                    }, 1000);
                    
                } catch (err) {
                    console.error('STT mic error:', err);
                }
            }
            
            function updateSttWaveform() {
                if (!sttAnalyser) return;
                
                const dataArray = new Uint8Array(sttAnalyser.frequencyBinCount);
                sttAnalyser.getByteFrequencyData(dataArray);
                
                // Get average volume
                const avg = dataArray.reduce((a, b) => a + b, 0) / dataArray.length;
                const height = Math.max(4, Math.min(28, (avg / 255) * 32));
                
                // Add new bar
                const bar = document.createElement('div');
                bar.className = 'stt-wave-bar';
                bar.style.height = height + 'px';
                waveBars.appendChild(bar);
                
                // Keep max 60 bars
                while (waveBars.children.length > 60) {
                    waveBars.removeChild(waveBars.firstChild);
                }
            }
            
            function stopSttRecording() {
                if (sttMediaRecorder && sttMediaRecorder.state !== 'inactive') {
                    sttMediaRecorder.stop();
                }
                
                if (sttStream) {
                    sttStream.getTracks().forEach(t => t.stop());
                    sttStream = null;
                }
                
                if (sttAudioContext) {
                    sttAudioContext.close();
                    sttAudioContext = null;
                    sttAnalyser = null;
                }
                
                if (sttWaveformInterval) {
                    clearInterval(sttWaveformInterval);
                    sttWaveformInterval = null;
                }
                
                if (sttTimerInterval) {
                    clearInterval(sttTimerInterval);
                    sttTimerInterval = null;
                }
                
                sttRecording = false;
                inputRow.classList.remove('recording');
                actionBtn.classList.remove('recording');
                timer.textContent = '0:00';
            }
            
            async function transcribeSttAudio(audioBlob) {
                // Show processing state
                textarea.placeholder = 'Processing...';
                
                try {
                    const formData = new FormData();
                    formData.append('audio', audioBlob, 'stt-recording.webm');
                    formData.append('language_code', 'auto');
                    
                    const response = await fetch(STT_WEBHOOK_URL, {
                        method: 'POST',
                        body: formData
                    });
                    
                    if (!response.ok) throw new Error('Transcription failed');
                    
                    const result = await response.json();
                    const transcript = result.transcript || result.text || '';
                    
                    if (transcript) {
                        if (textarea.value) {
                            textarea.value += ' ' + transcript;
                        } else {
                            textarea.value = transcript;
                        }
                        actionBtn.classList.add('has-text');
                    }
                    
                    textarea.placeholder = 'Tap mic to record...';
                } catch (err) {
                    console.error('STT transcription error:', err);
                    textarea.placeholder = 'Error. Tap mic to retry...';
                    setTimeout(() => {
                        textarea.placeholder = 'Tap mic to record...';
                    }, 2000);
                }
            }
        })();
    </script>
</body>
</html>
